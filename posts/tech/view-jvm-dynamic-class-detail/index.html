<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>如何查看jvm运行时生成的动态代理class文件 | 站在海边看远方</title>
<meta name=keywords content="java"><meta name=description content="前言
最近看dubbo的时候，看到了讲spi的部分，其中提到了@Adaptive注解生成了代理类


我后面去debug了一下，打了断点，发现在运行时，只是显示了class的名称，由于RegistryFactory$Adaptive 是动态生成的，所以没有class文件结构可以看，而文章里贴了class文件。"><meta name=author content="since"><link rel=canonical href=https://blog.thend03.com/posts/tech/view-jvm-dynamic-class-detail/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://blog.thend03.com/img/logo.jpg><link rel=icon type=image/png sizes=16x16 href=https://blog.thend03.com/img/logo.jpg><link rel=icon type=image/png sizes=32x32 href=https://blog.thend03.com/img/logo.jpg><link rel=apple-touch-icon href=https://blog.thend03.com/img/logo.jpg><link rel=mask-icon href=https://blog.thend03.com/img/logo.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.thend03.com/posts/tech/view-jvm-dynamic-class-detail/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="如何查看jvm运行时生成的动态代理class文件"><meta property="og:description" content="前言
最近看dubbo的时候，看到了讲spi的部分，其中提到了@Adaptive注解生成了代理类


我后面去debug了一下，打了断点，发现在运行时，只是显示了class的名称，由于RegistryFactory$Adaptive 是动态生成的，所以没有class文件结构可以看，而文章里贴了class文件。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.thend03.com/posts/tech/view-jvm-dynamic-class-detail/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-11T15:40:13+08:00"><meta property="article:modified_time" content="2024-09-11T15:40:13+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="如何查看jvm运行时生成的动态代理class文件"><meta name=twitter:description content="前言
最近看dubbo的时候，看到了讲spi的部分，其中提到了@Adaptive注解生成了代理类


我后面去debug了一下，打了断点，发现在运行时，只是显示了class的名称，由于RegistryFactory$Adaptive 是动态生成的，所以没有class文件结构可以看，而文章里贴了class文件。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚文章","item":"https://blog.thend03.com/posts/"},{"@type":"ListItem","position":2,"name":"👨🏻‍💻 技术","item":"https://blog.thend03.com/posts/tech/"},{"@type":"ListItem","position":3,"name":"如何查看jvm运行时生成的动态代理class文件","item":"https://blog.thend03.com/posts/tech/view-jvm-dynamic-class-detail/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"如何查看jvm运行时生成的动态代理class文件","name":"如何查看jvm运行时生成的动态代理class文件","description":"前言 最近看dubbo的时候，看到了讲spi的部分，其中提到了@Adaptive注解生成了代理类\n我后面去debug了一下，打了断点，发现在运行时，只是显示了class的名称，由于RegistryFactory$Adaptive 是动态生成的，所以没有class文件结构可以看，而文章里贴了class文件。\n","keywords":["java"],"articleBody":"前言 最近看dubbo的时候，看到了讲spi的部分，其中提到了@Adaptive注解生成了代理类\n我后面去debug了一下，打了断点，发现在运行时，只是显示了class的名称，由于RegistryFactory$Adaptive 是动态生成的，所以没有class文件结构可以看，而文章里贴了class文件。\n所以比较好奇，如何拿到class文件。\n经过一番搜索验证之后，有了如下的文章\nJava生成代理类的方式 首先呢, java生成代理类有如下几种方式。\n在了解了动态代理的生成方式之后，可以分情况讨论如何拿到代理类的class文件\nJDK动态代理 这个是java自身支持的代理方式，自带的，无需引入额外组件，但是只能代理接口。\n因为生成的代理类需要继承Proxy类，java是单继承的，所以只能代理接口。\nCGLIB动态代理 cglib可以为class创建代理类，类不必是接口，采用的是继承委托类的方式，因此不能代理final类，只能代理所有非final的public/protected类型的方法定义。\ncglib是采用的asm字节码拼接技术，继承一个类，子类对方法进行拦截，织入横切逻辑。\nJavassist 使用javassist可以直接操纵字节码，生成代理类。\ndubbo的代理类就是使用javassist拼接出来的\nASM asm相比javassist，更加的细粒度，且实现更加的复杂。\nDubbo相关代理类的class文件 具体到dubbo的话，@Adaptive会生成相关的代理类，Dubbo的代理类是用javaasist生成的。\n再延伸到调用过程，consumer调provider，生成的代理类是jdk动态代理\nprovider端调用过程中，会有一个warpper代理类，生成的代理类是使用javassist生成的，然后通过Warpper0.invokeMethod()根据具体的调用信息调用到具体的实现类。\n本次使用的dubbo版本是3.2.0\n去年写了一篇关于 dubbo spi的文章，感兴趣的可以看一下，介绍了spi的相关实现方式，以及如何使用\n具体到Adaptive代理类，使用如下的测试代码(完整的过程可以参考上面的文章地址)\npublic class DubboSpi { public static void main(String[] args) { ExtensionLoader\u003cSimpleExt\u003e extensionLoader = ExtensionLoader.getExtensionLoader(SimpleExt.class); // SimpleExt defaultExtension = extensionLoader.getDefaultExtension(); // SimpleExt dog = extensionLoader.getExtension(\"dog\"); // SimpleExt dog2 = extensionLoader.getExtension(\"dog\", true); // SimpleExt cat = extensionLoader.getExtension(\"cat\"); // dog.yell(null, \"dogdog\"); // SimpleExt dog1 = extensionLoader.getExtension(\"dog\"); // dog1.yell(null, \"dog1\"); SimpleExt adaptiveExtension = extensionLoader.getAdaptiveExtension(); URLAddress urlAddress = new URLAddress(\"127.0.0.1\", 20880); URLParam parse = URLParam.parse(new HashMap\u003c\u003e()); adaptiveExtension.echo(new URL(urlAddress, parse), \"dogs\"); adaptiveExtension.bang(new URL(urlAddress, parse),0); } } 定位到如下生成代理类的方法,代码在org.apache.dubbo.common.extension.ExtensionLoader#createAdaptiveExtensionClass\nprivate Class\u003c?\u003e createAdaptiveExtensionClass() { // Adaptive Classes' ClassLoader should be the same with Real SPI interface classes' ClassLoader ClassLoader classLoader = type.getClassLoader(); try { if (NativeUtils.isNative()) { return classLoader.loadClass(type.getName() + \"$Adaptive\"); } } catch (Throwable ignore) { } //这里生成class文件 String code = new AdaptiveClassCodeGenerator(type, cachedDefaultName).generate(); org.apache.dubbo.common.compiler.Compiler compiler = extensionDirector.getExtensionLoader( org.apache.dubbo.common.compiler.Compiler.class).getAdaptiveExtension(); return compiler.compile(type, code, classLoader); } 我们debug看一下生成的code, 看类名，是SimpleExt$Adaptive, 通过手动拼接的方式，生成了adaptive代理类。\n调用AdaptiveCompiler，最终compileer的类型为JavassistCompiler，即通过javassist生成的adaptive代理类\n那么回归到我一开始的问题，如何查看动态生成的class的内容，在String code = new AdaptiveClassCodeGenerator(type, cachedDefaultName).generate();这一行通过debug就可以拿到具体的class内容了\n生成的代理类如下所示, 对接口的方法进行了拦截\npackage com.fc.rpc.dubbo; import org.apache.dubbo.rpc.model.ScopeModel; import org.apache.dubbo.rpc.model.ScopeModelUtil; public class SimpleExt$Adaptive implements com.fc.rpc.dubbo.SimpleExt { public java.lang.String yell(org.apache.dubbo.common.URL arg0, java.lang.String arg1) { if (arg0 == null) throw new IllegalArgumentException(\"url == null\"); org.apache.dubbo.common.URL url = arg0; String extName = url.getParameter(\"key1\", url.getParameter(\"key2\", \"dog\")); if (extName == null) throw new IllegalStateException(\"Failed to get extension (com.fc.rpc.dubbo.SimpleExt) name from url (\" + url.toString() + \") use keys([key1, key2])\"); ScopeModel scopeModel = ScopeModelUtil.getOrDefault(url.getScopeModel(), com.fc.rpc.dubbo.SimpleExt.class); com.fc.rpc.dubbo.SimpleExt extension = (com.fc.rpc.dubbo.SimpleExt) scopeModel.getExtensionLoader(com.fc.rpc.dubbo.SimpleExt.class).getExtension(extName); return extension.yell(arg0, arg1); } public java.lang.String echo(org.apache.dubbo.common.URL arg0, java.lang.String arg1) { if (arg0 == null) throw new IllegalArgumentException(\"url == null\"); org.apache.dubbo.common.URL url = arg0; String extName = url.getParameter(\"simple.ext\", \"dog\"); if (extName == null) throw new IllegalStateException(\"Failed to get extension (com.fc.rpc.dubbo.SimpleExt) name from url (\" + url.toString() + \") use keys([simple.ext])\"); ScopeModel scopeModel = ScopeModelUtil.getOrDefault(url.getScopeModel(), com.fc.rpc.dubbo.SimpleExt.class); com.fc.rpc.dubbo.SimpleExt extension = (com.fc.rpc.dubbo.SimpleExt) scopeModel.getExtensionLoader(com.fc.rpc.dubbo.SimpleExt.class).getExtension(extName); return extension.echo(arg0, arg1); } public java.lang.String bang(org.apache.dubbo.common.URL arg0, int arg1) { throw new UnsupportedOperationException(\"The method public abstract java.lang.String com.fc.rpc.dubbo.SimpleExt.bang(org.apache.dubbo.common.URL,int) of interface com.fc.rpc.dubbo.SimpleExt is not adaptive method!\"); } } 另外debug级别的话，生成的class会输出到日志\nJDK动态代理的class文件 回归到jdk的动态代理，如何查看jdk动态代理生成的class文件\n这里主要讲一下如何查看动态代理的class文件，动态代理的原理啥的不深入。\n设置参数 在调用之前，添加System.getProperties().put(\"sun.misc.ProxyGenerator.saveGeneratedFiles\",\"true\");\n这个只适用于jdk动态代理\n准备一下测试类\n这是调用入口\npublic class DynamicProxyMain { public static void main(String[] args) { //动态代理时生成class文件 System.getProperties().put(\"sun.misc.ProxyGenerator.saveGeneratedFiles\",\"true\"); DynamicProxy dynamicProxy = new DynamicProxy(new HumenImpl()); Humen humenProxy = dynamicProxy.getProxy(); humenProxy.eat(\"rice\"); } } DynamicProxy实现了InvocationHandler，用于生成代理类\nimport java.lang.reflect.InvocationHandler; import java.lang.reflect.Method; import java.lang.reflect.Proxy; public class DynamicProxy implements InvocationHandler { private Object target; public DynamicProxy(Object target) { this.target = target; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { this.before(); Object result = method.invoke(target, args); this.after(); return result; } private void before() { System.out.println(\"吃东西之前先热身\"); } private void after() { System.out.println(\"吃完饭休息一下\"); } public \u003cT\u003e T getProxy() { return (T) Proxy.newProxyInstance(target.getClass().getClassLoader(),target.getClass().getInterfaces(),this); } } 测试用的接口\n/** * 人类迷惑行为大赏 **/ public interface Humen { /** * 吃东西 * * @param food 食物 */ void eat(String food); } 测试接口的实现类\n/** * 人类迷惑行为大赏具体案例 **/ public class HumenImpl implements Humen { @Override public void eat(String food) { System.out.println(\"人类开始行为艺术表演：吃食物 \"+food); } } 那么主要看一下这个配置System.getProperties().put(\"sun.misc.ProxyGenerator.saveGeneratedFiles\",\"true\");这个配置是用于保存生成的class的。\n缺点是这个参数只适用于jdk动态代理\n加上这个参数运行一下，会发现代理类保存到了项目路径(classpath)下\n看一下$Proxy0的详细内容, 代理类继承了Proxy, 所以jdk动态代理只能代理接口，因为Java是单继承的\n// // Source code recreated from a .class file by IntelliJ IDEA // (powered by FernFlower decompiler) // package com.sun.proxy; import com.fc.se.proxy.Humen; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Method; import java.lang.reflect.Proxy; import java.lang.reflect.UndeclaredThrowableException; public final class $Proxy0 extends Proxy implements Humen { private static Method m1; private static Method m2; private static Method m3; private static Method m0; public $Proxy0(InvocationHandler var1) throws { super(var1); } public final boolean equals(Object var1) throws { try { return (Boolean)super.h.invoke(this, m1, new Object[]{var1}); } catch (RuntimeException | Error var3) { throw var3; } catch (Throwable var4) { throw new UndeclaredThrowableException(var4); } } public final String toString() throws { try { return (String)super.h.invoke(this, m2, (Object[])null); } catch (RuntimeException | Error var2) { throw var2; } catch (Throwable var3) { throw new UndeclaredThrowableException(var3); } } public final void eat(String var1) throws { try { super.h.invoke(this, m3, new Object[]{var1}); } catch (RuntimeException | Error var3) { throw var3; } catch (Throwable var4) { throw new UndeclaredThrowableException(var4); } } public final int hashCode() throws { try { return (Integer)super.h.invoke(this, m0, (Object[])null); } catch (RuntimeException | Error var2) { throw var2; } catch (Throwable var3) { throw new UndeclaredThrowableException(var3); } } static { try { m1 = Class.forName(\"java.lang.Object\").getMethod(\"equals\", Class.forName(\"java.lang.Object\")); m2 = Class.forName(\"java.lang.Object\").getMethod(\"toString\"); m3 = Class.forName(\"com.fc.se.proxy.Humen\").getMethod(\"eat\", Class.forName(\"java.lang.String\")); m0 = Class.forName(\"java.lang.Object\").getMethod(\"hashCode\"); } catch (NoSuchMethodException var2) { throw new NoSuchMethodError(var2.getMessage()); } catch (ClassNotFoundException var3) { throw new NoClassDefFoundError(var3.getMessage()); } } } 构造函数传入了InvocationHandler，赋值给了成员变量h，所以方法的调用都是走的InvocationHandler。\n本次示例中为DynamicProxy\npublic $Proxy0(InvocationHandler var1) throws { super(var1); } 在静态代码块中生成了对应的方法，类通用的hashCode()、toString()、equals(), 以及需要代理的方法eat()。\n$Proxy0调用eat方法，然后执行到了com.fc.se.proxy.DynamicProxy#invoke,\nmethod.invoke(target, args)调用具体的实现类执行方法。\n输出到文件 上一步中我们知道了生成的代理类的类名是$Proxy0, debug的时候也能看到类名，我们可以调用方法将这个类打印到文件里。\n更新后的测试类入口如下\nimport sun.misc.ProxyGenerator; import java.io.FileOutputStream; import java.io.IOException; public class DynamicProxyMain { public static void main(String[] args) { //动态代理时生成class文件 System.getProperties().put(\"sun.misc.ProxyGenerator.saveGeneratedFiles\",\"true\"); DynamicProxy dynamicProxy = new DynamicProxy(new HumenImpl()); Humen humenProxy = dynamicProxy.getProxy(); humenProxy.eat(\"rice\"); //保存$Proxy0到文件 saveProxyFile(); } private static void saveProxyFile() { FileOutputStream out = null; try { byte[] classFile = ProxyGenerator.generateProxyClass(\"$Proxy0\", HumenImpl.class.getInterfaces()); out = new FileOutputStream(\"/Users/since/git/vamei/out/class/\" + \"$Proxy0.class\"); out.write(classFile); } catch (Exception e) { e.printStackTrace(); } finally { try { if (out != null) { out.flush(); out.close(); } } catch (IOException e) { e.printStackTrace(); } } } } 执行之后可以发现已经生成了$Proxy0.class\n所以知道类名，就可以以这种方式输出到文件里\nhsdb 另一种是hsdb\n我这边使用hsdb失败了，具体是命令行执行的, attach process失败了，搜了一下，感觉执行起来挺麻烦的，就没深究。感兴趣的可以自行试下\n打开hsdb有2种方式\n一种是执行$JAVA_HOME/lib/sa-jdi.jar，命令行执行java -classpath sa-jdi.jar \"sun.jvm.hotspot.HSDB\"\n另一种是使用jhsdb hsdb命令打开ui, 有的jdk版本没有sa-jdi.jar，只能使用$JAVA_HOME/bin/jhsdb命令\nCGLIB代理的class文件 另一种常用的动态生成代理类的方式是使用cglib库，底层是基于ASM的\ncglib代理输出class文件，需要指定参数\n// 指定 CGLIB 将动态生成的代理类保存至指定的磁盘路径下 System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, \"/Users/since/git/vamei/out/cglib\"); 我们准备一个测试方法来测试一下，cglib依赖如下\ncglib cglib 3.3.0 一个main函数用于执行，生成代理类，Enhancer对象的superClass设置为CglibBaseBean, CglibBaseBean为要代理的目标对象，然后使用enhancer.create()创建代理对象\npublic class CglibProxy { public static void main(String[] args) { // 指定 CGLIB 将动态生成的代理类保存至指定的磁盘路径下 System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, \"/Users/since/git/vamei/out/cglib\"); Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(CglibBaseBean.class); enhancer.setCallback(new CglibCustomizedMethodInterceptor()); CglibBaseBean baseBean = (CglibBaseBean) enhancer.create(); baseBean.say(); } } 需要一个实现了MethodInterceptor的类，这个和InvocationHandler比较相似。\n在MethodInterceptor里添加拦截的逻辑\nimport net.sf.cglib.proxy.MethodInterceptor; import net.sf.cglib.proxy.MethodProxy; import java.lang.reflect.Method; /** * cglib CustomizedMethodInterceptor * * @author since * @date 2024-09-19 13:25 */ public class CglibCustomizedMethodInterceptor implements MethodInterceptor { @Override public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable { System.out.println(\"invoke \" + method.getName() + \" before ! \"); Object result = methodProxy.invokeSuper(o, objects); System.out.println(\"invoke \" + method.getName() + \" after ! \"); return result; } } 代理类持有了CglibCustomizedMethodInterceptor，真正执行的时候是通过CglibCustomizedMethodInterceptor的intercept方法执行到了被代理的目标类的。\n然后看一下class文件输出结果，生成了3个代理类\nCglibBaseBean$$EnhancerByCGLIB$$bf21c123.class是生成的代理类，其他2个是索引类\n代理类class具体内容如下\n// // Source code recreated from a .class file by IntelliJ IDEA // (powered by FernFlower decompiler) // package com.fc.se.proxy.cglib; import java.lang.reflect.Method; import net.sf.cglib.core.ReflectUtils; import net.sf.cglib.core.Signature; import net.sf.cglib.proxy.Callback; import net.sf.cglib.proxy.Factory; import net.sf.cglib.proxy.MethodInterceptor; import net.sf.cglib.proxy.MethodProxy; public class CglibBaseBean$$EnhancerByCGLIB$$bf21c123 extends CglibBaseBean implements Factory { private boolean CGLIB$BOUND; public static Object CGLIB$FACTORY_DATA; private static final ThreadLocal CGLIB$THREAD_CALLBACKS; private static final Callback[] CGLIB$STATIC_CALLBACKS; private MethodInterceptor CGLIB$CALLBACK_0; private static Object CGLIB$CALLBACK_FILTER; private static final Method CGLIB$say$0$Method; private static final MethodProxy CGLIB$say$0$Proxy; private static final Object[] CGLIB$emptyArgs; private static final Method CGLIB$equals$1$Method; private static final MethodProxy CGLIB$equals$1$Proxy; private static final Method CGLIB$toString$2$Method; private static final MethodProxy CGLIB$toString$2$Proxy; private static final Method CGLIB$hashCode$3$Method; private static final MethodProxy CGLIB$hashCode$3$Proxy; private static final Method CGLIB$clone$4$Method; private static final MethodProxy CGLIB$clone$4$Proxy; static void CGLIB$STATICHOOK1() { CGLIB$THREAD_CALLBACKS = new ThreadLocal(); CGLIB$emptyArgs = new Object[0]; Class var0 = Class.forName(\"com.fc.se.proxy.cglib.CglibBaseBean$$EnhancerByCGLIB$$bf21c123\"); Class var1; Method[] var10000 = ReflectUtils.findMethods(new String[]{\"equals\", \"(Ljava/lang/Object;)Z\", \"toString\", \"()Ljava/lang/String;\", \"hashCode\", \"()I\", \"clone\", \"()Ljava/lang/Object;\"}, (var1 = Class.forName(\"java.lang.Object\")).getDeclaredMethods()); CGLIB$equals$1$Method = var10000[0]; CGLIB$equals$1$Proxy = MethodProxy.create(var1, var0, \"(Ljava/lang/Object;)Z\", \"equals\", \"CGLIB$equals$1\"); CGLIB$toString$2$Method = var10000[1]; CGLIB$toString$2$Proxy = MethodProxy.create(var1, var0, \"()Ljava/lang/String;\", \"toString\", \"CGLIB$toString$2\"); CGLIB$hashCode$3$Method = var10000[2]; CGLIB$hashCode$3$Proxy = MethodProxy.create(var1, var0, \"()I\", \"hashCode\", \"CGLIB$hashCode$3\"); CGLIB$clone$4$Method = var10000[3]; CGLIB$clone$4$Proxy = MethodProxy.create(var1, var0, \"()Ljava/lang/Object;\", \"clone\", \"CGLIB$clone$4\"); CGLIB$say$0$Method = ReflectUtils.findMethods(new String[]{\"say\", \"()V\"}, (var1 = Class.forName(\"com.fc.se.proxy.cglib.CglibBaseBean\")).getDeclaredMethods())[0]; CGLIB$say$0$Proxy = MethodProxy.create(var1, var0, \"()V\", \"say\", \"CGLIB$say$0\"); } final void CGLIB$say$0() { super.say(); } public final void say() { MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (var10000 == null) { CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; } if (var10000 != null) { var10000.intercept(this, CGLIB$say$0$Method, CGLIB$emptyArgs, CGLIB$say$0$Proxy); } else { super.say(); } } final boolean CGLIB$equals$1(Object var1) { return super.equals(var1); } public final boolean equals(Object var1) { MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (var10000 == null) { CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; } if (var10000 != null) { Object var2 = var10000.intercept(this, CGLIB$equals$1$Method, new Object[]{var1}, CGLIB$equals$1$Proxy); return var2 == null ? false : (Boolean)var2; } else { return super.equals(var1); } } final String CGLIB$toString$2() { return super.toString(); } public final String toString() { MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (var10000 == null) { CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; } return var10000 != null ? (String)var10000.intercept(this, CGLIB$toString$2$Method, CGLIB$emptyArgs, CGLIB$toString$2$Proxy) : super.toString(); } final int CGLIB$hashCode$3() { return super.hashCode(); } public final int hashCode() { MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (var10000 == null) { CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; } if (var10000 != null) { Object var1 = var10000.intercept(this, CGLIB$hashCode$3$Method, CGLIB$emptyArgs, CGLIB$hashCode$3$Proxy); return var1 == null ? 0 : ((Number)var1).intValue(); } else { return super.hashCode(); } } final Object CGLIB$clone$4() throws CloneNotSupportedException { return super.clone(); } protected final Object clone() throws CloneNotSupportedException { MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (var10000 == null) { CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; } return var10000 != null ? var10000.intercept(this, CGLIB$clone$4$Method, CGLIB$emptyArgs, CGLIB$clone$4$Proxy) : super.clone(); } public static MethodProxy CGLIB$findMethodProxy(Signature var0) { String var10000 = var0.toString(); switch (var10000.hashCode()) { case -909388886: if (var10000.equals(\"say()V\")) { return CGLIB$say$0$Proxy; } break; case -508378822: if (var10000.equals(\"clone()Ljava/lang/Object;\")) { return CGLIB$clone$4$Proxy; } break; case 1826985398: if (var10000.equals(\"equals(Ljava/lang/Object;)Z\")) { return CGLIB$equals$1$Proxy; } break; case 1913648695: if (var10000.equals(\"toString()Ljava/lang/String;\")) { return CGLIB$toString$2$Proxy; } break; case 1984935277: if (var10000.equals(\"hashCode()I\")) { return CGLIB$hashCode$3$Proxy; } } return null; } public CglibBaseBean$$EnhancerByCGLIB$$bf21c123() { CGLIB$BIND_CALLBACKS(this); } public static void CGLIB$SET_THREAD_CALLBACKS(Callback[] var0) { CGLIB$THREAD_CALLBACKS.set(var0); } public static void CGLIB$SET_STATIC_CALLBACKS(Callback[] var0) { CGLIB$STATIC_CALLBACKS = var0; } private static final void CGLIB$BIND_CALLBACKS(Object var0) { CglibBaseBean$$EnhancerByCGLIB$$bf21c123 var1 = (CglibBaseBean$$EnhancerByCGLIB$$bf21c123)var0; if (!var1.CGLIB$BOUND) { var1.CGLIB$BOUND = true; Object var10000 = CGLIB$THREAD_CALLBACKS.get(); if (var10000 == null) { var10000 = CGLIB$STATIC_CALLBACKS; if (var10000 == null) { return; } } var1.CGLIB$CALLBACK_0 = (MethodInterceptor)((Callback[])var10000)[0]; } } public Object newInstance(Callback[] var1) { CGLIB$SET_THREAD_CALLBACKS(var1); CglibBaseBean$$EnhancerByCGLIB$$bf21c123 var10000 = new CglibBaseBean$$EnhancerByCGLIB$$bf21c123(); CGLIB$SET_THREAD_CALLBACKS((Callback[])null); return var10000; } public Object newInstance(Callback var1) { CGLIB$SET_THREAD_CALLBACKS(new Callback[]{var1}); CglibBaseBean$$EnhancerByCGLIB$$bf21c123 var10000 = new CglibBaseBean$$EnhancerByCGLIB$$bf21c123(); CGLIB$SET_THREAD_CALLBACKS((Callback[])null); return var10000; } public Object newInstance(Class[] var1, Object[] var2, Callback[] var3) { CGLIB$SET_THREAD_CALLBACKS(var3); CglibBaseBean$$EnhancerByCGLIB$$bf21c123 var10000 = new CglibBaseBean$$EnhancerByCGLIB$$bf21c123; switch (var1.length) { case 0: var10000.\u003cinit\u003e(); CGLIB$SET_THREAD_CALLBACKS((Callback[])null); return var10000; default: throw new IllegalArgumentException(\"Constructor not found\"); } } public Callback getCallback(int var1) { CGLIB$BIND_CALLBACKS(this); MethodInterceptor var10000; switch (var1) { case 0: var10000 = this.CGLIB$CALLBACK_0; break; default: var10000 = null; } return var10000; } public void setCallback(int var1, Callback var2) { switch (var1) { case 0: this.CGLIB$CALLBACK_0 = (MethodInterceptor)var2; default: } } public Callback[] getCallbacks() { CGLIB$BIND_CALLBACKS(this); return new Callback[]{this.CGLIB$CALLBACK_0}; } public void setCallbacks(Callback[] var1) { this.CGLIB$CALLBACK_0 = (MethodInterceptor)var1[0]; } static { CGLIB$STATICHOOK1(); } } 从上面的class文件可以看出，生成的代理类继承了CglibBaseBean，所以cglib相比于jdk动态代理，被代理类可以不用非得是接口\n使用Agent输出class文件 再一种方式就是使用Instrument, 这是jdk5提供的能力。\n关于instrument机制的介绍，可以看一下这一篇文章https://cnkirito.moe/instrument/\n如何搭建一个demo进行测试，可以参考上面的文章，测试的代码可以在 git仓库查看\ngit clone之后，执行mvn clean package生成agent.jar， 在目标进程添加jvm参数-javaagent:/Users/since/git/agent/target/agent.jar=-d=/Users/since/test/;-f=com/alibaba/dubbo/registry\n即可输出动态代理类的内容\n-javaagent:/Users/since/git/agent/target/agent.jar 这个是agent的文件路径\n-d=/Users/since/test/是结果的输出路径\n-f=com/alibaba/dubbo/registry是要打印的类的前缀包路径\n下面来简单说一下如何编写agent代码，实现class dump\nagent项目结构如下\n首先是要在META-INF下添加一个MANIFEST.MF，里面指定版本号，主类，是否可以重建类等属性\n指定的premain-class是com.fc.agent.GreetingAgent，所以agent的入口就是GreetingAgent了。\n来看一下GreetingAgent\n类里有一个premain方法，和main方法比较像，options是传入的参数，以上面为例，运行时options为-d=/Users/since/test/;-f=com/alibaba/dubbo/registry。\nInstrumentation 便是 JAVA5 的 Instrument 机制的核心，它负责为类添加 ClassFileTransformer 的实现，从而对类进行装配增强修改\n注意 premain 和它的两个参数不能随意修改， 规定是这样，不要修改。\n我们为ins添加了一个ClazzDumpCustomTransformer， 对options进行解析，解析出文件输出路径，以及要输出的包的路径。\n这里我想观察dubbo的adaptive代理，所以-f传的是dubbo的包路径\nimport java.lang.instrument.Instrumentation; /** * * * @author since * @date 2024-08-21 13:43 */ public class GreetingAgent { public static void premain(String options, Instrumentation ins) { if (options != null) { System.out.printf(\"I've been called with options: \\\"%s\\\"\\n\", options); } else { System.out.println(\"I've been called with no options.\"); } ClazzDumpCustomTransformer transformer = getTransformer(options); //更换不同的transformer ins.addTransformer(transformer); } public static ClazzDumpCustomTransformer getTransformer(String options) { String exportDir = null; String filterStr = null; boolean recursiveDir = false; if (options != null) { if (options.contains(\";\")) { String[] args = options.split(\";\"); for (String param1 : args) { String[] kv = param1.split(\"=\"); if (\"-d\".equalsIgnoreCase(kv[0])) { exportDir = kv[1]; } else if (\"-f\".equalsIgnoreCase(kv[0])) { filterStr = kv[1]; } else if (\"-r\".equalsIgnoreCase(kv[0])) { recursiveDir = true; } } } else { filterStr = options; } } System.out.println(\"getTransformer, exportDir: \" + exportDir + \", filterStr: \" + filterStr + \", recursiveDir: \" + recursiveDir); return new ClazzDumpCustomTransformer(exportDir, filterStr, recursiveDir); } } ClazzDumpCustomTransformer负责dump class，对符合条件的class，获取文件内容，输出到指定目录下\nimport java.io.File; import java.io.FileInputStream; import java.io.FileOutputStream; import java.lang.instrument.ClassFileTransformer; import java.lang.instrument.IllegalClassFormatException; import java.security.ProtectionDomain; import java.util.Arrays; /** * class dump * * @author since * @date 2024-09-10 13:36 */ public class ClazzDumpCustomTransformer implements ClassFileTransformer { /** * 导出过滤表达式，此处为类名前缀， 以 -f 参数指定 */ private String filterStr; /** * 导出文件目录根目录, 以 -d 参数指定 */ private String exportBaseDir = \"/tmp/\"; /** * 是否创建多级目录, 以 -r 参数指定 */ private boolean packageRecursive; public ClazzDumpCustomTransformer(String exportBaseDir, String filterStr) { this(exportBaseDir, filterStr, false); } public ClazzDumpCustomTransformer(String exportBaseDir, String filterStr, boolean packageRecursive) { if (exportBaseDir != null) { this.exportBaseDir = exportBaseDir; } this.packageRecursive = packageRecursive; this.filterStr = filterStr; } @Override public byte[] transform(ClassLoader loader, String className, Class\u003c?\u003e classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException { if (needExportClass(className)) { System.out.println(\"needExportClass: \" + className); int lastSeparatorIndex = className.lastIndexOf(\"/\") + 1; String fileName = className.substring(lastSeparatorIndex) + \".class\"; String exportDir = exportBaseDir; if (packageRecursive) { exportDir += className.substring(0, lastSeparatorIndex); } exportClazzToFile(exportDir, fileName, classfileBuffer); //\"D:/server-tool/tmp/bytecode/exported/\" System.out.println(className + \" --\u003e EXPORTED\"); } return classfileBuffer; } /** * 检测是否需要进行文件导出 * * @param className class名,如 com.xx.abc.AooMock * @return y/n */ private boolean needExportClass(String className) { if (filterStr != null) { return className.startsWith(filterStr); } return !className.startsWith(\"java\") \u0026\u0026 !className.startsWith(\"sun\"); } /** * 执行文件导出写入 * * @param dirPath 导出目录 * @param fileName 导出文件名 * @param data 字节流 */ private void exportClazzToFile(String dirPath, String fileName, byte[] data) { try { File dir = new File(dirPath); if (!dir.isDirectory()) { dir.mkdirs(); } File file = new File(dirPath + fileName); if (!file.exists()) { System.out.println(dirPath + fileName + \" is not exist, creating...\"); file.createNewFile(); } else { // String os = System.getProperty(\"os.name\"); // 主要针对windows文件不区分大小写问题 // if(os.toLowerCase().startsWith(\"win\")){ // // it's win // } try { int maxLoop = 9999; int renameSuffixId = 2; String[] cc = fileName.split(\"\\\\.\"); do { long fileLen = file.length(); byte[] fileContent = new byte[(int) fileLen]; FileInputStream in = new FileInputStream(file); in.read(fileContent); in.close(); if (!Arrays.equals(fileContent, data)) { fileName = cc[0] + \"_\" + renameSuffixId + \".\" + cc[1]; file = new File(dirPath + fileName); if (!file.exists()) { System.out.println(\"new create file: \" + dirPath + fileName); file.createNewFile(); break; } } else { break; } renameSuffixId++; maxLoop--; } while (maxLoop \u003e 0); } catch (Exception e) { System.err.println(\"exception in read class file..., path: \" + dirPath + fileName); e.printStackTrace(); } } FileOutputStream fos = new FileOutputStream(file); fos.write(data); fos.close(); } catch (Exception e) { System.err.println(\"exception occur while export class.\"); e.printStackTrace(); } } } 执行mvn clean package打包之后，添加到目标进程，添加启动参数，查看执行结果，在控制台输出了要打印的class\n进入输出路径，查看发现都生成了对应的class\n将class文件拖进idea可以查看具体内容\n从url里取相应的协议，注册默认是dubbo协议\n使用arthas输出class文件 提到agent，那就不得不说到arthas了，arthas在运行时排障非常的好用，点个赞。\n动态代理 当使用 arthas-boot 启动 Arthas 时，它会使用 Java 的 Attach API 来将自身动态注入到目标 JVM 进程中。通过附加 agentmain 方法，Arthas 可以对 JVM 进程进行监控和修改\n那么我们就拿arthas来看一下，如何打印运行时的class文件，主要是使用jad命令\narthas的安装使用相关内容参考官方文档: https://arthas.aliyun.com/doc/\n修改一下动态代理的测试类\npublic class DynamicProxyMain { public static void main(String[] args) throws InterruptedException { //动态代理时生成class文件 System.getProperties().put(\"sun.misc.ProxyGenerator.saveGeneratedFiles\",\"true\"); DynamicProxy dynamicProxy = new DynamicProxy(new HumenImpl()); Humen humenProxy = dynamicProxy.getProxy(); humenProxy.eat(\"rice\"); Thread.sleep(100*24*60*60*1000L); //保存$Proxy0到文件 // saveProxyFile(); } 让进程挂在这，然后启动arthas，选择这个进程进行attach\n使用sc命令搜索动态代理生成的类: sc *Proxy0*, 得到了代理类的全路径，然后使用jad命令反编译class，得到动态生成的代理类的文件内容\n再来看一下dubbo的示例，看看javassist生成的代理类如何\npublic class DubboSpi { public static void main(String[] args) throws InterruptedException { ExtensionLoader\u003cSimpleExt\u003e extensionLoader = ExtensionLoader.getExtensionLoader(SimpleExt.class); // SimpleExt defaultExtension = extensionLoader.getDefaultExtension(); // SimpleExt dog = extensionLoader.getExtension(\"dog\"); // SimpleExt dog2 = extensionLoader.getExtension(\"dog\", true); // SimpleExt cat = extensionLoader.getExtension(\"cat\"); // dog.yell(null, \"dogdog\"); // SimpleExt dog1 = extensionLoader.getExtension(\"dog\"); // dog1.yell(null, \"dog1\"); SimpleExt adaptiveExtension = extensionLoader.getAdaptiveExtension(); Thread.sleep(100*24*60*60*1000L); URLAddress urlAddress = new URLAddress(\"127.0.0.1\", 20880); URLParam parse = URLParam.parse(new HashMap\u003c\u003e()); adaptiveExtension.echo(new URL(urlAddress, parse), \"dogs\"); adaptiveExtension.bang(new URL(urlAddress, parse),0); } } javassist 仍然让进程挂在那，重新启动arthas进行attach\n使用jad反编译class，正常\ncglib 让进程空跑，使用arthas进行attach\nimport com.alibaba.excel.support.cglib.core.DebuggingClassWriter; import net.sf.cglib.proxy.Enhancer; /** * cglib proxy * * @author since * @date 2024-09-19 13:24 */ public class CglibProxy { public static void main(String[] args) throws InterruptedException { // 指定 CGLIB 将动态生成的代理类保存至指定的磁盘路径下 System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, \"/Users/since/git/vamei/out/cglib\"); Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(CglibBaseBean.class); enhancer.setCallback(new CglibCustomizedMethodInterceptor()); CglibBaseBean baseBean = (CglibBaseBean) enhancer.create(); baseBean.say(); Thread.sleep(100*24*60*60*1000L); } } 使用sc搜索相关的代理类，然后使用jad反编译, 也正常输出了\n总结 本文介绍了一下java生成动态代理类的方式，像jdk动态代理，cglib动态代理，javassist在项目中都有广泛的应用。\n对于查看动态代理class的内容，介绍了相关的方法进行查看，但是不够通用。\n通过写agent，了解了agent的一些知识，如何使用instrument机制在启动时和运行时增加class\n但是相比于自己写agent，还是arthas更加的方便通用一点，不用打agent包，也不用添加启动参数去重启进程。\narthas直接attach到目标进程上，可以模糊查询类，然后使用jad进行反编译，非常的方便。\narthas作为一个生产排障工具，还有其他更多强大的功能，值得去了解学习\n","wordCount":"7279","inLanguage":"zh","datePublished":"2024-09-11T15:40:13+08:00","dateModified":"2024-09-11T15:40:13+08:00","author":{"@type":"Person","name":"since"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.thend03.com/posts/tech/view-jvm-dynamic-class-detail/"},"publisher":{"@type":"Organization","name":"站在海边看远方","logo":{"@type":"ImageObject","url":"https://blog.thend03.com/img/logo.jpg"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.thend03.com/ accesskey=h title="thend03 (Alt + H)"><img src=https://blog.thend03.com/img/logo.jpg alt=logo aria-label=logo height=35>thend03</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://blog.thend03.com/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li><a href=https://blog.thend03.com/ title="🏠 主页"><span>🏠 主页</span></a></li><li><a href=https://blog.thend03.com/archives/ title="⏱️ 归档"><span>⏱️ 归档</span></a></li><li><a href=https://blog.thend03.com/tags title="🧩 标签"><span>🧩 标签</span></a></li><li><a href=https://blog.thend03.com/about title="🙋🏻‍♂️ 关于"><span>🙋🏻‍♂️ 关于</span></a></li><li><a href=https://blog.thend03.com/links title="🤝 友链"><span>🤝 友链</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://blog.thend03.com/>🏠 主页</a>&nbsp;»&nbsp;<a href=https://blog.thend03.com/posts/>📚文章</a>&nbsp;»&nbsp;<a href=https://blog.thend03.com/posts/tech/>👨🏻‍💻 技术</a></div><h1 class=post-title>如何查看jvm运行时生成的动态代理class文件</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2024-09-11
&nbsp;&nbsp;
</span></span><span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>7279字
&nbsp;&nbsp;
</span></span><span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>15分钟
&nbsp;&nbsp;
</span></span><span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>since
&nbsp;&nbsp;
</span></span><span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta><a href=https://blog.thend03.com/tags/java/ style=color:var(--secondary)!important>Java</a>
</span></span></span></span><span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;
</span></span><span id=post_meta_style_8><span class="fa fa-commenting-o"></span>
<span><script src=https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js></script><script>let url=document.documentURI,dnsUrl="https://blog.thend03.com/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=="/"&&(finalUrl="/"+finalUrl),twikoo.getCommentsCount({envId:"https://twikoo-e1f2-2yfafx14j-thend03s-projects.vercel.app/",region:null,urls:[finalUrl],includeReply:!1}).then(function(e){let t=e[0].count;const n=document.getElementById("comment_count");n.innerText=t}).catch(function(e){console.error(e)})</script><span id=comment_count></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#java%e7%94%9f%e6%88%90%e4%bb%a3%e7%90%86%e7%b1%bb%e7%9a%84%e6%96%b9%e5%bc%8f aria-label=Java生成代理类的方式>Java生成代理类的方式</a><ul><li><a href=#jdk%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86 aria-label=JDK动态代理>JDK动态代理</a></li><li><a href=#cglib%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86 aria-label=CGLIB动态代理>CGLIB动态代理</a></li><li><a href=#javassist aria-label=Javassist>Javassist</a></li><li><a href=#asm aria-label=ASM>ASM</a></li></ul></li><li><a href=#dubbo%e7%9b%b8%e5%85%b3%e4%bb%a3%e7%90%86%e7%b1%bb%e7%9a%84class%e6%96%87%e4%bb%b6 aria-label=Dubbo相关代理类的class文件>Dubbo相关代理类的class文件</a></li><li><a href=#jdk%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86%e7%9a%84class%e6%96%87%e4%bb%b6 aria-label=JDK动态代理的class文件>JDK动态代理的class文件</a><ul><li><a href=#%e8%ae%be%e7%bd%ae%e5%8f%82%e6%95%b0 aria-label=设置参数>设置参数</a></li><li><a href=#%e8%be%93%e5%87%ba%e5%88%b0%e6%96%87%e4%bb%b6 aria-label=输出到文件>输出到文件</a></li><li><a href=#hsdb aria-label=hsdb>hsdb</a></li></ul></li><li><a href=#cglib%e4%bb%a3%e7%90%86%e7%9a%84class%e6%96%87%e4%bb%b6 aria-label=CGLIB代理的class文件>CGLIB代理的class文件</a></li><li><a href=#%e4%bd%bf%e7%94%a8agent%e8%be%93%e5%87%baclass%e6%96%87%e4%bb%b6 aria-label=使用Agent输出class文件>使用Agent输出class文件</a></li><li><a href=#%e4%bd%bf%e7%94%a8arthas%e8%be%93%e5%87%baclass%e6%96%87%e4%bb%b6 aria-label=使用arthas输出class文件>使用arthas输出class文件</a><ul><li><a href=#%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86 aria-label=动态代理>动态代理</a></li><li><a href=#javassist-1 aria-label=javassist>javassist</a></li><li><a href=#cglib aria-label=cglib>cglib</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{elements&&(activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h1><p>最近看dubbo的时候，看到了讲spi的部分，其中提到了@Adaptive注解生成了代理类</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409111608009.png alt=image-20240911160843943></p><p>我后面去debug了一下，打了断点，发现在运行时，只是显示了class的名称，由于<strong>RegistryFactory$Adaptive</strong> 是动态生成的，所以没有class文件结构可以看，而文章里贴了class文件。</p><p>所以比较好奇，如何拿到class文件。</p><p>经过一番搜索验证之后，有了如下的文章</p><h1 id=java生成代理类的方式>Java生成代理类的方式<a hidden class=anchor aria-hidden=true href=#java生成代理类的方式>#</a></h1><p>首先呢, java生成代理类有如下几种方式。</p><p>在了解了动态代理的生成方式之后，可以分情况讨论如何拿到代理类的class文件</p><h2 id=jdk动态代理>JDK动态代理<a hidden class=anchor aria-hidden=true href=#jdk动态代理>#</a></h2><p>这个是java自身支持的代理方式，自带的，无需引入额外组件，但是只能代理接口。</p><p>因为生成的代理类需要继承Proxy类，java是单继承的，所以只能代理接口。</p><h2 id=cglib动态代理>CGLIB动态代理<a hidden class=anchor aria-hidden=true href=#cglib动态代理>#</a></h2><p>cglib可以为class创建代理类，类不必是接口，采用的是继承委托类的方式，因此不能代理final类，只能代理所有非final的public/protected类型的方法定义。</p><p>cglib是采用的asm字节码拼接技术，继承一个类，子类对方法进行拦截，织入横切逻辑。</p><h2 id=javassist>Javassist<a hidden class=anchor aria-hidden=true href=#javassist>#</a></h2><p>使用javassist可以直接操纵字节码，生成代理类。</p><p>dubbo的代理类就是使用javassist拼接出来的</p><h2 id=asm>ASM<a hidden class=anchor aria-hidden=true href=#asm>#</a></h2><p>asm相比javassist，更加的细粒度，且实现更加的复杂。</p><h1 id=dubbo相关代理类的class文件>Dubbo相关代理类的class文件<a hidden class=anchor aria-hidden=true href=#dubbo相关代理类的class文件>#</a></h1><p>具体到dubbo的话，@Adaptive会生成相关的代理类，Dubbo的代理类是用javaasist生成的。</p><p>再延伸到调用过程，consumer调provider，生成的代理类是jdk动态代理</p><p>provider端调用过程中，会有一个warpper代理类，生成的代理类是使用javassist生成的，然后通过Warpper0.invokeMethod()根据具体的调用信息调用到具体的实现类。</p><p><strong>本次使用的dubbo版本是3.2.0</strong></p><p>去年写了一篇关于
<a href=https://blog.thend03.com/posts/dubbo-spi/ target=_blank rel=noopener style=color:#e16723 ;>dubbo spi</a>的文章，感兴趣的可以看一下，介绍了spi的相关实现方式，以及如何使用</p><p>具体到Adaptive代理类，使用如下的测试代码(完整的过程可以参考上面的文章地址)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DubboSpi</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ExtensionLoader</span><span class=o>&lt;</span><span class=n>SimpleExt</span><span class=o>&gt;</span><span class=w> </span><span class=n>extensionLoader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ExtensionLoader</span><span class=p>.</span><span class=na>getExtensionLoader</span><span class=p>(</span><span class=n>SimpleExt</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        SimpleExt defaultExtension = extensionLoader.getDefaultExtension();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        SimpleExt dog = extensionLoader.getExtension(&#34;dog&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        SimpleExt dog2 = extensionLoader.getExtension(&#34;dog&#34;, true);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        SimpleExt cat = extensionLoader.getExtension(&#34;cat&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        dog.yell(null, &#34;dogdog&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        SimpleExt dog1 = extensionLoader.getExtension(&#34;dog&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        dog1.yell(null, &#34;dog1&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SimpleExt</span><span class=w> </span><span class=n>adaptiveExtension</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>extensionLoader</span><span class=p>.</span><span class=na>getAdaptiveExtension</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>URLAddress</span><span class=w> </span><span class=n>urlAddress</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>URLAddress</span><span class=p>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>20880</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>URLParam</span><span class=w> </span><span class=n>parse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>URLParam</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>adaptiveExtension</span><span class=p>.</span><span class=na>echo</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>URL</span><span class=p>(</span><span class=n>urlAddress</span><span class=p>,</span><span class=w> </span><span class=n>parse</span><span class=p>),</span><span class=w> </span><span class=s>&#34;dogs&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>adaptiveExtension</span><span class=p>.</span><span class=na>bang</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>URL</span><span class=p>(</span><span class=n>urlAddress</span><span class=p>,</span><span class=w> </span><span class=n>parse</span><span class=p>),</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>定位到如下生成代理类的方法,代码在<code>org.apache.dubbo.common.extension.ExtensionLoader#createAdaptiveExtensionClass</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>createAdaptiveExtensionClass</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Adaptive Classes&#39; ClassLoader should be the same with Real SPI interface classes&#39; ClassLoader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClassLoader</span><span class=w> </span><span class=n>classLoader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>type</span><span class=p>.</span><span class=na>getClassLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>NativeUtils</span><span class=p>.</span><span class=na>isNative</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>classLoader</span><span class=p>.</span><span class=na>loadClass</span><span class=p>(</span><span class=n>type</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;$Adaptive&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>ignore</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//这里生成class文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>code</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AdaptiveClassCodeGenerator</span><span class=p>(</span><span class=n>type</span><span class=p>,</span><span class=w> </span><span class=n>cachedDefaultName</span><span class=p>).</span><span class=na>generate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>common</span><span class=p>.</span><span class=na>compiler</span><span class=p>.</span><span class=na>Compiler</span><span class=w> </span><span class=n>compiler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>extensionDirector</span><span class=p>.</span><span class=na>getExtensionLoader</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>common</span><span class=p>.</span><span class=na>compiler</span><span class=p>.</span><span class=na>Compiler</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>getAdaptiveExtension</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>compiler</span><span class=p>.</span><span class=na>compile</span><span class=p>(</span><span class=n>type</span><span class=p>,</span><span class=w> </span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=n>classLoader</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>我们debug看一下生成的code, 看类名，是SimpleExt$Adaptive, 通过手动拼接的方式，生成了adaptive代理类。</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409181525928.png alt=image-20240918152509863></p><p>调用AdaptiveCompiler，最终compileer的类型为<code>JavassistCompiler</code>，即通过javassist生成的adaptive代理类</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409181527968.png alt=image-20240918152734919></p><p>那么回归到我一开始的问题，如何查看动态生成的class的内容，在<code>String code = new AdaptiveClassCodeGenerator(type, cachedDefaultName).generate();</code>这一行通过debug就可以拿到具体的class内容了</p><p>生成的代理类如下所示, 对接口的方法进行了拦截</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.fc.rpc.dubbo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.dubbo.rpc.model.ScopeModel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.dubbo.rpc.model.ScopeModelUtil</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SimpleExt$Adaptive</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>fc</span><span class=p>.</span><span class=na>rpc</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>SimpleExt</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=w> </span><span class=nf>yell</span><span class=p>(</span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>common</span><span class=p>.</span><span class=na>URL</span><span class=w> </span><span class=n>arg0</span><span class=p>,</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=w> </span><span class=n>arg1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>arg0</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;url == null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>common</span><span class=p>.</span><span class=na>URL</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arg0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>extName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>url</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=s>&#34;key1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=s>&#34;key2&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;dog&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>extName</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;Failed to get extension (com.fc.rpc.dubbo.SimpleExt) name from url (&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>url</span><span class=p>.</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;) use keys([key1, key2])&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ScopeModel</span><span class=w> </span><span class=n>scopeModel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ScopeModelUtil</span><span class=p>.</span><span class=na>getOrDefault</span><span class=p>(</span><span class=n>url</span><span class=p>.</span><span class=na>getScopeModel</span><span class=p>(),</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>fc</span><span class=p>.</span><span class=na>rpc</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>SimpleExt</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>com</span><span class=p>.</span><span class=na>fc</span><span class=p>.</span><span class=na>rpc</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>SimpleExt</span><span class=w> </span><span class=n>extension</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>fc</span><span class=p>.</span><span class=na>rpc</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>SimpleExt</span><span class=p>)</span><span class=w> </span><span class=n>scopeModel</span><span class=p>.</span><span class=na>getExtensionLoader</span><span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>fc</span><span class=p>.</span><span class=na>rpc</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>SimpleExt</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>getExtension</span><span class=p>(</span><span class=n>extName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>extension</span><span class=p>.</span><span class=na>yell</span><span class=p>(</span><span class=n>arg0</span><span class=p>,</span><span class=w> </span><span class=n>arg1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=w> </span><span class=nf>echo</span><span class=p>(</span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>common</span><span class=p>.</span><span class=na>URL</span><span class=w> </span><span class=n>arg0</span><span class=p>,</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=w> </span><span class=n>arg1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>arg0</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;url == null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>common</span><span class=p>.</span><span class=na>URL</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arg0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>extName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>url</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=s>&#34;simple.ext&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;dog&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>extName</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;Failed to get extension (com.fc.rpc.dubbo.SimpleExt) name from url (&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>url</span><span class=p>.</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;) use keys([simple.ext])&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ScopeModel</span><span class=w> </span><span class=n>scopeModel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ScopeModelUtil</span><span class=p>.</span><span class=na>getOrDefault</span><span class=p>(</span><span class=n>url</span><span class=p>.</span><span class=na>getScopeModel</span><span class=p>(),</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>fc</span><span class=p>.</span><span class=na>rpc</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>SimpleExt</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>com</span><span class=p>.</span><span class=na>fc</span><span class=p>.</span><span class=na>rpc</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>SimpleExt</span><span class=w> </span><span class=n>extension</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>fc</span><span class=p>.</span><span class=na>rpc</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>SimpleExt</span><span class=p>)</span><span class=w> </span><span class=n>scopeModel</span><span class=p>.</span><span class=na>getExtensionLoader</span><span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>fc</span><span class=p>.</span><span class=na>rpc</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>SimpleExt</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>getExtension</span><span class=p>(</span><span class=n>extName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>extension</span><span class=p>.</span><span class=na>echo</span><span class=p>(</span><span class=n>arg0</span><span class=p>,</span><span class=w> </span><span class=n>arg1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=w> </span><span class=nf>bang</span><span class=p>(</span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>dubbo</span><span class=p>.</span><span class=na>common</span><span class=p>.</span><span class=na>URL</span><span class=w> </span><span class=n>arg0</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>arg1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnsupportedOperationException</span><span class=p>(</span><span class=s>&#34;The method public abstract java.lang.String com.fc.rpc.dubbo.SimpleExt.bang(org.apache.dubbo.common.URL,int) of interface com.fc.rpc.dubbo.SimpleExt is not adaptive method!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>另外debug级别的话，生成的class会输出到日志</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409181550439.png alt=image-20240918155018371></p><h1 id=jdk动态代理的class文件>JDK动态代理的class文件<a hidden class=anchor aria-hidden=true href=#jdk动态代理的class文件>#</a></h1><p>回归到jdk的动态代理，如何查看jdk动态代理生成的class文件</p><p>这里主要讲一下如何查看动态代理的class文件，动态代理的原理啥的不深入。</p><h2 id=设置参数>设置参数<a hidden class=anchor aria-hidden=true href=#设置参数>#</a></h2><p>在调用之前，添加<code>System.getProperties().put("sun.misc.ProxyGenerator.saveGeneratedFiles","true");</code></p><p>这个只适用于jdk动态代理</p><p>准备一下测试类</p><p>这是调用入口</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicProxyMain</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//动态代理时生成class文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>getProperties</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;sun.misc.ProxyGenerator.saveGeneratedFiles&#34;</span><span class=p>,</span><span class=s>&#34;true&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicProxy</span><span class=w> </span><span class=n>dynamicProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DynamicProxy</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>HumenImpl</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Humen</span><span class=w> </span><span class=n>humenProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dynamicProxy</span><span class=p>.</span><span class=na>getProxy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>humenProxy</span><span class=p>.</span><span class=na>eat</span><span class=p>(</span><span class=s>&#34;rice&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>DynamicProxy实现了InvocationHandler，用于生成代理类</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.InvocationHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicProxy</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>InvocationHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>target</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>DynamicProxy</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>target</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>target</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>proxy</span><span class=p>,</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>before</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>after</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>before</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;吃东西之前先热身&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>after</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;吃完饭休息一下&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>getProxy</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>T</span><span class=p>)</span><span class=w> </span><span class=n>Proxy</span><span class=p>.</span><span class=na>newProxyInstance</span><span class=p>(</span><span class=n>target</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getClassLoader</span><span class=p>(),</span><span class=n>target</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getInterfaces</span><span class=p>(),</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>测试用的接口</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 人类迷惑行为大赏
</span></span></span><span class=line><span class=cl><span class=cm> **/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Humen</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 吃东西
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param food 食物
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>eat</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>food</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>测试接口的实现类</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 人类迷惑行为大赏具体案例
</span></span></span><span class=line><span class=cl><span class=cm> **/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>HumenImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Humen</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>eat</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>food</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;人类开始行为艺术表演：吃食物 &#34;</span><span class=o>+</span><span class=n>food</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>那么主要看一下这个配置<code>System.getProperties().put("sun.misc.ProxyGenerator.saveGeneratedFiles","true");</code>这个配置是用于保存生成的class的。</p><p>缺点是这个参数只适用于jdk动态代理</p><p>加上这个参数运行一下，会发现代理类保存到了项目路径(classpath)下</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409181602018.png alt=image-20240918160242965></p><p>看一下$Proxy0的详细内容, 代理类继承了Proxy, 所以jdk动态代理只能代理接口，因为Java是单继承的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Source code recreated from a .class file by IntelliJ IDEA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// (powered by FernFlower decompiler)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.sun.proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.fc.se.proxy.Humen</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.InvocationHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.UndeclaredThrowableException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>$Proxy0</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Proxy</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Humen</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>m1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>m2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>m3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>m0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>$Proxy0</span><span class=p>(</span><span class=n>InvocationHandler</span><span class=w> </span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w>  </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>var1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>equals</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w>  </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>Boolean</span><span class=p>)</span><span class=kd>super</span><span class=p>.</span><span class=na>h</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>m1</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=n>var1</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=n>var3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>var3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UndeclaredThrowableException</span><span class=p>(</span><span class=n>var4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w>  </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=kd>super</span><span class=p>.</span><span class=na>h</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>m2</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>Object</span><span class=o>[]</span><span class=p>)</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=n>var2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>var2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>var3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UndeclaredThrowableException</span><span class=p>(</span><span class=n>var3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>eat</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w>  </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>super</span><span class=p>.</span><span class=na>h</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>m3</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=n>var1</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=n>var3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>var3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UndeclaredThrowableException</span><span class=p>(</span><span class=n>var4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>hashCode</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w>  </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span><span class=kd>super</span><span class=p>.</span><span class=na>h</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>m0</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>Object</span><span class=o>[]</span><span class=p>)</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=n>var2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>var2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>var3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UndeclaredThrowableException</span><span class=p>(</span><span class=n>var3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>m1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Object&#34;</span><span class=p>).</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;equals&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Object&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>m2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Object&#34;</span><span class=p>).</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;toString&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>m3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;com.fc.se.proxy.Humen&#34;</span><span class=p>).</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;eat&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.String&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>m0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Object&#34;</span><span class=p>).</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;hashCode&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchMethodException</span><span class=w> </span><span class=n>var2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NoSuchMethodError</span><span class=p>(</span><span class=n>var2</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=n>var3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NoClassDefFoundError</span><span class=p>(</span><span class=n>var3</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>构造函数传入了InvocationHandler，赋值给了成员变量h，所以方法的调用都是走的InvocationHandler。</p><p>本次示例中为DynamicProxy</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=o>$</span><span class=n>Proxy0</span><span class=p>(</span><span class=n>InvocationHandler</span> <span class=n>var1</span><span class=p>)</span> <span class=n>throws</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>super</span><span class=p>(</span><span class=n>var1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在静态代码块中生成了对应的方法，类通用的hashCode()、toString()、equals(), 以及需要代理的方法eat()。</p><p>$Proxy0调用eat方法，然后执行到了<code>com.fc.se.proxy.DynamicProxy#invoke</code>,</p><p><code>method.invoke(target, args)</code>调用具体的实现类执行方法。</p><h2 id=输出到文件>输出到文件<a hidden class=anchor aria-hidden=true href=#输出到文件>#</a></h2><p>上一步中我们知道了生成的代理类的类名是$Proxy0, debug的时候也能看到类名，我们可以调用方法将这个类打印到文件里。</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409181628208.png alt=image-20240918162848155></p><p>更新后的测试类入口如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>sun.misc.ProxyGenerator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.IOException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicProxyMain</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//动态代理时生成class文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>getProperties</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;sun.misc.ProxyGenerator.saveGeneratedFiles&#34;</span><span class=p>,</span><span class=s>&#34;true&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicProxy</span><span class=w> </span><span class=n>dynamicProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DynamicProxy</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>HumenImpl</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Humen</span><span class=w> </span><span class=n>humenProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dynamicProxy</span><span class=p>.</span><span class=na>getProxy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>humenProxy</span><span class=p>.</span><span class=na>eat</span><span class=p>(</span><span class=s>&#34;rice&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//保存$Proxy0到文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>saveProxyFile</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>saveProxyFile</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>classFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ProxyGenerator</span><span class=p>.</span><span class=na>generateProxyClass</span><span class=p>(</span><span class=s>&#34;$Proxy0&#34;</span><span class=p>,</span><span class=w> </span><span class=n>HumenImpl</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getInterfaces</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=s>&#34;/Users/since/git/vamei/out/class/&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;$Proxy0.class&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>classFile</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>out</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>out</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>out</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>执行之后可以发现已经生成了$Proxy0.class</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409181638627.png alt=image-20240918163812572></p><p>所以知道类名，就可以以这种方式输出到文件里</p><h2 id=hsdb>hsdb<a hidden class=anchor aria-hidden=true href=#hsdb>#</a></h2><p>另一种是hsdb</p><p>我这边使用hsdb失败了，具体是命令行执行的, attach process失败了，搜了一下，感觉执行起来挺麻烦的，就没深究。感兴趣的可以自行试下</p><p>打开hsdb有2种方式</p><p>一种是执行$JAVA_HOME/lib/sa-jdi.jar，命令行执行<code>java -classpath sa-jdi.jar "sun.jvm.hotspot.HSDB"</code></p><p>另一种是使用jhsdb hsdb命令打开ui, 有的jdk版本没有sa-jdi.jar，只能使用$JAVA_HOME/bin/jhsdb命令</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409181716411.png alt=image-20240918171627367></p><h1 id=cglib代理的class文件>CGLIB代理的class文件<a hidden class=anchor aria-hidden=true href=#cglib代理的class文件>#</a></h1><p>另一种常用的动态生成代理类的方式是使用cglib库，底层是基于ASM的</p><p>cglib代理输出class文件，需要指定参数</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 指定 CGLIB 将动态生成的代理类保存至指定的磁盘路径下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>setProperty</span><span class=p>(</span><span class=n>DebuggingClassWriter</span><span class=p>.</span><span class=na>DEBUG_LOCATION_PROPERTY</span><span class=p>,</span><span class=w> </span><span class=s>&#34;/Users/since/git/vamei/out/cglib&#34;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>我们准备一个测试方法来测试一下，cglib依赖如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;groupId&gt;</span>cglib<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;artifactId&gt;</span>cglib<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;version&gt;</span>3.3.0<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>一个main函数用于执行，生成代理类，Enhancer对象的superClass设置为CglibBaseBean, CglibBaseBean为要代理的目标对象，然后使用<code>enhancer.create()</code>创建代理对象</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CglibProxy</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 指定 CGLIB 将动态生成的代理类保存至指定的磁盘路径下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>setProperty</span><span class=p>(</span><span class=n>DebuggingClassWriter</span><span class=p>.</span><span class=na>DEBUG_LOCATION_PROPERTY</span><span class=p>,</span><span class=w> </span><span class=s>&#34;/Users/since/git/vamei/out/cglib&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Enhancer</span><span class=w> </span><span class=n>enhancer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Enhancer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>enhancer</span><span class=p>.</span><span class=na>setSuperclass</span><span class=p>(</span><span class=n>CglibBaseBean</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>enhancer</span><span class=p>.</span><span class=na>setCallback</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>CglibCustomizedMethodInterceptor</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CglibBaseBean</span><span class=w> </span><span class=n>baseBean</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>CglibBaseBean</span><span class=p>)</span><span class=w> </span><span class=n>enhancer</span><span class=p>.</span><span class=na>create</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>baseBean</span><span class=p>.</span><span class=na>say</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>需要一个实现了MethodInterceptor的类，这个和<code>InvocationHandler</code>比较相似。</p><p>在MethodInterceptor里添加拦截的逻辑</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>net.sf.cglib.proxy.MethodInterceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>net.sf.cglib.proxy.MethodProxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * cglib CustomizedMethodInterceptor
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @author since
</span></span></span><span class=line><span class=cl><span class=cm> * @date 2024-09-19 13:25
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CglibCustomizedMethodInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>MethodInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>intercept</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>,</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>objects</span><span class=p>,</span><span class=w> </span><span class=n>MethodProxy</span><span class=w> </span><span class=n>methodProxy</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;invoke &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; before ! &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>methodProxy</span><span class=p>.</span><span class=na>invokeSuper</span><span class=p>(</span><span class=n>o</span><span class=p>,</span><span class=w> </span><span class=n>objects</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;invoke &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; after ! &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>代理类持有了CglibCustomizedMethodInterceptor，真正执行的时候是通过CglibCustomizedMethodInterceptor的intercept方法执行到了被代理的目标类的。</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409191414295.png alt=image-20240919141408249></p><p>然后看一下class文件输出结果，生成了3个代理类</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409191422204.png alt=image-20240919142222166></p><p>CglibBaseBean$$EnhancerByCGLIB$$bf21c123.class是生成的代理类，其他2个是索引类</p><p>代理类class具体内容如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Source code recreated from a .class file by IntelliJ IDEA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// (powered by FernFlower decompiler)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.fc.se.proxy.cglib</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>net.sf.cglib.core.ReflectUtils</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>net.sf.cglib.core.Signature</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>net.sf.cglib.proxy.Callback</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>net.sf.cglib.proxy.Factory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>net.sf.cglib.proxy.MethodInterceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>net.sf.cglib.proxy.MethodProxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CglibBaseBean$$EnhancerByCGLIB$$bf21c123</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>CglibBaseBean</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Factory</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>CGLIB$BOUND</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>CGLIB$FACTORY_DATA</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ThreadLocal</span><span class=w> </span><span class=n>CGLIB$THREAD_CALLBACKS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Callback</span><span class=o>[]</span><span class=w> </span><span class=n>CGLIB$STATIC_CALLBACKS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>MethodInterceptor</span><span class=w> </span><span class=n>CGLIB$CALLBACK_0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>CGLIB$CALLBACK_FILTER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>CGLIB$say$0$Method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>MethodProxy</span><span class=w> </span><span class=n>CGLIB$say$0$Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>CGLIB$emptyArgs</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>CGLIB$equals$1$Method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>MethodProxy</span><span class=w> </span><span class=n>CGLIB$equals$1$Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>CGLIB$toString$2$Method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>MethodProxy</span><span class=w> </span><span class=n>CGLIB$toString$2$Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>CGLIB$hashCode$3$Method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>MethodProxy</span><span class=w> </span><span class=n>CGLIB$hashCode$3$Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>CGLIB$clone$4$Method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>MethodProxy</span><span class=w> </span><span class=n>CGLIB$clone$4$Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>CGLIB$STATICHOOK1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$THREAD_CALLBACKS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$emptyArgs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=w> </span><span class=n>var0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;com.fc.se.proxy.cglib.CglibBaseBean$$EnhancerByCGLIB$$bf21c123&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=w> </span><span class=n>var1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Method</span><span class=o>[]</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ReflectUtils</span><span class=p>.</span><span class=na>findMethods</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;equals&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;(Ljava/lang/Object;)Z&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;toString&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;()Ljava/lang/String;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;hashCode&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;()I&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;clone&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;()Ljava/lang/Object;&#34;</span><span class=p>},</span><span class=w> </span><span class=p>(</span><span class=n>var1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Object&#34;</span><span class=p>)).</span><span class=na>getDeclaredMethods</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$equals$1$Method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var10000</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$equals$1$Proxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MethodProxy</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var0</span><span class=p>,</span><span class=w> </span><span class=s>&#34;(Ljava/lang/Object;)Z&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;equals&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;CGLIB$equals$1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$toString$2$Method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var10000</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$toString$2$Proxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MethodProxy</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var0</span><span class=p>,</span><span class=w> </span><span class=s>&#34;()Ljava/lang/String;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;toString&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;CGLIB$toString$2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$hashCode$3$Method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var10000</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$hashCode$3$Proxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MethodProxy</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var0</span><span class=p>,</span><span class=w> </span><span class=s>&#34;()I&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;hashCode&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;CGLIB$hashCode$3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$clone$4$Method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var10000</span><span class=o>[</span><span class=n>3</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$clone$4$Proxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MethodProxy</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var0</span><span class=p>,</span><span class=w> </span><span class=s>&#34;()Ljava/lang/Object;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;clone&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;CGLIB$clone$4&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$say$0$Method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ReflectUtils</span><span class=p>.</span><span class=na>findMethods</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;say&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;()V&#34;</span><span class=p>},</span><span class=w> </span><span class=p>(</span><span class=n>var1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;com.fc.se.proxy.cglib.CglibBaseBean&#34;</span><span class=p>)).</span><span class=na>getDeclaredMethods</span><span class=p>())</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$say$0$Proxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MethodProxy</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var0</span><span class=p>,</span><span class=w> </span><span class=s>&#34;()V&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;say&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;CGLIB$say$0&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>CGLIB$say$0</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>say</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>say</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MethodInterceptor</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>CGLIB$BIND_CALLBACKS</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>var10000</span><span class=p>.</span><span class=na>intercept</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$say$0$Method</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$emptyArgs</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$say$0$Proxy</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>super</span><span class=p>.</span><span class=na>say</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>CGLIB$equals$1</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>var1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>equals</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MethodInterceptor</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>CGLIB$BIND_CALLBACKS</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var10000</span><span class=p>.</span><span class=na>intercept</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$equals$1$Method</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=n>var1</span><span class=p>},</span><span class=w> </span><span class=n>CGLIB$equals$1$Proxy</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>Boolean</span><span class=p>)</span><span class=n>var2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>var1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>CGLIB$toString$2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MethodInterceptor</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>CGLIB$BIND_CALLBACKS</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=n>var10000</span><span class=p>.</span><span class=na>intercept</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$toString$2$Method</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$emptyArgs</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$toString$2$Proxy</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>CGLIB$hashCode$3</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>hashCode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>hashCode</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MethodInterceptor</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>CGLIB$BIND_CALLBACKS</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var10000</span><span class=p>.</span><span class=na>intercept</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$hashCode$3$Method</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$emptyArgs</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$hashCode$3$Proxy</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>((</span><span class=n>Number</span><span class=p>)</span><span class=n>var1</span><span class=p>).</span><span class=na>intValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>hashCode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>CGLIB$clone$4</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>CloneNotSupportedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>clone</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>clone</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>CloneNotSupportedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MethodInterceptor</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>CGLIB$BIND_CALLBACKS</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>var10000</span><span class=p>.</span><span class=na>intercept</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$clone$4$Method</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$emptyArgs</span><span class=p>,</span><span class=w> </span><span class=n>CGLIB$clone$4$Proxy</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>clone</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>MethodProxy</span><span class=w> </span><span class=nf>CGLIB$findMethodProxy</span><span class=p>(</span><span class=n>Signature</span><span class=w> </span><span class=n>var0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var0</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=p>.</span><span class=na>hashCode</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=o>-</span><span class=n>909388886</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;say()V&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>CGLIB$say$0$Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=o>-</span><span class=n>508378822</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;clone()Ljava/lang/Object;&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>CGLIB$clone$4$Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>1826985398</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;equals(Ljava/lang/Object;)Z&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>CGLIB$equals$1$Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>1913648695</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;toString()Ljava/lang/String;&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>CGLIB$toString$2$Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>1984935277</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;hashCode()I&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>CGLIB$hashCode$3$Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>CglibBaseBean$$EnhancerByCGLIB$$bf21c123</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$BIND_CALLBACKS</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>CGLIB$SET_THREAD_CALLBACKS</span><span class=p>(</span><span class=n>Callback</span><span class=o>[]</span><span class=w> </span><span class=n>var0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$THREAD_CALLBACKS</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>var0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>CGLIB$SET_STATIC_CALLBACKS</span><span class=p>(</span><span class=n>Callback</span><span class=o>[]</span><span class=w> </span><span class=n>var0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$STATIC_CALLBACKS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>CGLIB$BIND_CALLBACKS</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CglibBaseBean$$EnhancerByCGLIB$$bf21c123</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>CglibBaseBean$$EnhancerByCGLIB$$bf21c123</span><span class=p>)</span><span class=n>var0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>var1</span><span class=p>.</span><span class=na>CGLIB$BOUND</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>var1</span><span class=p>.</span><span class=na>CGLIB$BOUND</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CGLIB$THREAD_CALLBACKS</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CGLIB$STATIC_CALLBACKS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var10000</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>var1</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MethodInterceptor</span><span class=p>)((</span><span class=n>Callback</span><span class=o>[]</span><span class=p>)</span><span class=n>var10000</span><span class=p>)</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>newInstance</span><span class=p>(</span><span class=n>Callback</span><span class=o>[]</span><span class=w> </span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$SET_THREAD_CALLBACKS</span><span class=p>(</span><span class=n>var1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CglibBaseBean$$EnhancerByCGLIB$$bf21c123</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CglibBaseBean$$EnhancerByCGLIB$$bf21c123</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$SET_THREAD_CALLBACKS</span><span class=p>((</span><span class=n>Callback</span><span class=o>[]</span><span class=p>)</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>var10000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>newInstance</span><span class=p>(</span><span class=n>Callback</span><span class=w> </span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$SET_THREAD_CALLBACKS</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Callback</span><span class=o>[]</span><span class=p>{</span><span class=n>var1</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CglibBaseBean$$EnhancerByCGLIB$$bf21c123</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CglibBaseBean$$EnhancerByCGLIB$$bf21c123</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$SET_THREAD_CALLBACKS</span><span class=p>((</span><span class=n>Callback</span><span class=o>[]</span><span class=p>)</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>var10000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>newInstance</span><span class=p>(</span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>Callback</span><span class=o>[]</span><span class=w> </span><span class=n>var3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$SET_THREAD_CALLBACKS</span><span class=p>(</span><span class=n>var3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CglibBaseBean$$EnhancerByCGLIB$$bf21c123</span><span class=w> </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CglibBaseBean$$EnhancerByCGLIB$$bf21c123</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>var1</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>0</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>var10000</span><span class=p>.</span><span class=o>&lt;</span><span class=n>init</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>CGLIB$SET_THREAD_CALLBACKS</span><span class=p>((</span><span class=n>Callback</span><span class=o>[]</span><span class=p>)</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>var10000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Constructor not found&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Callback</span><span class=w> </span><span class=nf>getCallback</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$BIND_CALLBACKS</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MethodInterceptor</span><span class=w> </span><span class=n>var10000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>0</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>var10000</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>var10000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setCallback</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>Callback</span><span class=w> </span><span class=n>var2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>0</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MethodInterceptor</span><span class=p>)</span><span class=n>var2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Callback</span><span class=o>[]</span><span class=w> </span><span class=nf>getCallbacks</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$BIND_CALLBACKS</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Callback</span><span class=o>[]</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setCallbacks</span><span class=p>(</span><span class=n>Callback</span><span class=o>[]</span><span class=w> </span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>CGLIB$CALLBACK_0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MethodInterceptor</span><span class=p>)</span><span class=n>var1</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CGLIB$STATICHOOK1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>从上面的class文件可以看出，生成的代理类继承了CglibBaseBean，所以cglib相比于jdk动态代理，被代理类可以不用非得是接口</p><h1 id=使用agent输出class文件>使用Agent输出class文件<a hidden class=anchor aria-hidden=true href=#使用agent输出class文件>#</a></h1><p>再一种方式就是使用Instrument, 这是jdk5提供的能力。</p><p>关于instrument机制的介绍，可以看一下这一篇文章https://cnkirito.moe/instrument/</p><p>如何搭建一个demo进行测试，可以参考上面的文章，测试的代码可以在
<a href=https://github.com/thend03/agent target=_blank rel=noopener style=color:#e16723 ;>git仓库</a>查看</p><p>git clone之后，执行mvn clean package生成agent.jar， 在目标进程添加jvm参数<code>-javaagent:/Users/since/git/agent/target/agent.jar=-d=/Users/since/test/;-f=com/alibaba/dubbo/registry</code></p><p>即可输出动态代理类的内容</p><ul><li><p><code>-javaagent:/Users/since/git/agent/target/agent.jar </code>这个是agent的文件路径</p></li><li><p><code>-d=/Users/since/test/</code>是结果的输出路径</p></li><li><p><code>-f=com/alibaba/dubbo/registry</code>是要打印的类的前缀包路径</p></li></ul><p>下面来简单说一下如何编写agent代码，实现class dump</p><p>agent项目结构如下</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409181737237.png alt=image-20240918173752186></p><p>首先是要在META-INF下添加一个<code>MANIFEST.MF</code>，里面指定版本号，主类，是否可以重建类等属性</p><p>指定的premain-class是<code>com.fc.agent.GreetingAgent</code>，所以agent的入口就是GreetingAgent了。</p><p>来看一下<code>GreetingAgent</code></p><p>类里有一个premain方法，和main方法比较像，options是传入的参数，以上面为例，运行时options为<code>-d=/Users/since/test/;-f=com/alibaba/dubbo/registry</code>。</p><p>Instrumentation 便是 JAVA5 的 Instrument 机制的核心，它负责为类添加 ClassFileTransformer 的实现，从而对类进行装配增强修改</p><p>注意 premain 和它的两个参数不能随意修改， 规定是这样，不要修改。</p><p>我们为ins添加了一个ClazzDumpCustomTransformer， 对options进行解析，解析出文件输出路径，以及要输出的包的路径。</p><p>这里我想观察dubbo的adaptive代理，所以-f传的是dubbo的包路径</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.instrument.Instrumentation</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @author since
</span></span></span><span class=line><span class=cl><span class=cm> * @date 2024-08-21 13:43
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>GreetingAgent</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>premain</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>Instrumentation</span><span class=w> </span><span class=n>ins</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>options</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=s>&#34;I&#39;ve been called with options: \&#34;%s\&#34;\n&#34;</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;I&#39;ve been called with no options.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClazzDumpCustomTransformer</span><span class=w> </span><span class=n>transformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getTransformer</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//更换不同的transformer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ins</span><span class=p>.</span><span class=na>addTransformer</span><span class=p>(</span><span class=n>transformer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ClazzDumpCustomTransformer</span><span class=w> </span><span class=nf>getTransformer</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>exportDir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>filterStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>recursiveDir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>options</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>options</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=s>&#34;;&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>options</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>param1</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>kv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>param1</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;=&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=s>&#34;-d&#34;</span><span class=p>.</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>kv</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>exportDir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kv</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=s>&#34;-f&#34;</span><span class=p>.</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>kv</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>filterStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kv</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=s>&#34;-r&#34;</span><span class=p>.</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>kv</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>recursiveDir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>filterStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>options</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;getTransformer, exportDir: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>exportDir</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, filterStr: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>filterStr</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, recursiveDir: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>recursiveDir</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ClazzDumpCustomTransformer</span><span class=p>(</span><span class=n>exportDir</span><span class=p>,</span><span class=w> </span><span class=n>filterStr</span><span class=p>,</span><span class=w> </span><span class=n>recursiveDir</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ClazzDumpCustomTransformer负责dump class，对符合条件的class，获取文件内容，输出到指定目录下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.File</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.instrument.ClassFileTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.instrument.IllegalClassFormatException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.security.ProtectionDomain</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Arrays</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * class dump
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @author since
</span></span></span><span class=line><span class=cl><span class=cm> * @date 2024-09-10 13:36
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ClazzDumpCustomTransformer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ClassFileTransformer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 导出过滤表达式，此处为类名前缀， 以 -f 参数指定
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>filterStr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 导出文件目录根目录, 以 -d 参数指定
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>exportBaseDir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;/tmp/&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 是否创建多级目录, 以 -r 参数指定
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>packageRecursive</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>ClazzDumpCustomTransformer</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>exportBaseDir</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>filterStr</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>(</span><span class=n>exportBaseDir</span><span class=p>,</span><span class=w> </span><span class=n>filterStr</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>ClazzDumpCustomTransformer</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>exportBaseDir</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>filterStr</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>packageRecursive</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>exportBaseDir</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>exportBaseDir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exportBaseDir</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>packageRecursive</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>packageRecursive</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>filterStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>filterStr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span><span class=n>ClassLoader</span><span class=w> </span><span class=n>loader</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>className</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>classBeingRedefined</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>ProtectionDomain</span><span class=w> </span><span class=n>protectionDomain</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>classfileBuffer</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IllegalClassFormatException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>needExportClass</span><span class=p>(</span><span class=n>className</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;needExportClass: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>className</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>lastSeparatorIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>className</span><span class=p>.</span><span class=na>lastIndexOf</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>fileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>className</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>lastSeparatorIndex</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.class&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>exportDir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exportBaseDir</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>packageRecursive</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>exportDir</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>className</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>lastSeparatorIndex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>exportClazzToFile</span><span class=p>(</span><span class=n>exportDir</span><span class=p>,</span><span class=w> </span><span class=n>fileName</span><span class=p>,</span><span class=w> </span><span class=n>classfileBuffer</span><span class=p>);</span><span class=w>         </span><span class=c1>//&#34;D:/server-tool/tmp/bytecode/exported/&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>className</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; --&gt; EXPORTED&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>classfileBuffer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 检测是否需要进行文件导出
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param className class名,如 com.xx.abc.AooMock
</span></span></span><span class=line><span class=cl><span class=cm>     * @return y/n
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>needExportClass</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>className</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>filterStr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>className</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=n>filterStr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=o>!</span><span class=n>className</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;java&#34;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>className</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;sun&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 执行文件导出写入
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param dirPath 导出目录
</span></span></span><span class=line><span class=cl><span class=cm>     * @param fileName 导出文件名
</span></span></span><span class=line><span class=cl><span class=cm>     * @param data 字节流
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>exportClazzToFile</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>dirPath</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>fileName</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>File</span><span class=w> </span><span class=n>dir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>dirPath</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>dir</span><span class=p>.</span><span class=na>isDirectory</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>dir</span><span class=p>.</span><span class=na>mkdirs</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>File</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>dirPath</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>fileName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>file</span><span class=p>.</span><span class=na>exists</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>dirPath</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>fileName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; is not exist, creating...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>file</span><span class=p>.</span><span class=na>createNewFile</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                String os = System.getProperty(&#34;os.name&#34;);        // 主要针对windows文件不区分大小写问题</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                if(os.toLowerCase().startsWith(&#34;win&#34;)){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                    // it&#39;s win</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>maxLoop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>9999</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>renameSuffixId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>cc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fileName</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;\\.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kt>long</span><span class=w> </span><span class=n>fileLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>file</span><span class=p>.</span><span class=na>length</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>fileContent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>fileLen</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>FileInputStream</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=n>file</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>in</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>fileContent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>in</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>Arrays</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>fileContent</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>fileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cc</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;_&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>renameSuffixId</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>cc</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>dirPath</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>fileName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>file</span><span class=p>.</span><span class=na>exists</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;new create file: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>dirPath</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>fileName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>file</span><span class=p>.</span><span class=na>createNewFile</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>renameSuffixId</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>maxLoop</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>maxLoop</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;exception in read class file..., path: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>dirPath</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>fileName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>fos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=n>file</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fos</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fos</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;exception occur while export class.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>执行mvn clean package打包之后，添加到目标进程，添加启动参数，查看执行结果，在控制台输出了要打印的class</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409181748247.png alt=image-20240918174830197></p><p>进入输出路径，查看发现都生成了对应的class</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409181750507.png alt=image-20240918175035451></p><p>将class文件拖进idea可以查看具体内容</p><p>从url里取相应的协议，注册默认是dubbo协议</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409181754182.png alt=image-20240918175435124></p><h1 id=使用arthas输出class文件>使用arthas输出class文件<a hidden class=anchor aria-hidden=true href=#使用arthas输出class文件>#</a></h1><p>提到agent，那就不得不说到arthas了，arthas在运行时排障非常的好用，点个赞。</p><h2 id=动态代理>动态代理<a hidden class=anchor aria-hidden=true href=#动态代理>#</a></h2><p>当使用 <code>arthas-boot</code> 启动 Arthas 时，它会使用 Java 的 <strong>Attach API</strong> 来将自身动态注入到目标 JVM 进程中。通过附加 <code>agentmain</code> 方法，Arthas 可以对 JVM 进程进行监控和修改</p><p>那么我们就拿arthas来看一下，如何打印运行时的class文件，主要是使用jad命令</p><p>arthas的安装使用相关内容参考官方文档:
<a href=https://arthas.aliyun.com/doc/ target=_blank rel=noopener style=color:#e16723 ;>https://arthas.aliyun.com/doc/</a></p><p>修改一下动态代理的测试类</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicProxyMain</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//动态代理时生成class文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>getProperties</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;sun.misc.ProxyGenerator.saveGeneratedFiles&#34;</span><span class=p>,</span><span class=s>&#34;true&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicProxy</span><span class=w> </span><span class=n>dynamicProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DynamicProxy</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>HumenImpl</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Humen</span><span class=w> </span><span class=n>humenProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dynamicProxy</span><span class=p>.</span><span class=na>getProxy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>humenProxy</span><span class=p>.</span><span class=na>eat</span><span class=p>(</span><span class=s>&#34;rice&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>100</span><span class=o>*</span><span class=n>24</span><span class=o>*</span><span class=n>60</span><span class=o>*</span><span class=n>60</span><span class=o>*</span><span class=n>1000L</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//保存$Proxy0到文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        saveProxyFile();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>让进程挂在这，然后启动arthas，选择这个进程进行attach</p><p>使用sc命令搜索动态代理生成的类: <code>sc *Proxy0*</code>, 得到了代理类的全路径，然后使用jad命令反编译class，得到动态生成的代理类的文件内容</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409191128855.png alt=image-20240919112806799></p><p>再来看一下dubbo的示例，看看javassist生成的代理类如何</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DubboSpi</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ExtensionLoader</span><span class=o>&lt;</span><span class=n>SimpleExt</span><span class=o>&gt;</span><span class=w> </span><span class=n>extensionLoader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ExtensionLoader</span><span class=p>.</span><span class=na>getExtensionLoader</span><span class=p>(</span><span class=n>SimpleExt</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        SimpleExt defaultExtension = extensionLoader.getDefaultExtension();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        SimpleExt dog = extensionLoader.getExtension(&#34;dog&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        SimpleExt dog2 = extensionLoader.getExtension(&#34;dog&#34;, true);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        SimpleExt cat = extensionLoader.getExtension(&#34;cat&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        dog.yell(null, &#34;dogdog&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        SimpleExt dog1 = extensionLoader.getExtension(&#34;dog&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        dog1.yell(null, &#34;dog1&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SimpleExt</span><span class=w> </span><span class=n>adaptiveExtension</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>extensionLoader</span><span class=p>.</span><span class=na>getAdaptiveExtension</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>100</span><span class=o>*</span><span class=n>24</span><span class=o>*</span><span class=n>60</span><span class=o>*</span><span class=n>60</span><span class=o>*</span><span class=n>1000L</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>URLAddress</span><span class=w> </span><span class=n>urlAddress</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>URLAddress</span><span class=p>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>20880</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>URLParam</span><span class=w> </span><span class=n>parse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>URLParam</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>adaptiveExtension</span><span class=p>.</span><span class=na>echo</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>URL</span><span class=p>(</span><span class=n>urlAddress</span><span class=p>,</span><span class=w> </span><span class=n>parse</span><span class=p>),</span><span class=w> </span><span class=s>&#34;dogs&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>adaptiveExtension</span><span class=p>.</span><span class=na>bang</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>URL</span><span class=p>(</span><span class=n>urlAddress</span><span class=p>,</span><span class=w> </span><span class=n>parse</span><span class=p>),</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=javassist-1>javassist<a hidden class=anchor aria-hidden=true href=#javassist-1>#</a></h2><p>仍然让进程挂在那，重新启动arthas进行attach</p><p>使用jad反编译class，正常</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409191307947.png alt=image-20240919130747879></p><h2 id=cglib>cglib<a hidden class=anchor aria-hidden=true href=#cglib>#</a></h2><p>让进程空跑，使用arthas进行attach</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.alibaba.excel.support.cglib.core.DebuggingClassWriter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>net.sf.cglib.proxy.Enhancer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * cglib proxy
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @author since
</span></span></span><span class=line><span class=cl><span class=cm> * @date 2024-09-19 13:24
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CglibProxy</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 指定 CGLIB 将动态生成的代理类保存至指定的磁盘路径下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>setProperty</span><span class=p>(</span><span class=n>DebuggingClassWriter</span><span class=p>.</span><span class=na>DEBUG_LOCATION_PROPERTY</span><span class=p>,</span><span class=w> </span><span class=s>&#34;/Users/since/git/vamei/out/cglib&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Enhancer</span><span class=w> </span><span class=n>enhancer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Enhancer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>enhancer</span><span class=p>.</span><span class=na>setSuperclass</span><span class=p>(</span><span class=n>CglibBaseBean</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>enhancer</span><span class=p>.</span><span class=na>setCallback</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>CglibCustomizedMethodInterceptor</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CglibBaseBean</span><span class=w> </span><span class=n>baseBean</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>CglibBaseBean</span><span class=p>)</span><span class=w> </span><span class=n>enhancer</span><span class=p>.</span><span class=na>create</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>baseBean</span><span class=p>.</span><span class=na>say</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>100</span><span class=o>*</span><span class=n>24</span><span class=o>*</span><span class=n>60</span><span class=o>*</span><span class=n>60</span><span class=o>*</span><span class=n>1000L</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>使用sc搜索相关的代理类，然后使用jad反编译, 也正常输出了</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202409191742338.png alt=image-20240919174244260></p><h1 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h1><p>本文介绍了一下java生成动态代理类的方式，像jdk动态代理，cglib动态代理，javassist在项目中都有广泛的应用。</p><p>对于查看动态代理class的内容，介绍了相关的方法进行查看，但是不够通用。</p><p>通过写agent，了解了agent的一些知识，如何使用instrument机制在启动时和运行时增加class</p><p>但是相比于自己写agent，还是arthas更加的方便通用一点，不用打agent包，也不用添加启动参数去重启进程。</p><p>arthas直接attach到目标进程上，可以模糊查询类，然后使用jad进行反编译，非常的方便。</p><p>arthas作为一个生产排障工具，还有其他更多强大的功能，值得去了解学习</p></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://blog.thend03.com/img/wechat-pay.png alt=wechat_pay></a><p>微信</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://blog.thend03.com/img/alipay.png alt=alipay></a><p>支付宝</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>🧧 鼓励</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://blog.thend03.com/posts/blog/%E5%88%9B%E4%B8%9A%E6%9C%AA%E5%8D%8A%E5%85%88%E4%BA%8F850/><span class=title>« 上一页</span><br><span>创业未半先亏850</span>
</a><a class=next href=https://blog.thend03.com/posts/life/2024-q3-summary/><span class=title>下一页 »</span><br><span>2024三季度总结</span></a></nav></footer></div><script>function createGiscusScript(e){const t=document.createElement("script");Object.entries(e).forEach(([e,n])=>t.setAttribute(e,n)),document.querySelector("article").appendChild(t);const n=document.querySelector('label[for="switch_default"]');n&&n.addEventListener("click",function(){const e=document.body.classList.contains("dark")?"transparent_dark":"light";t.setAttribute("data-theme",e),sendMessage({setConfig:{theme:e}})})}function sendMessage(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}document.addEventListener("DOMContentLoaded",function(){const e={src:"https://giscus.app/client.js","data-repo":"thend03/blog-comments","data-repo-id":"R_kgDOJx0ckg","data-category":"Announcements","data-category-id":"DIC_kwDOJx0cks4CmM8j","data-mapping":"pathname","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-lang":"zh-CN","data-loading":"lazy",crossorigin:"anonymous",async:""};e["data-theme"]=document.body.classList.contains("dark")?"transparent_dark":"light",createGiscusScript(e);const t=new MutationObserver(()=>{const e=document.body.classList.contains("dark")?"transparent_dark":"light";sendMessage({setConfig:{theme:e}})});t.observe(document.body,{attributes:!0,attributeFilter:["class"]})})</script></article></main><footer class=footer><span>Copyright
&copy;
2020-2025
<a href=https://blog.thend03.com/ style=color:#939393>站在海边看远方</a>
All Rights Reserved
</span><a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393></a>&nbsp;
<span><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null" style=display:inline-block;text-decoration:none;height:20px;color:#939393><img src style="float:left;margin:0 5px 0 0">
</a></span><span id=busuanzi_container><span class="fa fa-user"></span> <span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye"></span> <span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
<span id=read_progress></span>
</span></a><script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString(),s=window.getSelection().toString();t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="复制";function i(){t.innerText="已复制！",setTimeout(()=>{t.innerText="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>