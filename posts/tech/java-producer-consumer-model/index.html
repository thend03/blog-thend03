<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Javaå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ | ç«™åœ¨æµ·è¾¹çœ‹è¿œæ–¹</title>
<meta name=keywords content="java,juc"><meta name=description content="æ¡ˆä¾‹
Javaå¹¶å‘çš„æ—¶å€™ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªå…³äºç”Ÿäº§è€…æ¶ˆè´¹è€…çš„æ¡ˆä¾‹
ä¸€ä¸ªproducerç±»å’Œä¸€ä¸ªconsumerç±»ï¼Œå®ç°äº†Runnableæ¥å£ï¼Œä½œä¸ºçº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡
ä¸€ä¸ªQueueç±»ï¼Œå®ç°äº†queueçš„put()å’Œtakeæ“ä½œï¼Œæ¨¡æ‹Ÿäº†ç”Ÿäº§å’Œæ¶ˆè´¹2ä¸ªåŠ¨ä½œ
å®ç°æ–¹å¼ä½¿ç”¨äº†ReentrantLock+Condition"><meta name=author content="since"><link rel=canonical href=https://blog.thend03.com/posts/tech/java-producer-consumer-model/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://blog.thend03.com/img/logo.jpg><link rel=icon type=image/png sizes=16x16 href=https://blog.thend03.com/img/logo.jpg><link rel=icon type=image/png sizes=32x32 href=https://blog.thend03.com/img/logo.jpg><link rel=apple-touch-icon href=https://blog.thend03.com/img/logo.jpg><link rel=mask-icon href=https://blog.thend03.com/img/logo.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.thend03.com/posts/tech/java-producer-consumer-model/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="Javaå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"><meta property="og:description" content="æ¡ˆä¾‹
Javaå¹¶å‘çš„æ—¶å€™ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªå…³äºç”Ÿäº§è€…æ¶ˆè´¹è€…çš„æ¡ˆä¾‹
ä¸€ä¸ªproducerç±»å’Œä¸€ä¸ªconsumerç±»ï¼Œå®ç°äº†Runnableæ¥å£ï¼Œä½œä¸ºçº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡
ä¸€ä¸ªQueueç±»ï¼Œå®ç°äº†queueçš„put()å’Œtakeæ“ä½œï¼Œæ¨¡æ‹Ÿäº†ç”Ÿäº§å’Œæ¶ˆè´¹2ä¸ªåŠ¨ä½œ
å®ç°æ–¹å¼ä½¿ç”¨äº†ReentrantLock+Condition"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.thend03.com/posts/tech/java-producer-consumer-model/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-27T15:52:52+08:00"><meta property="article:modified_time" content="2025-02-27T15:52:52+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Javaå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"><meta name=twitter:description content="æ¡ˆä¾‹
Javaå¹¶å‘çš„æ—¶å€™ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªå…³äºç”Ÿäº§è€…æ¶ˆè´¹è€…çš„æ¡ˆä¾‹
ä¸€ä¸ªproducerç±»å’Œä¸€ä¸ªconsumerç±»ï¼Œå®ç°äº†Runnableæ¥å£ï¼Œä½œä¸ºçº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡
ä¸€ä¸ªQueueç±»ï¼Œå®ç°äº†queueçš„put()å’Œtakeæ“ä½œï¼Œæ¨¡æ‹Ÿäº†ç”Ÿäº§å’Œæ¶ˆè´¹2ä¸ªåŠ¨ä½œ
å®ç°æ–¹å¼ä½¿ç”¨äº†ReentrantLock+Condition"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“šæ–‡ç« ","item":"https://blog.thend03.com/posts/"},{"@type":"ListItem","position":2,"name":"ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯","item":"https://blog.thend03.com/posts/tech/"},{"@type":"ListItem","position":3,"name":"Javaå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹","item":"https://blog.thend03.com/posts/tech/java-producer-consumer-model/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Javaå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹","name":"Javaå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹","description":"æ¡ˆä¾‹ Javaå¹¶å‘çš„æ—¶å€™ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªå…³äºç”Ÿäº§è€…æ¶ˆè´¹è€…çš„æ¡ˆä¾‹\nä¸€ä¸ªproducerç±»å’Œä¸€ä¸ªconsumerç±»ï¼Œå®ç°äº†Runnableæ¥å£ï¼Œä½œä¸ºçº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡\nä¸€ä¸ªQueueç±»ï¼Œå®ç°äº†queueçš„put()å’Œtakeæ“ä½œï¼Œæ¨¡æ‹Ÿäº†ç”Ÿäº§å’Œæ¶ˆè´¹2ä¸ªåŠ¨ä½œ\nå®ç°æ–¹å¼ä½¿ç”¨äº†ReentrantLock+Condition\n","keywords":["java","juc"],"articleBody":"æ¡ˆä¾‹ Javaå¹¶å‘çš„æ—¶å€™ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªå…³äºç”Ÿäº§è€…æ¶ˆè´¹è€…çš„æ¡ˆä¾‹\nä¸€ä¸ªproducerç±»å’Œä¸€ä¸ªconsumerç±»ï¼Œå®ç°äº†Runnableæ¥å£ï¼Œä½œä¸ºçº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡\nä¸€ä¸ªQueueç±»ï¼Œå®ç°äº†queueçš„put()å’Œtakeæ“ä½œï¼Œæ¨¡æ‹Ÿäº†ç”Ÿäº§å’Œæ¶ˆè´¹2ä¸ªåŠ¨ä½œ\nå®ç°æ–¹å¼ä½¿ç”¨äº†ReentrantLock+Condition\nè¿™ä¸ªç¤ºä¾‹ä»£ç çš„è¯ï¼Œæ˜¯å¯ä»¥å®ç°å¤šçº¿ç¨‹ä¹‹é—´å¹¶å‘ç”Ÿäº§å’Œæ¶ˆè´¹çš„ï¼Œå¤šä¸ªçº¿ç¨‹å…±åŒæ“ä½œä¸€ä¸ªQueueå¯¹è±¡ï¼Œå¯ä»¥å®ç°é˜Ÿåˆ—æ»¡æ—¶ç”Ÿäº§ç­‰å¾…ï¼Œé˜Ÿåˆ—ç©ºæ—¶æ¶ˆè´¹ç­‰å¾…ï¼Œä¸”æ— å¹¶å‘é—®é¢˜ã€‚\næˆ‘å½“æ—¶äº§ç”Ÿçš„ç–‘é—®æ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨äº†ReentrantLockï¼Œè¿˜è¦ä½¿ç”¨Condition\nè¿™ä¸ªé—®é¢˜ä¸‹ä¸€ä¸ªç« èŠ‚å†è¯´ï¼Œå…ˆè´´ä¸‹ç¤ºä¾‹ä»£ç \nProducer\npublic class Producer implements Runnable { Queue queue = null; public Producer(Queue queue) { this.queue = queue; } @Override public void run() { String threadName = Thread.currentThread().getName(); try { // éš”10ç§’è½®è¯¢ç”Ÿäº§ä¸€æ¬¡ while (true) { System.out.println(\"Producer\"); TimeUnit.SECONDS.sleep(10); queue.put(new Random().nextInt(100),threadName); } } catch (Exception e) { e.printStackTrace(); } } } Consumer\npublic class Consumer implements Runnable { Queue queue = null; public Consumer(Queue queue) { this.queue = queue; } @Override public void run() { String threadName = Thread.currentThread().getName(); try { // éš”3ç§’è½®è¯¢æ¶ˆè´¹ä¸€æ¬¡ while (true) { System.out.println(\"Customer\"); TimeUnit.SECONDS.sleep(3); System.out.println(\"å–åˆ°çš„å€¼-\" + queue.take()); } } catch (Exception e) { e.printStackTrace(); } } } Queue\npublic class Queue { private int[] arr = new int[5]; private int size = 0; private int putIndex = 0; // ç”Ÿäº§ä½ç½® private int takeIndex = 0; // æ¶ˆè´¹ä½ç½® private ReentrantLock lock = new ReentrantLock(); private Condition pCondition = lock.newCondition(); private Condition cCondition = lock.newCondition(); public boolean isEmpty() { return size==0; } public boolean isFull() { return size==5; } public void put(Integer value, String name) throws InterruptedException { log(name + \" â–¶â–¶â–¶ å°è¯•è·å–é”...\"); lock.lock(); try { log(name + \" âœ… æˆåŠŸè·å–é” | å½“å‰é”çŠ¶æ€: \" + lock); while (isFull()) { log(name + \" â¸ï¸ é˜Ÿåˆ—å·²æ»¡ï¼Œè¿›å…¥ç­‰å¾… (pCondition.await())...\"); pCondition.await(); // è‡ªåŠ¨é‡Šæ”¾é”ï¼ log(name + \" ğŸ”„ è¢«å”¤é†’ï¼Œé‡æ–°è·å–é” | å½“å‰é”çŠ¶æ€: \" + lock); } arr[putIndex] = value; putIndex = (putIndex + 1) % arr.length; size++; // ç”Ÿäº§é€»è¾‘... log(name + \" ğŸ”” ç”Ÿäº§å®Œæˆï¼Œå”¤é†’æ¶ˆè´¹è€… (cCondition.signalAll())\"); cCondition.signalAll(); } finally { lock.unlock(); log(name + \" â¹ï¸ é‡Šæ”¾é” | å½“å‰é”çŠ¶æ€: \" + lock); } } public int take() throws InterruptedException { String threadName = Thread.currentThread().getName(); log(threadName + \" â–¶â–¶â–¶ å°è¯•è·å–é”...\"); lock.lock(); try { log(threadName + \" âœ… æˆåŠŸè·å–é” | å½“å‰é”çŠ¶æ€: \" + lock); while (isEmpty()) { log(threadName + \" â¸ï¸ é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿›å…¥ç­‰å¾… (cCondition.await())...\"); cCondition.await(); // è‡ªåŠ¨é‡Šæ”¾é”ï¼ log(threadName + \" ğŸ”„ è¢«å”¤é†’ï¼Œé‡æ–°è·å–é” | å½“å‰é”çŠ¶æ€: \" + lock); } int value = arr[takeIndex]; arr[takeIndex] = 0; // å¯é€‰ï¼šæ¸…ç†æ•°æ®ä»¥ä¾¿è°ƒè¯• takeIndex = (takeIndex + 1) % arr.length; size--; log(threadName + \" ğŸ”” æ¶ˆè´¹å®Œæˆï¼Œå”¤é†’ç”Ÿäº§è€… (pCondition.signalAll())\"); pCondition.signalAll(); return value; } finally { lock.unlock(); log(threadName + \" â¹ï¸ é‡Šæ”¾é” | å½“å‰é”çŠ¶æ€: \" + lock); } } private void log(String message) { System.out.printf(\"[%s] %s%n\", LocalDateTime.now().format(DateTimeFormatter.ISO_LOCAL_TIME), message); } } åˆ†æ ä»£ç æµ‹è¯• é¦–å…ˆå†™äº†ä¸ªæµ‹è¯•ç±»ï¼Œæµ‹è¯•äº†ä¸€ä¸‹ç”Ÿäº§æ¶ˆè´¹é€»è¾‘, 2ä¸ªç”Ÿäº§è€…ï¼Œ2ä¸ªæ¶ˆè´¹è€…ï¼Œå…±4ä¸ªçº¿ç¨‹ï¼Œæ“ä½œåŒä¸€ä¸ªqueueï¼Œå®ç°ç”Ÿäº§æ¶ˆè´¹é€»è¾‘\npublic static void main(String[] args) { // ä¸¤ä¸ªç”Ÿäº§è€…ï¼Œä¸¤ä¸ªæ¶ˆè´¹è€… Queue queue = new Queue(); Thread producer1 = new Thread(new Producer(queue)); producer1.setName(\"Producer1\"); producer1.start(); Thread producer2 = new Thread(new Producer(queue)); producer2.setName(\"Producer2\"); producer2.start(); Thread Consumer1 = new Thread(new Consumer(queue)); Consumer1.setName(\"Consumer1\"); Consumer1.start(); Thread Consumer2 = new Thread(new Consumer(queue)); Consumer2.setName(\"Consumer2\"); Consumer2.start(); } æ§åˆ¶å°éƒ¨åˆ†è¾“å‡ºå†…å®¹å¦‚ä¸‹\nè¾“å‡ºå†…å®¹å±•ç¤ºäº†å°è¯•è·å–é”â€”-\u003eè·å–é”æˆåŠŸâ€”-\u003eç­‰å¾…â€”-\u003eé‡Šæ”¾é”â€”-\u003eè¢«å”¤é†’â€”-\u003eé‡æ–°è·å–é”â€”-\u003eç”Ÿäº§/æ¶ˆè´¹å®Œæˆå¹¶å”¤é†’ç­‰å¾…çš„çº¿ç¨‹â€”-\u003eé‡Šæ”¾é”çš„è¿™ä¹ˆä¸€ä¸ªè¿‡ç¨‹\n[16:14:07.504] Consumer1 â–¶â–¶â–¶ å°è¯•è·å–é”... [16:14:07.504] Consumer2 â–¶â–¶â–¶ å°è¯•è·å–é”... [16:14:07.516] Consumer1 âœ… æˆåŠŸè·å–é” | å½“å‰é”çŠ¶æ€: java.util.concurrent.locks.ReentrantLock@363b2ca2[Locked by thread Consumer1] [16:14:07.516] Consumer1 â¸ï¸ é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿›å…¥ç­‰å¾… (cCondition.await())... [16:14:07.516] Consumer2 âœ… æˆåŠŸè·å–é” | å½“å‰é”çŠ¶æ€: java.util.concurrent.locks.ReentrantLock@363b2ca2[Locked by thread Consumer2] [16:14:07.516] Consumer2 â¸ï¸ é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿›å…¥ç­‰å¾… (cCondition.await())... [16:14:14.5] Producer2 â–¶â–¶â–¶ å°è¯•è·å–é”... [16:14:14.501] Producer2 âœ… æˆåŠŸè·å–é” | å½“å‰é”çŠ¶æ€: java.util.concurrent.locks.ReentrantLock@363b2ca2[Locked by thread Producer2] [16:14:14.502] Producer2 ğŸ”” ç”Ÿäº§å®Œæˆï¼Œå”¤é†’æ¶ˆè´¹è€… (cCondition.signalAll()) [16:14:14.5] Producer1 â–¶â–¶â–¶ å°è¯•è·å–é”... [16:14:14.502] Consumer1 ğŸ”„ è¢«å”¤é†’ï¼Œé‡æ–°è·å–é” | å½“å‰é”çŠ¶æ€: java.util.concurrent.locks.ReentrantLock@363b2ca2[Locked by thread Consumer1] [16:14:14.502] Producer2 â¹ï¸ é‡Šæ”¾é” | å½“å‰é”çŠ¶æ€: java.util.concurrent.locks.ReentrantLock@363b2ca2[Unlocked] Producer [16:14:14.503] Consumer1 ğŸ”” æ¶ˆè´¹å®Œæˆï¼Œå”¤é†’ç”Ÿäº§è€… (pCondition.signalAll()) [16:14:14.504] Consumer2 ğŸ”„ è¢«å”¤é†’ï¼Œé‡æ–°è·å–é” | å½“å‰é”çŠ¶æ€: java.util.concurrent.locks.ReentrantLock@363b2ca2[Locked by thread Consumer2] [16:14:14.504] Consumer1 â¹ï¸ é‡Šæ”¾é” | å½“å‰é”çŠ¶æ€: java.util.concurrent.locks.ReentrantLock@363b2ca2[Unlocked] [16:14:14.504] Consumer2 â¸ï¸ é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿›å…¥ç­‰å¾… (cCondition.await())... å–åˆ°çš„å€¼-68 Customer [16:14:14.504] Producer1 âœ… æˆåŠŸè·å–é” | å½“å‰é”çŠ¶æ€: java.util.concurrent.locks.ReentrantLock@363b2ca2[Locked by thread Producer1] [16:14:14.505] Producer1 ğŸ”” ç”Ÿäº§å®Œæˆï¼Œå”¤é†’æ¶ˆè´¹è€… (cCondition.signalAll()) [16:14:14.505] Producer1 â¹ï¸ é‡Šæ”¾é” | å½“å‰é”çŠ¶æ€: java.util.concurrent.locks.ReentrantLock@363b2ca2[Unlocked] Producer [16:14:14.505] Consumer2 ğŸ”„ è¢«å”¤é†’ï¼Œé‡æ–°è·å–é” | å½“å‰é”çŠ¶æ€: java.util.concurrent.locks.ReentrantLock@363b2ca2[Locked by thread Consumer2] [16:14:14.506] Consumer2 ğŸ”” æ¶ˆè´¹å®Œæˆï¼Œå”¤é†’ç”Ÿäº§è€… (pCondition.signalAll()) [16:14:14.506] Consumer2 â¹ï¸ é‡Šæ”¾é” | å½“å‰é”çŠ¶æ€: java.util.concurrent.locks.ReentrantLock@363b2ca2[Unlocked] å–åˆ°çš„å€¼-83 ç–‘é—® ä¸€å¼€å§‹ç”±äºå¯¹è¿™å¿«å†…å®¹ä¸æ˜¯å¾ˆäº†è§£ï¼Œæˆ‘äº§ç”Ÿäº†2ä¸ªç–‘é—®ï¼Œ\nçº¿ç¨‹åªè¦è·å–é”ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹éƒ½å¾—ç­‰å¾…è·å–é”ï¼Œå¤šä¸ªçº¿ç¨‹åªç”¨ç«äº‰ä¸€æŠŠé”ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨conditionå‘¢ã€‚ çº¿ç¨‹åœ¨è·å–é”ä¹‹åï¼Œåªèƒ½ç­‰å¾…é”æ‰§è¡Œå®Œé‡Šæ”¾æ‰èƒ½é‡æ–°ç«äº‰åˆ°é”ï¼ŒåŠ äº†conditionç­‰å¾…å”¤é†’æœ‰ä»€ä¹ˆç”¨å‘¢ å¸¦ç€è¿™2ä¸ªç–‘é—®ï¼Œæˆ‘å»é—®äº†deepseekå’Œgrokä»¥åŠchatgptï¼Œé aiç»™æ€è·¯ï¼Œç„¶åå»çœ‹äº†ä»£ç ï¼Œç¡®è®¤äº†ä½¿ç”¨conditionçš„åˆç†æ€§å’Œå¿…è¦æ€§\né—®é¢˜1 å…ˆçœ‹çœ‹grokæ€ä¹ˆå›ç­”é—®é¢˜1çš„\nåªä½¿ç”¨lock\nå•ç‹¬ä½¿ç”¨ Lock é€šå¸¸ä¼šé€šè¿‡å¿™ç­‰å¾…ï¼ˆbusy-waitingï¼‰æˆ–ç®€å•çš„æ¡ä»¶æ£€æŸ¥æ¥æ¨¡æ‹Ÿç”Ÿäº§è€…-æ¶ˆè´¹è€…çš„åŒæ­¥\nLock lock = new ReentrantLock(); Queue\u003cInteger\u003e queue = new LinkedList\u003c\u003e(); int capacity = 10; public void put(int item) { lock.lock(); try { while (queue.size() \u003e= capacity) { lock.unlock(); // ä¸´æ—¶é‡Šæ”¾é” Thread.yield(); // è®©å‡º CPU lock.lock(); // é‡æ–°è·å–é” } queue.add(item); } finally { lock.unlock(); } } public void take() { lock.lock(); try { while (queue.isEmpty()) { lock.unlock(); Thread.yield(); lock.lock(); } queue.poll(); } finally { lock.unlock(); } } åªä½¿ç”¨lockï¼Œä¼šé¢‘ç¹åˆ¤æ–­æ¡ä»¶ï¼Œå†™å‡ºå¦‚ä¸Šçš„åŠ é”/é‡Šæ”¾é”çš„ä»£ç ï¼Œä»¥åŠè¦è®©å‡ºcpuï¼Œä¸å¤Ÿä¼˜é›…\nç»“åˆlock+condition\nä½¿ç”¨ Lock å’Œ Conditionï¼Œå¯ä»¥é€šè¿‡æ¡ä»¶å˜é‡ç²¾ç¡®æ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’\nLock lock = new ReentrantLock(); Condition pCondition = lock.newCondition(); Condition cCondition = lock.newCondition(); Queue\u003cInteger\u003e queue = new LinkedList\u003c\u003e(); int capacity = 10; public void produce(int item) { lock.lock(); try { while (queue.size() \u003e= capacity) { pCondition.await(); // ç­‰å¾…â€œéæ»¡â€æ¡ä»¶ } queue.add(item); cCondition.signal(); // å”¤é†’ç­‰å¾…â€œéç©ºâ€çš„æ¶ˆè´¹è€… } finally { lock.unlock(); } } public void consume() { lock.lock(); try { while (queue.isEmpty()) { cCondition.await(); // ç­‰å¾…â€œéç©ºâ€æ¡ä»¶ } queue.poll(); pCondition.signal(); // å”¤é†’ç­‰å¾…â€œéæ»¡â€çš„ç”Ÿäº§è€… } finally { lock.unlock(); } } lock+conditionï¼Œå¯ä»¥ç²¾å‡†æ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’\nä½¿ç”¨äº†2ä¸ªconditionï¼Œqueueæ»¡äº†pConditionå°±ç­‰å¾…ï¼Œæš‚åœç”Ÿäº§ï¼Œqueueç©ºäº†cConditionå°±ç­‰å¾…ï¼Œæš‚åœæ¶ˆè´¹\nç”Ÿäº§ä¹‹åï¼Œ é‡Šæ”¾ä¿¡å·ï¼Œå”¤é†’cConditionå»æ¶ˆè´¹ï¼Œæ¶ˆè´¹ä¹‹åï¼Œå”¤é†’pConditionå»ç”Ÿäº§\n2ç§å®ç°æ–¹å¼ä¼˜ç¼ºç‚¹æ¯”è¾ƒ\nç‰¹æ€§ åªä½¿ç”¨ Lock ä½¿ç”¨ Lock + Condition çº¿ç¨‹é€šçŸ¥ æ— æ³•ç²¾ç¡®é€šçŸ¥ï¼Œä¾èµ–è½®è¯¢ ç²¾ç¡®é€šçŸ¥ï¼Œé€šè¿‡ signal() å”¤é†’ æ•ˆç‡ å¿™ç­‰å¾…æˆ–é¢‘ç¹é”åˆ‡æ¢ï¼Œæ•ˆç‡ä½ çº¿ç¨‹æŒ‚èµ·ï¼Œæ— å¿™ç­‰å¾…ï¼Œæ•ˆç‡é«˜ é”ç«äº‰ é«˜ï¼Œå¯èƒ½åå¤é‡Šæ”¾å’Œè·å–é” ä½ï¼Œå”¤é†’åé˜Ÿåˆ—å¼è·å–é” ä»£ç å¤æ‚åº¦ é«˜ï¼Œæ‰‹åŠ¨å®ç°ç­‰å¾…é€»è¾‘ ä½ï¼ŒAPI ç®€æ´ä¸”åŠŸèƒ½å¼ºå¤§ æ¡ä»¶åŒºåˆ† æ— æ³•åŒºåˆ†ä¸åŒæ¡ä»¶ æ”¯æŒå¤šä¸ª Condition å¯¹è±¡ ä¸­æ–­å¤„ç† æ‰‹åŠ¨æ£€æŸ¥å’Œå¤„ç† å†…ç½®æ”¯æŒï¼ŒæŠ›å‡ºå¼‚å¸¸ é€šè¿‡ä»¥ä¸Šçš„ä¼˜ç¼ºç‚¹æ¯”è¾ƒï¼Œå¯ä»¥çœ‹åˆ°å•ç‹¬ä½¿ç”¨lockï¼Œæœ‰ä»¥ä¸‹ç¼ºç‚¹\nç¼ºä¹ç²¾ç¡®çš„çº¿ç¨‹é€šçŸ¥æœºåˆ¶ æ•ˆç‡ä½ä¸‹ï¼Œå¿™ç­‰å¾…æˆ–é”åˆ‡æ¢å¼€é”€å¤§ã€‚ æ›´é«˜çš„é”ç«äº‰å’Œå»¶è¿Ÿã€‚ ä»£ç å¤æ‚ä¸”ä¸å¤Ÿä¼˜é›…ã€‚ æ— æ³•åŒºåˆ†ä¸åŒç­‰å¾…æ¡ä»¶ã€‚ ä¸­æ–­å¤„ç†å›°éš¾ã€‚ åœ¨å®é™…çš„ç”Ÿäº§åœºæ™¯ç§\nå‡è®¾ä¸€ä¸ªé«˜å¹¶å‘ç”Ÿäº§è€…-æ¶ˆè´¹è€…ç³»ç»Ÿï¼š\nåªä½¿ç”¨ Lock ç¼“å†²åŒºæ»¡æ—¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹ä¸æ–­è½®è¯¢ï¼Œæµªè´¹ CPUã€‚ æ¶ˆè´¹è€…è¢«å”¤é†’åå¯èƒ½å‘ç°ç¼“å†²åŒºä»ç©ºï¼ˆå…¶ä»–æ¶ˆè´¹è€…æŠ¢å…ˆæ¶ˆè´¹ï¼‰ï¼Œéœ€è¦å†æ¬¡ç­‰å¾…ã€‚ ç³»ç»Ÿååé‡ä½ï¼Œå»¶è¿Ÿé«˜ã€‚ ä½¿ç”¨ Lock + Condition ç”Ÿäº§è€…ç­‰å¾… pConditionï¼Œæ¶ˆè´¹è€…ç­‰å¾… cConditionï¼Œäº’ä¸å¹²æ‰°ã€‚ ç”Ÿäº§è€…æ”¾å…¥æ•°æ®ååªå”¤é†’æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…ç§»é™¤æ•°æ®ååªå”¤é†’ç”Ÿäº§è€…ã€‚ ç³»ç»Ÿé«˜æ•ˆè¿è¡Œï¼Œèµ„æºåˆ©ç”¨ç‡é«˜ã€‚ é—®é¢˜2 å†çœ‹çœ‹é—®é¢˜2çš„å›ç­”\nè·å–conditionä½¿ç”¨çš„æ˜¯lockçš„apiï¼Œè¿”å›çš„æ˜¯å®šä¹‰åœ¨aqsä¸­çš„conditionobject\nprivate ReentrantLock lock = new ReentrantLock(); private Condition pCondition = lock.newCondition(); private Condition cCondition = lock.newCondition(); è°ƒç”¨pCondition.await(); å®é™…æ˜¯è°ƒç”¨äº†java.util.concurrent.locks.AbstractQueuedSynchronizer.ConditionObject#await()\næˆ‘å°†aqsçš„æ–¹æ³•ä»£ç ï¼Œå–‚ç»™äº†grokï¼Œè®©grokå¸®æˆ‘åˆ†ææ–¹æ³•å®ç°çš„ç»†èŠ‚\n/** * å®ç°å¯ä¸­æ–­çš„æ¡ä»¶ç­‰å¾…ã€‚ * * å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡º InterruptedException å¼‚å¸¸ã€‚ * ä¿å­˜ç”± {@link #getState} è¿”å›çš„é”çŠ¶æ€ã€‚ * ä½¿ç”¨ä¿å­˜çš„çŠ¶æ€ä½œä¸ºå‚æ•°è°ƒç”¨ {@link #release} æ–¹æ³•ï¼Œ * å¦‚æœå¤±è´¥åˆ™æŠ›å‡º IllegalMonitorStateException å¼‚å¸¸ã€‚ * é˜»å¡ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–è¢«ä¸­æ–­ã€‚ * é€šè¿‡è°ƒç”¨ {@link #acquire} çš„ç‰¹å®šç‰ˆæœ¬ï¼Œå¹¶ä¼ å…¥ä¿å­˜çš„çŠ¶æ€ä½œä¸ºå‚æ•°æ¥é‡æ–°è·å–é”ã€‚ * å¦‚æœåœ¨ç¬¬ 4 æ­¥é˜»å¡æ—¶è¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡º InterruptedException å¼‚å¸¸ã€‚ * */ /** * Implements interruptible condition wait. * * If current thread is interrupted, throw InterruptedException. * Save lock state returned by {@link #getState}. * Invoke {@link #release} with saved state as argument, * throwing IllegalMonitorStateException if it fails. * Block until signalled or interrupted. * Reacquire by invoking specialized version of * {@link #acquire} with saved state as argument. * If interrupted while blocked in step 4, throw InterruptedException. * */ public final void await() throws InterruptedException { if (Thread.interrupted()) throw new InterruptedException(); Node node = addConditionWaiter(); //é‡Šæ”¾é” int savedState = fullyRelease(node); int interruptMode = 0; while (!isOnSyncQueue(node)) { LockSupport.park(this); if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break; } if (acquireQueued(node, savedState) \u0026\u0026 interruptMode != THROW_IE) interruptMode = REINTERRUPT; if (node.nextWaiter != null) // clean up if cancelled unlinkCancelledWaiters(); if (interruptMode != 0) reportInterruptAfterWait(interruptMode); } grokå¸®æˆ‘æ€»ç»“å‡ºäº†å¦‚ä¸‹é‡ç‚¹\né”çš„é‡Šæ”¾ï¼š åœ¨ fullyRelease(node) ä¸­é‡Šæ”¾é”ã€‚ å‘ç”Ÿåœ¨ç­‰å¾…ä¹‹å‰ï¼Œç¡®ä¿çº¿ç¨‹åœ¨æŒ‚èµ·æ—¶ä¸æŒæœ‰é”ã€‚ ç­‰å¾…é”çš„åœ°æ–¹ï¼š åœ¨ while (!isOnSyncQueue(node)) å¾ªç¯ä¸­ï¼Œé€šè¿‡ LockSupport.park(this) æŒ‚èµ·çº¿ç¨‹ã€‚ ç­‰å¾…æ¡ä»¶æ˜¯ node è¢«è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ï¼ˆç”± signal() è§¦å‘ï¼‰æˆ–è¢«ä¸­æ–­ã€‚ è·å–é”åçš„æ¢å¤ï¼š åœ¨ acquireQueued(node, savedState) ä¸­é‡æ–°ç«äº‰å¹¶è·å–é”ã€‚ ä½¿ç”¨ä¿å­˜çš„ savedState æ¢å¤é”çš„çŠ¶æ€ï¼ˆä¾‹å¦‚é‡å…¥æ¬¡æ•°ï¼‰ã€‚ è·å–é”åï¼Œå¤„ç†å¯èƒ½çš„æ¸…ç†å’Œä¸­æ–­é€»è¾‘ã€‚ é”çš„æµç¨‹å¦‚ä¸‹ æŒæœ‰é” â†“ æ£€æŸ¥ä¸­æ–­ â†’ ä¸­æ–­æŠ›å¼‚å¸¸é€€å‡º â†“ åˆ›å»ºç­‰å¾…èŠ‚ç‚¹ â†“ é‡Šæ”¾é” (fullyRelease) â†“ å¾ªç¯ç­‰å¾… (LockSupport.park) â†“ è¢«å”¤é†’/ä¸­æ–­ â†’ æ£€æŸ¥ä¸­æ–­çŠ¶æ€ â†“ é‡æ–°è·å–é” (acquireQueued) â†“ æ¸…ç†å–æ¶ˆèŠ‚ç‚¹ â†“ å¤„ç†ä¸­æ–­ â†“ è¿”å› (æŒæœ‰é”) ä¹Ÿå°±æ˜¯è¯´åœ¨è¿™è¡Œä»£ç  int savedState = fullyRelease(node);ä¼šé‡Šæ”¾æ‰é”\nè¯¦ç»†çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯aqsæä¾›çš„java.util.concurrent.locks.AbstractQueuedSynchronizer#fullyRelease\n/** * ä½¿ç”¨å½“å‰çŠ¶æ€å€¼è°ƒç”¨ release æ–¹æ³•ï¼Œå¹¶è¿”å›ä¿å­˜çš„çŠ¶æ€ã€‚ * è‹¥æ“ä½œå¤±è´¥ï¼Œåˆ™å–æ¶ˆèŠ‚ç‚¹å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ * @param node ç­‰å¾…ä¸­çš„æ¡ä»¶èŠ‚ç‚¹ * @return å…ˆå‰çš„åŒæ­¥çŠ¶æ€ */ /** * Invokes release with current state value; returns saved state. * Cancels node and throws exception on failure. * @param node the condition node for this wait * @return previous sync state */ final int fullyRelease(Node node) { boolean failed = true; try { int savedState = getState(); if (release(savedState)) { failed = false; return savedState; } else { throw new IllegalMonitorStateException(); } } finally { if (failed) node.waitStatus = Node.CANCELLED; } } ä¼šåœ¨ifæ¡ä»¶é‡Œæ‰§è¡Œjava.util.concurrent.locks.AbstractQueuedSynchronizer#releaseæ–¹æ³•ï¼Œå°è¯•é‡Šæ”¾é”\n/** * ä»¥ç‹¬å æ¨¡å¼é‡Šæ”¾é”ã€‚è‹¥ {@link #tryRelease} è¿”å› trueï¼Œåˆ™å”¤é†’ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ã€‚ * æ­¤æ–¹æ³•å¯ç”¨äºå®ç° {@link Lock#unlock}ã€‚ * * @param arg é‡Šæ”¾å‚æ•°ï¼Œè¯¥å€¼ä¼šä¼ é€’ç»™ {@link #tryRelease}ï¼Œä½†ä¸ä¼šè¢«é¢å¤–è§£é‡Šï¼Œå¯ç”¨äºè¡¨ç¤ºä»»æ„å«ä¹‰ã€‚ * @return {@link #tryRelease} æ–¹æ³•çš„è¿”å›å€¼ã€‚ */ /** * Releases in exclusive mode. Implemented by unblocking one or * more threads if {@link #tryRelease} returns true. * This method can be used to implement method {@link Lock#unlock}. * * @param arg the release argument. This value is conveyed to * {@link #tryRelease} but is otherwise uninterpreted and * can represent anything you like. * @return the value returned from {@link #tryRelease} */ @ReservedStackAccess public final boolean release(int arg) { if (tryRelease(arg)) { Node h = head; if (h != null \u0026\u0026 h.waitStatus != 0) unparkSuccessor(h); return true; } return false; } æœ€ç»ˆæ‰§è¡Œjava.util.concurrent.locks.AbstractQueuedSynchronizer#tryReleaseè¿›è¡Œé‡Šæ”¾ï¼Œç”±å­ç±»å®šä¹‰å…·ä½“çš„é‡Šæ”¾é€»è¾‘ï¼Œè¿™ä¸ªåœºæ™¯ä¸‹æœ€ç»ˆè°ƒç”¨java.util.concurrent.locks.ReentrantReadWriteLock.Sync#tryReleaseè¿›è¡Œçš„é‡Šæ”¾é€»è¾‘\nè¿™ä¹ˆçœ‹ä¸‹æ¥ï¼Œæ‰§è¡Œjava.util.concurrent.locks.Condition#await()ä¼šå°†æŒæœ‰çš„é”é‡Šæ”¾æ‰ï¼Œé‡Šæ”¾æ‰é”ä¹‹åï¼Œå…¶ä»–ç­‰å¾…è·å–é”çš„çº¿ç¨‹å¯ä»¥å°è¯•è·å–é”ï¼Œæ‹¿åˆ°é”ä¹‹åå°è¯•è¿›è¡Œç”Ÿäº§æˆ–è€…æ¶ˆè´¹\nå‡å¦‚æ‰§è¡Œåˆ°java.util.concurrent.locks.Condition#signalAllï¼Œé‚£ä¹ˆä¼šå‘é€šçŸ¥ç­‰å¾…åœ¨pConditionæˆ–cConditionä¸Šçš„çº¿ç¨‹ï¼Œå”¤é†’ç­‰å¾…ï¼Œå°è¯•è·å–é”ï¼Œåœ¨put()æˆ–take()finallyé‡Œï¼Œæœ€ç»ˆä¼šé‡Šæ”¾é”ï¼Œå¯¹åº”çš„conditionè¢«å”¤é†’ï¼Œå°è¯•é‡æ–°è·å–é”ã€‚\nåªæœ‰è¿™æ ·åœ¨awaitä¼šé‡Šæ”¾é”ï¼Œlock+conditionçš„ç»„åˆæ‰ä¼šæœ‰æ„ä¹‰ã€‚\næ€»ç»“ lock+conditionç»“åˆï¼Œå¯ä»¥å®ç°ç²¾å‡†æ§åˆ¶ï¼Œå‡†ç¡®é€šçŸ¥çº¿ç¨‹ï¼Œé™ä½é”ç«äº‰å’Œèµ„æºæ¶ˆè€—ï¼Œå®ç°å¹¶å‘çš„ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹\nå…¶ä»– ä»¥å‰æœ‰é—®é¢˜ï¼Œåªèƒ½é æœç´¢å¼•æ“ç»™ç­”æ¡ˆï¼Œç°åœ¨æœ‰äº†aiä¹‹åï¼Œå¯ä»¥å‘aiæé—®ï¼Œaiå¯ä»¥ç»™ä½ åšè¯¦ç»†çš„è§£é‡Šï¼Œä¹Ÿä¸ç”¨è‡ªå·±è‹¦å“ˆå“ˆçš„çœ‹å’Œç†è§£äº†ã€‚\né‡åˆ°ä¸æ‡‚çš„ï¼Œaièƒ½ç»™ä½ åšè¯¦ç»†è§£é‡Šï¼Œå¼€å‘çš„å­¦ä¹ æˆæœ¬ç¡®å®é™ä½äº†\nä½†æ˜¯aiæµªæ½®å¸­å·ä¸‹ï¼Œç¡…åŸºå¦‚ä½•å¹²ç¢ç¢³åŸºï¼Œå¯èƒ½å¾ˆå¿«å°±ä¼šæ¥ä¸´äº†ã€‚\nç°åœ¨å°±æ˜¯aiäººç±»åŒ–ï¼Œäººç±»aiåŒ–ï¼ŒçœŸçš„æŠ½è±¡\n","wordCount":"4576","inLanguage":"zh","datePublished":"2025-02-27T15:52:52+08:00","dateModified":"2025-02-27T15:52:52+08:00","author":{"@type":"Person","name":"since"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.thend03.com/posts/tech/java-producer-consumer-model/"},"publisher":{"@type":"Organization","name":"ç«™åœ¨æµ·è¾¹çœ‹è¿œæ–¹","logo":{"@type":"ImageObject","url":"https://blog.thend03.com/img/logo.jpg"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.thend03.com/ accesskey=h title="thend03 (Alt + H)"><img src=https://blog.thend03.com/img/logo.jpg alt=logo aria-label=logo height=35>thend03</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://blog.thend03.com/search title="ğŸ” æœç´¢ (Alt + /)" accesskey=/><span>ğŸ” æœç´¢</span></a></li><li><a href=https://blog.thend03.com/ title="ğŸ  ä¸»é¡µ"><span>ğŸ  ä¸»é¡µ</span></a></li><li><a href=https://blog.thend03.com/archives/ title="â±ï¸ å½’æ¡£"><span>â±ï¸ å½’æ¡£</span></a></li><li><a href=https://blog.thend03.com/tags title="ğŸ§© æ ‡ç­¾"><span>ğŸ§© æ ‡ç­¾</span></a></li><li><a href=https://blog.thend03.com/about title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº"><span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span></a></li><li><a href=https://blog.thend03.com/links title="ğŸ¤ å‹é“¾"><span>ğŸ¤ å‹é“¾</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div class=post-password></div><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://blog.thend03.com/>ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://blog.thend03.com/posts/>ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href=https://blog.thend03.com/posts/tech/>ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div><h1 class=post-title>Javaå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2025-02-27
&nbsp;&nbsp;
</span></span><span id=post_meta_style_2><span class="fa fa-calendar-plus-o"></span>
<span>&nbsp;æ›´æ–°äº&nbsp;2025-02-27
&nbsp;|&nbsp;
</span></span><span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>4576å­—
&nbsp;&nbsp;
</span></span><span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>10åˆ†é’Ÿ
&nbsp;&nbsp;
</span></span><span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>since
&nbsp;&nbsp;
</span></span><span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta><a href=https://blog.thend03.com/tags/java/ style=color:var(--secondary)!important>Java</a>
&nbsp;<a href=https://blog.thend03.com/tags/juc/ style=color:var(--secondary)!important>Juc</a>
</span></span></span></span><span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;
</span></span><span id=post_meta_style_8><span class="fa fa-commenting-o"></span>
<span><script src=https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js></script><script>let url=document.documentURI,dnsUrl="https://blog.thend03.com/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=="/"&&(finalUrl="/"+finalUrl),twikoo.getCommentsCount({envId:"https://twikoo-e1f2-2yfafx14j-thend03s-projects.vercel.app/",region:null,urls:[finalUrl],includeReply:!1}).then(function(e){let t=e[0].count;const n=document.getElementById("comment_count");n.innerText=t}).catch(function(e){console.error(e)})</script><span id=comment_count></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e6%a1%88%e4%be%8b aria-label=æ¡ˆä¾‹>æ¡ˆä¾‹</a></li><li><a href=#%e5%88%86%e6%9e%90 aria-label=åˆ†æ>åˆ†æ</a><ul><li><a href=#%e4%bb%a3%e7%a0%81%e6%b5%8b%e8%af%95 aria-label=ä»£ç æµ‹è¯•>ä»£ç æµ‹è¯•</a></li><li><a href=#%e7%96%91%e9%97%ae aria-label=ç–‘é—®>ç–‘é—®</a><ul><li><a href=#%e9%97%ae%e9%a2%981 aria-label=é—®é¢˜1>é—®é¢˜1</a></li><li><a href=#%e9%97%ae%e9%a2%982 aria-label=é—®é¢˜2>é—®é¢˜2</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=æ€»ç»“>æ€»ç»“</a></li></ul></li><li><a href=#%e5%85%b6%e4%bb%96 aria-label=å…¶ä»–>å…¶ä»–</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{elements&&(activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=æ¡ˆä¾‹>æ¡ˆä¾‹<a hidden class=anchor aria-hidden=true href=#æ¡ˆä¾‹>#</a></h2><p>Javaå¹¶å‘çš„æ—¶å€™ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªå…³äºç”Ÿäº§è€…æ¶ˆè´¹è€…çš„æ¡ˆä¾‹</p><p>ä¸€ä¸ªproducerç±»å’Œä¸€ä¸ªconsumerç±»ï¼Œå®ç°äº†Runnableæ¥å£ï¼Œä½œä¸ºçº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡</p><p>ä¸€ä¸ªQueueç±»ï¼Œå®ç°äº†queueçš„put()å’Œtakeæ“ä½œï¼Œæ¨¡æ‹Ÿäº†ç”Ÿäº§å’Œæ¶ˆè´¹2ä¸ªåŠ¨ä½œ</p><p>å®ç°æ–¹å¼ä½¿ç”¨äº†ReentrantLock+Condition</p><p>è¿™ä¸ªç¤ºä¾‹ä»£ç çš„è¯ï¼Œæ˜¯å¯ä»¥å®ç°å¤šçº¿ç¨‹ä¹‹é—´å¹¶å‘ç”Ÿäº§å’Œæ¶ˆè´¹çš„ï¼Œå¤šä¸ªçº¿ç¨‹å…±åŒæ“ä½œä¸€ä¸ªQueueå¯¹è±¡ï¼Œå¯ä»¥å®ç°é˜Ÿåˆ—æ»¡æ—¶ç”Ÿäº§ç­‰å¾…ï¼Œé˜Ÿåˆ—ç©ºæ—¶æ¶ˆè´¹ç­‰å¾…ï¼Œä¸”æ— å¹¶å‘é—®é¢˜ã€‚</p><p><strong>æˆ‘å½“æ—¶äº§ç”Ÿçš„ç–‘é—®æ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨äº†ReentrantLockï¼Œè¿˜è¦ä½¿ç”¨Condition</strong></p><p>è¿™ä¸ªé—®é¢˜ä¸‹ä¸€ä¸ªç« èŠ‚å†è¯´ï¼Œå…ˆè´´ä¸‹ç¤ºä¾‹ä»£ç </p><p>Producer</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Producer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Queue</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Producer</span><span class=p>(</span><span class=n>Queue</span><span class=w> </span><span class=n>queue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>threadName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// éš”10ç§’è½®è¯¢ç”Ÿäº§ä¸€æ¬¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Producer&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>queue</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>100</span><span class=p>),</span><span class=n>threadName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Consumer</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Consumer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Queue</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Consumer</span><span class=p>(</span><span class=n>Queue</span><span class=w> </span><span class=n>queue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>threadName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// éš”3ç§’è½®è¯¢æ¶ˆè´¹ä¸€æ¬¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Customer&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å–åˆ°çš„å€¼-&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=na>take</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Queue</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Queue</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>arr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>int</span><span class=o>[</span><span class=n>5</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>putIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>  </span><span class=c1>// ç”Ÿäº§ä½ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>takeIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=c1>// æ¶ˆè´¹ä½ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>pCondition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>cCondition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isEmpty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>size</span><span class=o>==</span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isFull</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>size</span><span class=o>==</span><span class=n>5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; â–¶â–¶â–¶ å°è¯•è·å–é”...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; âœ… æˆåŠŸè·å–é” | å½“å‰é”çŠ¶æ€: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isFull</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; â¸ï¸ é˜Ÿåˆ—å·²æ»¡ï¼Œè¿›å…¥ç­‰å¾… (pCondition.await())...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pCondition</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w> </span><span class=c1>// è‡ªåŠ¨é‡Šæ”¾é”ï¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; ğŸ”„ è¢«å”¤é†’ï¼Œé‡æ–°è·å–é” | å½“å‰é”çŠ¶æ€: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>arr</span><span class=o>[</span><span class=n>putIndex</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>putIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>putIndex</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>arr</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>size</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ç”Ÿäº§é€»è¾‘...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; ğŸ”” ç”Ÿäº§å®Œæˆï¼Œå”¤é†’æ¶ˆè´¹è€… (cCondition.signalAll())&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>cCondition</span><span class=p>.</span><span class=na>signalAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; â¹ï¸ é‡Šæ”¾é” | å½“å‰é”çŠ¶æ€: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>take</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>threadName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>(</span><span class=n>threadName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; â–¶â–¶â–¶ å°è¯•è·å–é”...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>(</span><span class=n>threadName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; âœ… æˆåŠŸè·å–é” | å½“å‰é”çŠ¶æ€: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>(</span><span class=n>threadName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; â¸ï¸ é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿›å…¥ç­‰å¾… (cCondition.await())...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cCondition</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w> </span><span class=c1>// è‡ªåŠ¨é‡Šæ”¾é”ï¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>(</span><span class=n>threadName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; ğŸ”„ è¢«å”¤é†’ï¼Œé‡æ–°è·å–é” | å½“å‰é”çŠ¶æ€: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arr</span><span class=o>[</span><span class=n>takeIndex</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>arr</span><span class=o>[</span><span class=n>takeIndex</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>  </span><span class=c1>// å¯é€‰ï¼šæ¸…ç†æ•°æ®ä»¥ä¾¿è°ƒè¯•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>takeIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>takeIndex</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>arr</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>size</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>(</span><span class=n>threadName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; ğŸ”” æ¶ˆè´¹å®Œæˆï¼Œå”¤é†’ç”Ÿäº§è€… (pCondition.signalAll())&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>pCondition</span><span class=p>.</span><span class=na>signalAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>(</span><span class=n>threadName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; â¹ï¸ é‡Šæ”¾é” | å½“å‰é”çŠ¶æ€: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>log</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=s>&#34;[%s] %s%n&#34;</span><span class=p>,</span><span class=w> </span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>().</span><span class=na>format</span><span class=p>(</span><span class=n>DateTimeFormatter</span><span class=p>.</span><span class=na>ISO_LOCAL_TIME</span><span class=p>),</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=åˆ†æ>åˆ†æ<a hidden class=anchor aria-hidden=true href=#åˆ†æ>#</a></h2><h3 id=ä»£ç æµ‹è¯•>ä»£ç æµ‹è¯•<a hidden class=anchor aria-hidden=true href=#ä»£ç æµ‹è¯•>#</a></h3><p>é¦–å…ˆå†™äº†ä¸ªæµ‹è¯•ç±»ï¼Œæµ‹è¯•äº†ä¸€ä¸‹ç”Ÿäº§æ¶ˆè´¹é€»è¾‘, 2ä¸ªç”Ÿäº§è€…ï¼Œ2ä¸ªæ¶ˆè´¹è€…ï¼Œå…±4ä¸ªçº¿ç¨‹ï¼Œæ“ä½œåŒä¸€ä¸ªqueueï¼Œå®ç°ç”Ÿäº§æ¶ˆè´¹é€»è¾‘</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¸¤ä¸ªç”Ÿäº§è€…ï¼Œä¸¤ä¸ªæ¶ˆè´¹è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Queue</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Queue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>producer1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Producer</span><span class=p>(</span><span class=n>queue</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>producer1</span><span class=p>.</span><span class=na>setName</span><span class=p>(</span><span class=s>&#34;Producer1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>producer1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>producer2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Producer</span><span class=p>(</span><span class=n>queue</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>producer2</span><span class=p>.</span><span class=na>setName</span><span class=p>(</span><span class=s>&#34;Producer2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>producer2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>Consumer1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Consumer</span><span class=p>(</span><span class=n>queue</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Consumer1</span><span class=p>.</span><span class=na>setName</span><span class=p>(</span><span class=s>&#34;Consumer1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Consumer1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>Consumer2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Consumer</span><span class=p>(</span><span class=n>queue</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Consumer2</span><span class=p>.</span><span class=na>setName</span><span class=p>(</span><span class=s>&#34;Consumer2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Consumer2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>æ§åˆ¶å°éƒ¨åˆ†è¾“å‡ºå†…å®¹å¦‚ä¸‹</p><p>è¾“å‡ºå†…å®¹å±•ç¤ºäº†å°è¯•è·å–é”&mdash;->è·å–é”æˆåŠŸ&mdash;->ç­‰å¾…&mdash;->é‡Šæ”¾é”&mdash;->è¢«å”¤é†’&mdash;->é‡æ–°è·å–é”&mdash;->ç”Ÿäº§/æ¶ˆè´¹å®Œæˆå¹¶å”¤é†’ç­‰å¾…çš„çº¿ç¨‹&mdash;->é‡Šæ”¾é”çš„è¿™ä¹ˆä¸€ä¸ªè¿‡ç¨‹</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>07</span><span class=p>.</span><span class=na>504</span><span class=o>]</span><span class=w> </span><span class=n>Consumer1</span><span class=w> </span><span class=err>â–¶â–¶â–¶</span><span class=w> </span><span class=n>å°è¯•è·å–é”</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>07</span><span class=p>.</span><span class=na>504</span><span class=o>]</span><span class=w> </span><span class=n>Consumer2</span><span class=w> </span><span class=err>â–¶â–¶â–¶</span><span class=w> </span><span class=n>å°è¯•è·å–é”</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>07</span><span class=p>.</span><span class=na>516</span><span class=o>]</span><span class=w> </span><span class=n>Consumer1</span><span class=w> </span><span class=err>âœ…</span><span class=w> </span><span class=n>æˆåŠŸè·å–é”</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>å½“å‰é”çŠ¶æ€</span><span class=p>:</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>ReentrantLock</span><span class=nd>@363b2ca2</span><span class=o>[</span><span class=n>Locked</span><span class=w> </span><span class=n>by</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>Consumer1</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>07</span><span class=p>.</span><span class=na>516</span><span class=o>]</span><span class=w> </span><span class=n>Consumer1</span><span class=w> </span><span class=err>â¸</span><span class=n>ï¸</span><span class=w> </span><span class=n>é˜Ÿåˆ—ä¸ºç©º</span><span class=err>ï¼Œ</span><span class=n>è¿›å…¥ç­‰å¾…</span><span class=w> </span><span class=p>(</span><span class=n>cCondition</span><span class=p>.</span><span class=na>await</span><span class=p>())...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>07</span><span class=p>.</span><span class=na>516</span><span class=o>]</span><span class=w> </span><span class=n>Consumer2</span><span class=w> </span><span class=err>âœ…</span><span class=w> </span><span class=n>æˆåŠŸè·å–é”</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>å½“å‰é”çŠ¶æ€</span><span class=p>:</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>ReentrantLock</span><span class=nd>@363b2ca2</span><span class=o>[</span><span class=n>Locked</span><span class=w> </span><span class=n>by</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>Consumer2</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>07</span><span class=p>.</span><span class=na>516</span><span class=o>]</span><span class=w> </span><span class=n>Consumer2</span><span class=w> </span><span class=err>â¸</span><span class=n>ï¸</span><span class=w> </span><span class=n>é˜Ÿåˆ—ä¸ºç©º</span><span class=err>ï¼Œ</span><span class=n>è¿›å…¥ç­‰å¾…</span><span class=w> </span><span class=p>(</span><span class=n>cCondition</span><span class=p>.</span><span class=na>await</span><span class=p>())...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>5</span><span class=o>]</span><span class=w> </span><span class=n>Producer2</span><span class=w> </span><span class=err>â–¶â–¶â–¶</span><span class=w> </span><span class=n>å°è¯•è·å–é”</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>501</span><span class=o>]</span><span class=w> </span><span class=n>Producer2</span><span class=w> </span><span class=err>âœ…</span><span class=w> </span><span class=n>æˆåŠŸè·å–é”</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>å½“å‰é”çŠ¶æ€</span><span class=p>:</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>ReentrantLock</span><span class=nd>@363b2ca2</span><span class=o>[</span><span class=n>Locked</span><span class=w> </span><span class=n>by</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>Producer2</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>502</span><span class=o>]</span><span class=w> </span><span class=n>Producer2</span><span class=w> </span><span class=err>ğŸ””</span><span class=w> </span><span class=n>ç”Ÿäº§å®Œæˆ</span><span class=err>ï¼Œ</span><span class=n>å”¤é†’æ¶ˆè´¹è€…</span><span class=w> </span><span class=p>(</span><span class=n>cCondition</span><span class=p>.</span><span class=na>signalAll</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>5</span><span class=o>]</span><span class=w> </span><span class=n>Producer1</span><span class=w> </span><span class=err>â–¶â–¶â–¶</span><span class=w> </span><span class=n>å°è¯•è·å–é”</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>502</span><span class=o>]</span><span class=w> </span><span class=n>Consumer1</span><span class=w> </span><span class=err>ğŸ”„</span><span class=w> </span><span class=n>è¢«å”¤é†’</span><span class=err>ï¼Œ</span><span class=n>é‡æ–°è·å–é”</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>å½“å‰é”çŠ¶æ€</span><span class=p>:</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>ReentrantLock</span><span class=nd>@363b2ca2</span><span class=o>[</span><span class=n>Locked</span><span class=w> </span><span class=n>by</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>Consumer1</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>502</span><span class=o>]</span><span class=w> </span><span class=n>Producer2</span><span class=w> </span><span class=err>â¹</span><span class=n>ï¸</span><span class=w> </span><span class=n>é‡Šæ”¾é”</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>å½“å‰é”çŠ¶æ€</span><span class=p>:</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>ReentrantLock</span><span class=nd>@363b2ca2</span><span class=o>[</span><span class=n>Unlocked</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Producer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>503</span><span class=o>]</span><span class=w> </span><span class=n>Consumer1</span><span class=w> </span><span class=err>ğŸ””</span><span class=w> </span><span class=n>æ¶ˆè´¹å®Œæˆ</span><span class=err>ï¼Œ</span><span class=n>å”¤é†’ç”Ÿäº§è€…</span><span class=w> </span><span class=p>(</span><span class=n>pCondition</span><span class=p>.</span><span class=na>signalAll</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>504</span><span class=o>]</span><span class=w> </span><span class=n>Consumer2</span><span class=w> </span><span class=err>ğŸ”„</span><span class=w> </span><span class=n>è¢«å”¤é†’</span><span class=err>ï¼Œ</span><span class=n>é‡æ–°è·å–é”</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>å½“å‰é”çŠ¶æ€</span><span class=p>:</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>ReentrantLock</span><span class=nd>@363b2ca2</span><span class=o>[</span><span class=n>Locked</span><span class=w> </span><span class=n>by</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>Consumer2</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>504</span><span class=o>]</span><span class=w> </span><span class=n>Consumer1</span><span class=w> </span><span class=err>â¹</span><span class=n>ï¸</span><span class=w> </span><span class=n>é‡Šæ”¾é”</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>å½“å‰é”çŠ¶æ€</span><span class=p>:</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>ReentrantLock</span><span class=nd>@363b2ca2</span><span class=o>[</span><span class=n>Unlocked</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>504</span><span class=o>]</span><span class=w> </span><span class=n>Consumer2</span><span class=w> </span><span class=err>â¸</span><span class=n>ï¸</span><span class=w> </span><span class=n>é˜Ÿåˆ—ä¸ºç©º</span><span class=err>ï¼Œ</span><span class=n>è¿›å…¥ç­‰å¾…</span><span class=w> </span><span class=p>(</span><span class=n>cCondition</span><span class=p>.</span><span class=na>await</span><span class=p>())...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>å–åˆ°çš„å€¼</span><span class=o>-</span><span class=n>68</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Customer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>504</span><span class=o>]</span><span class=w> </span><span class=n>Producer1</span><span class=w> </span><span class=err>âœ…</span><span class=w> </span><span class=n>æˆåŠŸè·å–é”</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>å½“å‰é”çŠ¶æ€</span><span class=p>:</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>ReentrantLock</span><span class=nd>@363b2ca2</span><span class=o>[</span><span class=n>Locked</span><span class=w> </span><span class=n>by</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>Producer1</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>505</span><span class=o>]</span><span class=w> </span><span class=n>Producer1</span><span class=w> </span><span class=err>ğŸ””</span><span class=w> </span><span class=n>ç”Ÿäº§å®Œæˆ</span><span class=err>ï¼Œ</span><span class=n>å”¤é†’æ¶ˆè´¹è€…</span><span class=w> </span><span class=p>(</span><span class=n>cCondition</span><span class=p>.</span><span class=na>signalAll</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>505</span><span class=o>]</span><span class=w> </span><span class=n>Producer1</span><span class=w> </span><span class=err>â¹</span><span class=n>ï¸</span><span class=w> </span><span class=n>é‡Šæ”¾é”</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>å½“å‰é”çŠ¶æ€</span><span class=p>:</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>ReentrantLock</span><span class=nd>@363b2ca2</span><span class=o>[</span><span class=n>Unlocked</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Producer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>505</span><span class=o>]</span><span class=w> </span><span class=n>Consumer2</span><span class=w> </span><span class=err>ğŸ”„</span><span class=w> </span><span class=n>è¢«å”¤é†’</span><span class=err>ï¼Œ</span><span class=n>é‡æ–°è·å–é”</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>å½“å‰é”çŠ¶æ€</span><span class=p>:</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>ReentrantLock</span><span class=nd>@363b2ca2</span><span class=o>[</span><span class=n>Locked</span><span class=w> </span><span class=n>by</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>Consumer2</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>506</span><span class=o>]</span><span class=w> </span><span class=n>Consumer2</span><span class=w> </span><span class=err>ğŸ””</span><span class=w> </span><span class=n>æ¶ˆè´¹å®Œæˆ</span><span class=err>ï¼Œ</span><span class=n>å”¤é†’ç”Ÿäº§è€…</span><span class=w> </span><span class=p>(</span><span class=n>pCondition</span><span class=p>.</span><span class=na>signalAll</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>16</span><span class=p>:</span><span class=n>14</span><span class=p>:</span><span class=n>14</span><span class=p>.</span><span class=na>506</span><span class=o>]</span><span class=w> </span><span class=n>Consumer2</span><span class=w> </span><span class=err>â¹</span><span class=n>ï¸</span><span class=w> </span><span class=n>é‡Šæ”¾é”</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>å½“å‰é”çŠ¶æ€</span><span class=p>:</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>ReentrantLock</span><span class=nd>@363b2ca2</span><span class=o>[</span><span class=n>Unlocked</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>å–åˆ°çš„å€¼</span><span class=o>-</span><span class=n>83</span><span class=w>
</span></span></span></code></pre></div><h3 id=ç–‘é—®>ç–‘é—®<a hidden class=anchor aria-hidden=true href=#ç–‘é—®>#</a></h3><p>ä¸€å¼€å§‹ç”±äºå¯¹è¿™å¿«å†…å®¹ä¸æ˜¯å¾ˆäº†è§£ï¼Œæˆ‘äº§ç”Ÿäº†2ä¸ªç–‘é—®ï¼Œ</p><ul><li>çº¿ç¨‹åªè¦è·å–é”ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹éƒ½å¾—ç­‰å¾…è·å–é”ï¼Œå¤šä¸ªçº¿ç¨‹åªç”¨ç«äº‰ä¸€æŠŠé”ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨conditionå‘¢ã€‚</li><li>çº¿ç¨‹åœ¨è·å–é”ä¹‹åï¼Œåªèƒ½ç­‰å¾…é”æ‰§è¡Œå®Œé‡Šæ”¾æ‰èƒ½é‡æ–°ç«äº‰åˆ°é”ï¼ŒåŠ äº†conditionç­‰å¾…å”¤é†’æœ‰ä»€ä¹ˆç”¨å‘¢</li></ul><p>å¸¦ç€è¿™2ä¸ªç–‘é—®ï¼Œæˆ‘å»é—®äº†deepseekå’Œgrokä»¥åŠchatgptï¼Œé aiç»™æ€è·¯ï¼Œç„¶åå»çœ‹äº†ä»£ç ï¼Œç¡®è®¤äº†ä½¿ç”¨conditionçš„åˆç†æ€§å’Œå¿…è¦æ€§</p><h4 id=é—®é¢˜1>é—®é¢˜1<a hidden class=anchor aria-hidden=true href=#é—®é¢˜1>#</a></h4><p>å…ˆçœ‹çœ‹grokæ€ä¹ˆå›ç­”é—®é¢˜1çš„</p><p><strong>åªä½¿ç”¨lock</strong></p><p>å•ç‹¬ä½¿ç”¨ Lock é€šå¸¸ä¼šé€šè¿‡å¿™ç­‰å¾…ï¼ˆbusy-waitingï¼‰æˆ–ç®€å•çš„æ¡ä»¶æ£€æŸ¥æ¥æ¨¡æ‹Ÿç”Ÿäº§è€…-æ¶ˆè´¹è€…çš„åŒæ­¥</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Lock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Queue</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>item</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w> </span><span class=c1>// ä¸´æ—¶é‡Šæ”¾é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>yield</span><span class=p>();</span><span class=w> </span><span class=c1>// è®©å‡º CPU</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>   </span><span class=c1>// é‡æ–°è·å–é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>item</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>take</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>yield</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>poll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>åªä½¿ç”¨lockï¼Œä¼šé¢‘ç¹åˆ¤æ–­æ¡ä»¶ï¼Œå†™å‡ºå¦‚ä¸Šçš„åŠ é”/é‡Šæ”¾é”çš„ä»£ç ï¼Œä»¥åŠè¦è®©å‡ºcpuï¼Œä¸å¤Ÿä¼˜é›…</p><p><strong>ç»“åˆlock+condition</strong></p><p>ä½¿ç”¨ Lock å’Œ Conditionï¼Œå¯ä»¥é€šè¿‡æ¡ä»¶å˜é‡ç²¾ç¡®æ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Lock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Condition</span><span class=w> </span><span class=n>pCondition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Condition</span><span class=w> </span><span class=n>cCondition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Queue</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>produce</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>item</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>pCondition</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w> </span><span class=c1>// ç­‰å¾…â€œéæ»¡â€æ¡ä»¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>item</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cCondition</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w> </span><span class=c1>// å”¤é†’ç­‰å¾…â€œéç©ºâ€çš„æ¶ˆè´¹è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>consume</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>cCondition</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w> </span><span class=c1>// ç­‰å¾…â€œéç©ºâ€æ¡ä»¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>poll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pCondition</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w> </span><span class=c1>// å”¤é†’ç­‰å¾…â€œéæ»¡â€çš„ç”Ÿäº§è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>lock+conditionï¼Œå¯ä»¥ç²¾å‡†æ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’</p><p>ä½¿ç”¨äº†2ä¸ªconditionï¼Œqueueæ»¡äº†pConditionå°±ç­‰å¾…ï¼Œæš‚åœç”Ÿäº§ï¼Œqueueç©ºäº†cConditionå°±ç­‰å¾…ï¼Œæš‚åœæ¶ˆè´¹</p><p>ç”Ÿäº§ä¹‹åï¼Œ é‡Šæ”¾ä¿¡å·ï¼Œå”¤é†’cConditionå»æ¶ˆè´¹ï¼Œæ¶ˆè´¹ä¹‹åï¼Œå”¤é†’pConditionå»ç”Ÿäº§</p><p><strong>2ç§å®ç°æ–¹å¼ä¼˜ç¼ºç‚¹æ¯”è¾ƒ</strong></p><table><thead><tr><th>ç‰¹æ€§</th><th>åªä½¿ç”¨ Lock</th><th>ä½¿ç”¨ Lock + Condition</th></tr></thead><tbody><tr><td><strong>çº¿ç¨‹é€šçŸ¥</strong></td><td>æ— æ³•ç²¾ç¡®é€šçŸ¥ï¼Œä¾èµ–è½®è¯¢</td><td>ç²¾ç¡®é€šçŸ¥ï¼Œé€šè¿‡ signal() å”¤é†’</td></tr><tr><td><strong>æ•ˆç‡</strong></td><td>å¿™ç­‰å¾…æˆ–é¢‘ç¹é”åˆ‡æ¢ï¼Œæ•ˆç‡ä½</td><td>çº¿ç¨‹æŒ‚èµ·ï¼Œæ— å¿™ç­‰å¾…ï¼Œæ•ˆç‡é«˜</td></tr><tr><td><strong>é”ç«äº‰</strong></td><td>é«˜ï¼Œå¯èƒ½åå¤é‡Šæ”¾å’Œè·å–é”</td><td>ä½ï¼Œå”¤é†’åé˜Ÿåˆ—å¼è·å–é”</td></tr><tr><td><strong>ä»£ç å¤æ‚åº¦</strong></td><td>é«˜ï¼Œæ‰‹åŠ¨å®ç°ç­‰å¾…é€»è¾‘</td><td>ä½ï¼ŒAPI ç®€æ´ä¸”åŠŸèƒ½å¼ºå¤§</td></tr><tr><td><strong>æ¡ä»¶åŒºåˆ†</strong></td><td>æ— æ³•åŒºåˆ†ä¸åŒæ¡ä»¶</td><td>æ”¯æŒå¤šä¸ª Condition å¯¹è±¡</td></tr><tr><td><strong>ä¸­æ–­å¤„ç†</strong></td><td>æ‰‹åŠ¨æ£€æŸ¥å’Œå¤„ç†</td><td>å†…ç½®æ”¯æŒï¼ŒæŠ›å‡ºå¼‚å¸¸</td></tr></tbody></table><p>é€šè¿‡ä»¥ä¸Šçš„ä¼˜ç¼ºç‚¹æ¯”è¾ƒï¼Œå¯ä»¥çœ‹åˆ°å•ç‹¬ä½¿ç”¨lockï¼Œæœ‰ä»¥ä¸‹ç¼ºç‚¹</p><ul><li>ç¼ºä¹ç²¾ç¡®çš„çº¿ç¨‹é€šçŸ¥æœºåˆ¶</li><li>æ•ˆç‡ä½ä¸‹ï¼Œå¿™ç­‰å¾…æˆ–é”åˆ‡æ¢å¼€é”€å¤§ã€‚</li><li>æ›´é«˜çš„é”ç«äº‰å’Œå»¶è¿Ÿã€‚</li><li>ä»£ç å¤æ‚ä¸”ä¸å¤Ÿä¼˜é›…ã€‚</li><li>æ— æ³•åŒºåˆ†ä¸åŒç­‰å¾…æ¡ä»¶ã€‚</li><li>ä¸­æ–­å¤„ç†å›°éš¾ã€‚</li></ul><p>åœ¨å®é™…çš„ç”Ÿäº§åœºæ™¯ç§</p><p>å‡è®¾ä¸€ä¸ªé«˜å¹¶å‘ç”Ÿäº§è€…-æ¶ˆè´¹è€…ç³»ç»Ÿï¼š</p><ul><li>åªä½¿ç”¨ Lock<ul><li>ç¼“å†²åŒºæ»¡æ—¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹ä¸æ–­è½®è¯¢ï¼Œæµªè´¹ CPUã€‚</li><li>æ¶ˆè´¹è€…è¢«å”¤é†’åå¯èƒ½å‘ç°ç¼“å†²åŒºä»ç©ºï¼ˆå…¶ä»–æ¶ˆè´¹è€…æŠ¢å…ˆæ¶ˆè´¹ï¼‰ï¼Œéœ€è¦å†æ¬¡ç­‰å¾…ã€‚</li><li>ç³»ç»Ÿååé‡ä½ï¼Œå»¶è¿Ÿé«˜ã€‚</li></ul></li><li>ä½¿ç”¨ Lock + Condition<ul><li>ç”Ÿäº§è€…ç­‰å¾… pConditionï¼Œæ¶ˆè´¹è€…ç­‰å¾… cConditionï¼Œäº’ä¸å¹²æ‰°ã€‚</li><li>ç”Ÿäº§è€…æ”¾å…¥æ•°æ®ååªå”¤é†’æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…ç§»é™¤æ•°æ®ååªå”¤é†’ç”Ÿäº§è€…ã€‚</li><li>ç³»ç»Ÿé«˜æ•ˆè¿è¡Œï¼Œèµ„æºåˆ©ç”¨ç‡é«˜ã€‚</li></ul></li></ul><h4 id=é—®é¢˜2>é—®é¢˜2<a hidden class=anchor aria-hidden=true href=#é—®é¢˜2>#</a></h4><p>å†çœ‹çœ‹é—®é¢˜2çš„å›ç­”</p><p>è·å–conditionä½¿ç”¨çš„æ˜¯lockçš„apiï¼Œè¿”å›çš„æ˜¯å®šä¹‰åœ¨aqsä¸­çš„conditionobject</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>pCondition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>cCondition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202502271722889.png alt=image-20250227172213797></p><p>è°ƒç”¨<code>pCondition.await(); </code>å®é™…æ˜¯è°ƒç”¨äº†<code>java.util.concurrent.locks.AbstractQueuedSynchronizer.ConditionObject#await()</code></p><p>æˆ‘å°†aqsçš„æ–¹æ³•ä»£ç ï¼Œå–‚ç»™äº†grokï¼Œè®©grokå¸®æˆ‘åˆ†ææ–¹æ³•å®ç°çš„ç»†èŠ‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å®ç°å¯ä¸­æ–­çš„æ¡ä»¶ç­‰å¾…ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;ol&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;li&gt; å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡º InterruptedException å¼‚å¸¸ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;li&gt; ä¿å­˜ç”± {@link #getState} è¿”å›çš„é”çŠ¶æ€ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;li&gt; ä½¿ç”¨ä¿å­˜çš„çŠ¶æ€ä½œä¸ºå‚æ•°è°ƒç”¨ {@link #release} æ–¹æ³•ï¼Œ
</span></span></span><span class=line><span class=cl><span class=cm> *      å¦‚æœå¤±è´¥åˆ™æŠ›å‡º IllegalMonitorStateException å¼‚å¸¸ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;li&gt; é˜»å¡ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–è¢«ä¸­æ–­ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;li&gt; é€šè¿‡è°ƒç”¨ {@link #acquire} çš„ç‰¹å®šç‰ˆæœ¬ï¼Œå¹¶ä¼ å…¥ä¿å­˜çš„çŠ¶æ€ä½œä¸ºå‚æ•°æ¥é‡æ–°è·å–é”ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;li&gt; å¦‚æœåœ¨ç¬¬ 4 æ­¥é˜»å¡æ—¶è¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡º InterruptedException å¼‚å¸¸ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;/ol&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * Implements interruptible condition wait.
</span></span></span><span class=line><span class=cl><span class=cm>         * &lt;ol&gt;
</span></span></span><span class=line><span class=cl><span class=cm>         * &lt;li&gt; If current thread is interrupted, throw InterruptedException.
</span></span></span><span class=line><span class=cl><span class=cm>         * &lt;li&gt; Save lock state returned by {@link #getState}.
</span></span></span><span class=line><span class=cl><span class=cm>         * &lt;li&gt; Invoke {@link #release} with saved state as argument,
</span></span></span><span class=line><span class=cl><span class=cm>         *      throwing IllegalMonitorStateException if it fails.
</span></span></span><span class=line><span class=cl><span class=cm>         * &lt;li&gt; Block until signalled or interrupted.
</span></span></span><span class=line><span class=cl><span class=cm>         * &lt;li&gt; Reacquire by invoking specialized version of
</span></span></span><span class=line><span class=cl><span class=cm>         *      {@link #acquire} with saved state as argument.
</span></span></span><span class=line><span class=cl><span class=cm>         * &lt;li&gt; If interrupted while blocked in step 4, throw InterruptedException.
</span></span></span><span class=line><span class=cl><span class=cm>         * &lt;/ol&gt;
</span></span></span><span class=line><span class=cl><span class=cm>         */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>await</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addConditionWaiter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=c1>//é‡Šæ”¾é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fullyRelease</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isOnSyncQueue</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>checkInterruptWhileWaiting</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>savedState</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>interruptMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>THROW_IE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>REINTERRUPT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=c1>// clean up if cancelled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unlinkCancelledWaiters</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>interruptMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>reportInterruptAfterWait</span><span class=p>(</span><span class=n>interruptMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>grokå¸®æˆ‘æ€»ç»“å‡ºäº†å¦‚ä¸‹é‡ç‚¹</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>é”çš„é‡Šæ”¾</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>åœ¨</span><span class=w> </span><span class=nf>fullyRelease</span><span class=p>(</span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=n>ä¸­é‡Šæ”¾é”</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>å‘ç”Ÿåœ¨ç­‰å¾…ä¹‹å‰</span><span class=err>ï¼Œ</span><span class=n>ç¡®ä¿çº¿ç¨‹åœ¨æŒ‚èµ·æ—¶ä¸æŒæœ‰é”</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ç­‰å¾…é”çš„åœ°æ–¹</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>åœ¨</span><span class=w> </span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isOnSyncQueue</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=n>å¾ªç¯ä¸­</span><span class=err>ï¼Œ</span><span class=n>é€šè¿‡</span><span class=w> </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=n>æŒ‚èµ·çº¿ç¨‹</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ç­‰å¾…æ¡ä»¶æ˜¯</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=n>è¢«è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—</span><span class=err>ï¼ˆ</span><span class=n>ç”±</span><span class=w> </span><span class=nf>signal</span><span class=p>()</span><span class=w> </span><span class=n>è§¦å‘</span><span class=err>ï¼‰</span><span class=n>æˆ–è¢«ä¸­æ–­</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>è·å–é”åçš„æ¢å¤</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>åœ¨</span><span class=w> </span><span class=nf>acquireQueued</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>savedState</span><span class=p>)</span><span class=w> </span><span class=n>ä¸­é‡æ–°ç«äº‰å¹¶è·å–é”</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ä½¿ç”¨ä¿å­˜çš„</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=n>æ¢å¤é”çš„çŠ¶æ€</span><span class=err>ï¼ˆ</span><span class=n>ä¾‹å¦‚é‡å…¥æ¬¡æ•°</span><span class=err>ï¼‰ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>è·å–é”å</span><span class=err>ï¼Œ</span><span class=n>å¤„ç†å¯èƒ½çš„æ¸…ç†å’Œä¸­æ–­é€»è¾‘</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>é”çš„æµç¨‹å¦‚ä¸‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>æŒæœ‰é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>â†“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>æ£€æŸ¥ä¸­æ–­</span><span class=w> </span><span class=err>â†’</span><span class=w> </span><span class=n>ä¸­æ–­æŠ›å¼‚å¸¸é€€å‡º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>â†“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>åˆ›å»ºç­‰å¾…èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>â†“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>é‡Šæ”¾é”</span><span class=w> </span><span class=p>(</span><span class=n>fullyRelease</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>â†“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>å¾ªç¯ç­‰å¾…</span><span class=w> </span><span class=p>(</span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>â†“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>è¢«å”¤é†’</span><span class=o>/</span><span class=n>ä¸­æ–­</span><span class=w> </span><span class=err>â†’</span><span class=w> </span><span class=n>æ£€æŸ¥ä¸­æ–­çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>â†“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>é‡æ–°è·å–é”</span><span class=w> </span><span class=p>(</span><span class=n>acquireQueued</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>â†“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>æ¸…ç†å–æ¶ˆèŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>â†“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>å¤„ç†ä¸­æ–­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>â†“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>è¿”å›</span><span class=w> </span><span class=p>(</span><span class=n>æŒæœ‰é”</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´åœ¨è¿™è¡Œä»£ç <code> int savedState = fullyRelease(node);</code>ä¼šé‡Šæ”¾æ‰é”</p><p>è¯¦ç»†çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯aqsæä¾›çš„<code>java.util.concurrent.locks.AbstractQueuedSynchronizer#fullyRelease</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>* ä½¿ç”¨å½“å‰çŠ¶æ€å€¼è°ƒç”¨ release æ–¹æ³•ï¼Œå¹¶è¿”å›ä¿å­˜çš„çŠ¶æ€ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>* è‹¥æ“ä½œå¤±è´¥ï¼Œåˆ™å–æ¶ˆèŠ‚ç‚¹å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚
</span></span></span><span class=line><span class=cl><span class=cm>* @param node ç­‰å¾…ä¸­çš„æ¡ä»¶èŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=cm>* @return å…ˆå‰çš„åŒæ­¥çŠ¶æ€
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Invokes release with current state value; returns saved state.
</span></span></span><span class=line><span class=cl><span class=cm>     * Cancels node and throws exception on failure.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param node the condition node for this wait
</span></span></span><span class=line><span class=cl><span class=cm>     * @return previous sync state
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>fullyRelease</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>release</span><span class=p>(</span><span class=n>savedState</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>savedState</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>node</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CANCELLED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ä¼šåœ¨ifæ¡ä»¶é‡Œæ‰§è¡Œ<code>java.util.concurrent.locks.AbstractQueuedSynchronizer#release</code>æ–¹æ³•ï¼Œå°è¯•é‡Šæ”¾é”</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**  
</span></span></span><span class=line><span class=cl><span class=cm> * ä»¥ç‹¬å æ¨¡å¼é‡Šæ”¾é”ã€‚è‹¥ {@link #tryRelease} è¿”å› trueï¼Œåˆ™å”¤é†’ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ã€‚  
</span></span></span><span class=line><span class=cl><span class=cm> * æ­¤æ–¹æ³•å¯ç”¨äºå®ç° {@link Lock#unlock}ã€‚  
</span></span></span><span class=line><span class=cl><span class=cm> *  
</span></span></span><span class=line><span class=cl><span class=cm> * @param arg é‡Šæ”¾å‚æ•°ï¼Œè¯¥å€¼ä¼šä¼ é€’ç»™ {@link #tryRelease}ï¼Œä½†ä¸ä¼šè¢«é¢å¤–è§£é‡Šï¼Œå¯ç”¨äºè¡¨ç¤ºä»»æ„å«ä¹‰ã€‚  
</span></span></span><span class=line><span class=cl><span class=cm> * @return {@link #tryRelease} æ–¹æ³•çš„è¿”å›å€¼ã€‚  
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Releases in exclusive mode.  Implemented by unblocking one or
</span></span></span><span class=line><span class=cl><span class=cm>     * more threads if {@link #tryRelease} returns true.
</span></span></span><span class=line><span class=cl><span class=cm>     * This method can be used to implement method {@link Lock#unlock}.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param arg the release argument.  This value is conveyed to
</span></span></span><span class=line><span class=cl><span class=cm>     *        {@link #tryRelease} but is otherwise uninterpreted and
</span></span></span><span class=line><span class=cl><span class=cm>     *        can represent anything you like.
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the value returned from {@link #tryRelease}
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ReservedStackAccess</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>release</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryRelease</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unparkSuccessor</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>æœ€ç»ˆæ‰§è¡Œ<code>java.util.concurrent.locks.AbstractQueuedSynchronizer#tryRelease</code>è¿›è¡Œé‡Šæ”¾ï¼Œç”±å­ç±»å®šä¹‰å…·ä½“çš„é‡Šæ”¾é€»è¾‘ï¼Œè¿™ä¸ªåœºæ™¯ä¸‹æœ€ç»ˆè°ƒç”¨<code>java.util.concurrent.locks.ReentrantReadWriteLock.Sync#tryRelease</code>è¿›è¡Œçš„é‡Šæ”¾é€»è¾‘</p><p>è¿™ä¹ˆçœ‹ä¸‹æ¥ï¼Œæ‰§è¡Œ<code>java.util.concurrent.locks.Condition#await()</code>ä¼šå°†æŒæœ‰çš„é”é‡Šæ”¾æ‰ï¼Œé‡Šæ”¾æ‰é”ä¹‹åï¼Œå…¶ä»–ç­‰å¾…è·å–é”çš„çº¿ç¨‹å¯ä»¥å°è¯•è·å–é”ï¼Œæ‹¿åˆ°é”ä¹‹åå°è¯•è¿›è¡Œç”Ÿäº§æˆ–è€…æ¶ˆè´¹</p><p>å‡å¦‚æ‰§è¡Œåˆ°<code>java.util.concurrent.locks.Condition#signalAll</code>ï¼Œé‚£ä¹ˆä¼šå‘é€šçŸ¥ç­‰å¾…åœ¨pConditionæˆ–cConditionä¸Šçš„çº¿ç¨‹ï¼Œå”¤é†’ç­‰å¾…ï¼Œå°è¯•è·å–é”ï¼Œåœ¨put()æˆ–take()finallyé‡Œï¼Œæœ€ç»ˆä¼šé‡Šæ”¾é”ï¼Œå¯¹åº”çš„conditionè¢«å”¤é†’ï¼Œå°è¯•é‡æ–°è·å–é”ã€‚</p><p>åªæœ‰è¿™æ ·åœ¨awaitä¼šé‡Šæ”¾é”ï¼Œlock+conditionçš„ç»„åˆæ‰ä¼šæœ‰æ„ä¹‰ã€‚</p><h3 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h3><p>lock+conditionç»“åˆï¼Œå¯ä»¥å®ç°ç²¾å‡†æ§åˆ¶ï¼Œå‡†ç¡®é€šçŸ¥çº¿ç¨‹ï¼Œé™ä½é”ç«äº‰å’Œèµ„æºæ¶ˆè€—ï¼Œå®ç°å¹¶å‘çš„ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹</p><h2 id=å…¶ä»–>å…¶ä»–<a hidden class=anchor aria-hidden=true href=#å…¶ä»–>#</a></h2><p>ä»¥å‰æœ‰é—®é¢˜ï¼Œåªèƒ½é æœç´¢å¼•æ“ç»™ç­”æ¡ˆï¼Œç°åœ¨æœ‰äº†aiä¹‹åï¼Œå¯ä»¥å‘aiæé—®ï¼Œaiå¯ä»¥ç»™ä½ åšè¯¦ç»†çš„è§£é‡Šï¼Œä¹Ÿä¸ç”¨è‡ªå·±è‹¦å“ˆå“ˆçš„çœ‹å’Œç†è§£äº†ã€‚</p><p>é‡åˆ°ä¸æ‡‚çš„ï¼Œaièƒ½ç»™ä½ åšè¯¦ç»†è§£é‡Šï¼Œå¼€å‘çš„å­¦ä¹ æˆæœ¬ç¡®å®é™ä½äº†</p><p>ä½†æ˜¯aiæµªæ½®å¸­å·ä¸‹ï¼Œç¡…åŸºå¦‚ä½•å¹²ç¢ç¢³åŸºï¼Œå¯èƒ½å¾ˆå¿«å°±ä¼šæ¥ä¸´äº†ã€‚</p><p>ç°åœ¨å°±æ˜¯aiäººç±»åŒ–ï¼Œäººç±»aiåŒ–ï¼ŒçœŸçš„æŠ½è±¡</p></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://blog.thend03.com/img/wechat-pay.png alt=wechat_pay></a><p>å¾®ä¿¡</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://blog.thend03.com/img/alipay.png alt=alipay></a><p>æ”¯ä»˜å®</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>ğŸ§§ é¼“åŠ±</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://blog.thend03.com/posts/watched-movies-250304/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>è¿‘æœŸçœ‹è¿‡çš„å½±è§†å‰§</span>
</a><a class=next href=https://blog.thend03.com/posts/life/zhuge-fairy-mount/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>æ±Ÿæµ™æ²ªå‘¨è¾¹æ¸¸ä¹‹è¯¸è‘›ä»™å±±</span></a></nav></footer></div><script>function createGiscusScript(e){const t=document.createElement("script");Object.entries(e).forEach(([e,n])=>t.setAttribute(e,n)),document.querySelector("article").appendChild(t);const n=document.querySelector('label[for="switch_default"]');n&&n.addEventListener("click",function(){const e=document.body.classList.contains("dark")?"transparent_dark":"light";t.setAttribute("data-theme",e),sendMessage({setConfig:{theme:e}})})}function sendMessage(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}document.addEventListener("DOMContentLoaded",function(){const e={src:"https://giscus.app/client.js","data-repo":"thend03/blog-comments","data-repo-id":"R_kgDOJx0ckg","data-category":"Announcements","data-category-id":"DIC_kwDOJx0cks4CmM8j","data-mapping":"pathname","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-lang":"zh-CN","data-loading":"lazy",crossorigin:"anonymous",async:""};e["data-theme"]=document.body.classList.contains("dark")?"transparent_dark":"light",createGiscusScript(e);const t=new MutationObserver(()=>{const e=document.body.classList.contains("dark")?"transparent_dark":"light";sendMessage({setConfig:{theme:e}})});t.observe(document.body,{attributes:!0,attributeFilter:["class"]})})</script></article></main><footer class=footer><span>Copyright
&copy;
2020-2025
<a href=https://blog.thend03.com/ style=color:#939393>ç«™åœ¨æµ·è¾¹çœ‹è¿œæ–¹</a>
All Rights Reserved
</span><a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393></a>&nbsp;
<span><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null" style=display:inline-block;text-decoration:none;height:20px;color:#939393><img src style="float:left;margin:0 5px 0 0">
</a></span><span id=busuanzi_container><span class="fa fa-user"></span> <span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye"></span> <span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
<span id=read_progress></span>
</span></a><script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString(),s=window.getSelection().toString();t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="å¤åˆ¶";function i(){t.innerText="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerText="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>