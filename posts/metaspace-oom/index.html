<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>metaspace-oom | Fayy&amp;Fc's Blog</title><meta name=keywords content="jvm,oom"><meta name=description content="metaspace oom"><meta name=author content="since"><link rel=canonical href=https://blog.thend03.com/posts/metaspace-oom/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://blog.thend03.com/img/logo.jpg><link rel=icon type=image/png sizes=16x16 href=https://blog.thend03.com/img/logo.jpg><link rel=icon type=image/png sizes=32x32 href=https://blog.thend03.com/img/logo.jpg><link rel=apple-touch-icon href=https://blog.thend03.com/img/logo.jpg><link rel=mask-icon href=https://blog.thend03.com/img/logo.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.thend03.com/posts/metaspace-oom/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="metaspace-oom"><meta property="og:description" content="metaspace oom"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.thend03.com/posts/metaspace-oom/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-07T09:47:33+08:00"><meta property="article:modified_time" content="2023-09-07T09:47:33+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="metaspace-oom"><meta name=twitter:description content="metaspace oom"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚文章","item":"https://blog.thend03.com/posts/"},{"@type":"ListItem","position":2,"name":"metaspace-oom","item":"https://blog.thend03.com/posts/metaspace-oom/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"metaspace-oom","name":"metaspace-oom","description":"metaspace oom","keywords":["jvm","oom"],"articleBody":"问题背景 生产环境有机器产生了oom，一开始怀疑是heap oom，因为之前配置了发生oom，自动进行dump，所以分析了dump文件之后，发现4g的heap，最终dump只有300多m，没有分析出有用的内容。\n后来又一次oom之后，终于在容器控制台发现了错误根因，是Metaspace发生了oom。\n所以着重分析下Metaspace为什么会oom。\n前置知识 启动参数 先看下启动参数，看下JVM具体的参数配置\n-Xmx4096M -Xms4096M -Xmn2048M -XX:MaxMetaspaceSize=512M -XX:MetaspaceSize=512M -XX:+UseConcMarkSweepGC -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses -XX:+CMSClassUnloadingEnabled -XX:+ParallelRefProcEnabled -XX:+CMSScavengeBeforeRemark -XX:+HeapDumpOnOutOfMemoryError -XX:ErrorFile=/data/logs/hs_err_pid%p.log -Xloggc:/dev/shm/gc.log -XX:HeapDumpPath=/data/logs/ -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintClassHistogramBeforeFullGC -XX:+PrintClassHistogramAfterFullGC -XX:+PrintCommandLineFlags -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGCApplicationStoppedTime -XX:+PrintTenuringDistribution -XX:+PrintHeapAtGC -Ddubbo.reference.check=false -XX:+UnlockDiagnosticVMOptions 这个是公司默认的jvm参数，可以看到，堆最大是4g，metaspace最大是512m，metaspace给的空间已经很大了，但还是发生了oom。\n关于metaspace的大小的配置项，我们后面再提一下具体含义。\nMetaspace里有什么 分析Metaspace oom之前，先确认下metaspace里会有哪些东西。jdk1.8相比1.7，移除了perm gen，把class,method,constant pool等内容移到了metaspace，单独的一块区域，和机器内存直接相关，不受堆管控。\n在底层，MetaSpace 主要由 Klass Metaspace 和 NoKlass Metaspace 两大部分组成。\nKlass MetaSpace： 就是用来存 Klass 的，就是 Class 文件在 JVM 里的运行时数据结构，这部分默认放在 Compressed Class Pointer Space 中，是一块连续的内存区域，紧接着 Heap。\nCompressed Class Pointer Space 不是必须有的，如果设置了 -XX:-UseCompressedClassPointers，或者 -Xmx 设置大于 32 G，就不会有这块内存，这种情况下 Klass 都会存在 NoKlass Metaspace 里。\nNoKlass MetaSpace： 专门来存 Klass 相关的其他的内容，比如 Method，ConstantPool 等，可以由多块不连续的内存组成。虽然叫做 NoKlass Metaspace，但是也其实可以存 Klass 的内容，上面已经提到了对应场景。\nMetaSpace 的对象为什么无法释放，我们看下面两点\nMetaSpace 内存管理： 类和其元数据的生命周期与其对应的类加载器相同，只要类的类加载器是存活的，在 Metaspace 中的类元数据也是存活的，不能被回收。每个加载器有单独的存储空间，通过 ClassLoaderMetaspace 来进行管理 SpaceManager* 的指针，相互隔离的。 MetaSpace 弹性伸缩： 由于 MetaSpace 空间和 Heap 并不在一起，所以这块的空间可以不用设置或者单独设置，一般情况下避免 MetaSpace 耗尽 VM 内存都会设置一个 MaxMetaSpaceSize，在运行过程中，如果实际大小小于这个值，JVM 就会通过 -XX:MinMetaspaceFreeRatio 和 -XX:MaxMetaspaceFreeRatio 两个参数动态控制整个 MetaSpace 的大小，这个方法会在 CMSCollector 和 G1CollectorHeap 等几个收集器执行 GC 时调用。这个里面会根据 used_after_gc，MinMetaspaceFreeRatio 和 MaxMetaspaceFreeRatio 这三个值计算出来一个新的 _capacity_until_GC 值（水位线）。然后根据实际的 _capacity_until_GC 值使用 MetaspaceGC::inc_capacity_until_GC() 和 MetaspaceGC::dec_capacity_until_GC() 进行 expand 或 shrink。 为了避免弹性伸缩带来的额外 GC 消耗，一般要将 -XX:MetaSpaceSize 和 -XX:MaxMetaSpaceSize 两个值设置为固定的，但是这样也会导致在空间不够的时候无法扩容，然后频繁地触发 GC，最终 OOM。\n所以关键原因就是 ClassLoader 不停地在内存中 load 了新的 Class ，一般这种问题都发生在动态类加载等情况上。\n可能出现问题的点有如下几个\ngroovy动态加载类 反射使用不当频繁创建类 Orika 的 classMap JSON 的 ASMSerializer 基本都集中在反射、Javasisit 字节码增强、CGLIB 动态代理、OSGi 自定义类加载器等的技术点上。\n排查手段 有了上面的背景之后，我们排查方向分为2部分，一部分是看发版记录，最近有哪些改动，哪些地方可能会频繁创建类，二是从jvm层面排查。我们重点说一下jvm层面的排查方向。\n注意事项: 写这篇文章的时候，问题已经解决，所以部分数据不是出问题时采集的数据，是为了写文章使用对应的排查工具生成的数据，具体位置处会标明数据来源和时机\nJVM排查 jdk自带的排查工具，我们可以用的有jps,jstat,jmap等\n其中jmap看的是堆的内存大小和分配\njstat可以看gc相关信息.\ngc.log里的gc日志也可以辅助我们排查\njmap jmap -heap pid的信息如下，这个可以辅助我们看下堆内分代的内存使用情况，当然这个对我们的排查帮助不大，下面看一下命令效果\nAttaching to process ID 5311, please wait... Debugger attached successfully. Server compiler detected. JVM version is 25.73-b02 using parallel threads in the new generation. using thread-local object allocation. Concurrent Mark-Sweep GC Heap Configuration: MinHeapFreeRatio = 40 MaxHeapFreeRatio = 70 MaxHeapSize = 4294967296 (4096.0MB) NewSize = 2147483648 (2048.0MB) MaxNewSize = 2147483648 (2048.0MB) OldSize = 2147483648 (2048.0MB) NewRatio = 2 SurvivorRatio = 8 MetaspaceSize = 536870912 (512.0MB) CompressedClassSpaceSize = 1073741824 (1024.0MB) MaxMetaspaceSize = 536870912 (512.0MB) G1HeapRegionSize = 0 (0.0MB) Heap Usage: New Generation (Eden + 1 Survivor Space): capacity = 1932787712 (1843.25MB) used = 735313536 (701.2496337890625MB) free = 1197474176 (1142.0003662109375MB) 38.04419551276617% used Eden Space: capacity = 1718091776 (1638.5MB) used = 733845856 (699.8499450683594MB) free = 984245920 (938.6500549316406MB) 42.71284376370823% used From Space: capacity = 214695936 (204.75MB) used = 1467680 (1.399688720703125MB) free = 213228256 (203.35031127929688MB) 0.683608654800061% used To Space: capacity = 214695936 (204.75MB) used = 0 (0.0MB) free = 214695936 (204.75MB) 0.0% used concurrent mark-sweep generation: capacity = 2147483648 (2048.0MB) used = 613751744 (585.3192749023438MB) free = 1533731904 (1462.6807250976562MB) 28.580042719841003% used 66527 interned Strings occupying 7048176 bytes. 还有一个命令是jmap -histo pid，这个可以看堆内存活的对象类型和实例数量\nnum #instances #bytes class name ---------------------------------------------- 1: 5478775 506824136 [C 2: 1421313 315369496 [B 3: 3791992 91007808 java.lang.String 4: 2593077 82978464 java.util.HashMap$Node 5: 730043 78351624 [I 6: 1393624 67623928 [Ljava.lang.Object; 7: 712992 62743296 java.lang.reflect.Method 8: 317758 48979560 [Ljava.util.HashMap$Node; 9: 178237 32795608 com.fasterxml.jackson.core.json.UTF8StreamJsonParser 10: 513502 20540080 java.util.LinkedHashMap$Entry 11: 639968 20478976 com.mysql.cj.conf.BooleanProperty 12: 941240 18059848 [Ljava.lang.Class; 13: 353510 16968480 java.util.HashMap 14: 241178 13505968 sun.nio.cs.UTF_8$Encoder 15: 539462 12947088 java.lang.StringBuilder 16: 178448 12848256 com.fasterxml.jackson.databind.deser.DefaultDeserializationContext$Impl 17: 218814 12253584 com.fasterxml.jackson.core.io.IOContext jstat 使用jstat观察gc和metaspace的使用情况，jstat主要输出各个区域的使用量比例(写这篇文章的时候问题已修复，所以metaspace使用占比比较平稳)\njstat -gcutil 5311 这个命令以1000ms为间隔，输出pid 5311的进程的gc情况，从这里可以看出metaspace的使用比例的变化\n比如s0是survivo 0当前空间的已使用比例，s1的survivo 1当前空间的已使用比例，E是eden区的已使用比例，O是old gen的已使用比例\nS0 S1 E O M CCS YGC YGCT FGC FGCT GCT 0.00 1.04 57.32 27.40 92.59 86.14 125511 1969.952 28 5.062 1975.014 0.00 1.04 78.69 27.40 92.59 86.14 125511 1969.952 28 5.062 1975.014 0.00 1.04 97.81 27.40 92.59 86.14 125511 1969.952 28 5.062 1975.014 0.98 0.00 32.47 27.40 92.59 86.14 125512 1969.968 28 5.062 1975.031 0.98 0.00 66.19 27.40 92.59 86.14 125512 1969.968 28 5.062 1975.031 0.98 0.00 91.34 27.40 92.59 86.14 125512 1969.968 28 5.062 1975.031 0.00 0.81 17.07 27.41 92.59 86.14 125513 1969.980 28 5.062 1975.042 0.00 0.81 39.36 27.41 92.59 86.14 125513 1969.980 28 5.062 1975.042 0.00 0.81 60.87 27.41 92.59 86.14 125513 1969.980 28 5.062 1975.042 0.00 0.81 89.84 27.41 92.59 86.14 125513 1969.980 28 5.062 1975.042 0.89 0.00 9.76 27.42 92.59 86.14 125514 1969.995 28 5.062 1975.058 0.89 0.00 25.07 27.42 92.59 86.14 125514 1969.995 28 5.062 1975.058 0.89 0.00 44.26 27.42 92.59 86.14 125514 1969.995 28 5.062 1975.058 gc.log 另一个就是从gc.log里查看metaspace的日志,下面一段日志是gc前和gc后各个区域的内存变化\n可以观察下heap before gc和heap after gc2处的metaspace空间使用变化(此处是问题解决后的gc.log,仅供参考)\nmetaspace数据如下，可以看到距离512m还有足够的空间，注意此处是问题解决后的数据，仅供排查参考\nused 176869K， 已使用大概是172m capacity 189800K， 容量大概是185m committed 190848K，已提交大概是186m reserved 1216512K，保留大概是1188m 2023-09-12T09:03:08.449+0800: 1249459.698: Total time for which application threads were stopped: 0.0195137 seconds, Stopping threads took: 0.0001738 seconds 2023-09-12T09:03:11.392+0800: 1249462.641: Application time: 2.9429699 seconds 2023-09-12T09:03:11.396+0800: 1249462.646: Total time for which application threads were stopped: 0.0046629 seconds, Stopping threads took: 0.0002150 seconds 2023-09-12T09:03:11.397+0800: 1249462.646: Application time: 0.0000922 seconds 2023-09-12T09:03:11.400+0800: 1249462.649: Total time for which application threads were stopped: 0.0034414 seconds, Stopping threads took: 0.0001087 seconds 2023-09-12T09:03:14.304+0800: 1249465.553: Application time: 2.9035482 seconds {Heap before GC invocations=130961 (full 14): par new generation total 1887488K, used 1679309K [0x00000006c0000000, 0x0000000740000000, 0x0000000740000000) eden space 1677824K, 100% used [0x00000006c0000000, 0x0000000726680000, 0x0000000726680000) from space 209664K, 0% used [0x0000000733340000, 0x00000007334b34a0, 0x0000000740000000) to space 209664K, 0% used [0x0000000726680000, 0x0000000726680000, 0x0000000733340000) concurrent mark-sweep generation total 2097152K, used 1209833K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000) Metaspace used 176869K, capacity 189800K, committed 190848K, reserved 1216512K class space used 19973K, capacity 22145K, committed 23168K, reserved 1048576K 2023-09-12T09:03:14.307+0800: 1249465.557: [GC (Allocation Failure) 2023-09-12T09:03:14.307+0800: 1249465.557: [ParNew Desired survivor size 107347968 bytes, new threshold 6 (max 6) - age 1: 674280 bytes, 674280 total - age 2: 177208 bytes, 851488 total - age 3: 238904 bytes, 1090392 total - age 4: 191384 bytes, 1281776 total - age 5: 38080 bytes, 1319856 total - age 6: 40232 bytes, 1360088 total : 1679309K-\u003e1868K(1887488K), 0.0143320 secs] 2889142K-\u003e1211742K(3984640K), 0.0146560 secs] [Times: user=0.03 sys=0.01, real=0.01 secs] Heap after GC invocations=130962 (full 14): par new generation total 1887488K, used 1868K [0x00000006c0000000, 0x0000000740000000, 0x0000000740000000) eden space 1677824K, 0% used [0x00000006c0000000, 0x00000006c0000000, 0x0000000726680000) from space 209664K, 0% used [0x0000000726680000, 0x0000000726853010, 0x0000000733340000) to space 209664K, 0% used [0x0000000733340000, 0x0000000733340000, 0x0000000740000000) concurrent mark-sweep generation total 2097152K, used 1209874K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000) Metaspace used 176869K, capacity 189800K, committed 190848K, reserved 1216512K class space used 19973K, capacity 22145K, committed 23168K, reserved 1048576K } jcmd 最后一个可用的jvm工具就是cmd，使用jcmd打印下class数量，看下哪些包下的类增长比较快\n使用命令如下\njcmd GC.class_stats|awk '{print$13}'|sed 's/\\(.*\\)\\.\\(.*\\)/\\1/g'|sort |uniq -c|sort -nrk1 实际进程打印如下,可以看到最多的是sun.reflect包下的class最多\n2283 sun.reflect 416 com.xx.xx.xx.xx.impl 316 java.lang.invoke 306 com.sun.proxy 275 reactor.core.publisher 268 java.util 198 com.google.common.collect 189 com.google.protobuf 181 io.netty.channel 174 java.lang dump分析 dump 快照之后通过 JProfiler 或 MAT 观察 Classes 的 Histogram (直方图) ，这个估计得深厚的功力才能看出来\narthas arthas也有很多的命令可以帮助排查，比如dashboard，可以看metaspace区的内存占用，vmtool可以查看具体的class\n如下是dashborad命令，可以看到metaspace的使用量\n可以使用vmtool，匹配指定包名的class\nvmtool --action getInstances --className sun.reflect.* --limit 100 可以使用transform，有类加载的时候就会触发\nwatch java.lang.instrument.ClassFileTransformer transform '{params,returnObj,throwExp}' -n 5 -x 3 也可以跟踪下class init\nstack sun.reflect.DelegatingClassLoader -n 5 实际排查过程 前面介绍了一些关于metaspace的知识，也介绍了一些排查方向，接下来介绍下实际排查过程\n接到告警之后，查看进程，发现了metaspace oom的错误，于是开始往metaspace oom的方向开始排查\n经过一通google/baidu之后，发现了如上介绍的一些方向和手段\n首先是看了美团的文章场景三：MetaSpace 区 OOM\n发现可以使用jcmd命令进行排查，看下哪个包的class比较多，执行以下命令，得到如下的结果\njcmd 5311 GC.class_stats|awk '{print$13}'|sed 's/\\(.*\\)\\.\\(.*\\)/\\1/g'|sort |uniq -c|sort -nrk1|head -n 10 2294 sun.reflect 416 com.xx.impl 316 java.lang.invoke 316 com.sun.proxy 275 reactor.core.publisher 268 java.util 198 com.google.common.collect 189 com.google.protobuf 181 io.netty.channel 174 java.lang 多次执行jcmd之后，发现sun.reflect包下的class比较多，且有增长，于是把目光放在了sun.reflect上。\n以为是反射用的不当导致的，然后使用arthas，分析了dashboard以及使用了vmtool查看sun.reflect包的instance。\n当时使用dashboard分析，metaspace上涨的非常的快，然后使用vmtool命令查看sun.reflect\nvmtool --action getInstances --className sun.reflect.* --limit 100 执行结果类似下图\n分析发现里面有mytabis，也有自己调用产生的反射，但是不足以导致metaspace oom\n后来想到了加上如下2个参数,用于打印类加载、卸载日志\n-XX:+TraceClassLoading -XX:+TraceClassUnloading 由于发布系统默认没打nohup日志，所以在这里走了点弯路，类加载、卸载信息没打到日志里，后来上机器手动用nohup java -jar xx.jar \u0026之后，发现了端倪\n可以看到启动之后，打了比较多的类似下面的这些日志，可以初步判断是com.googlecode.aviator.Expression使用不当造成的\n[Loaded Script_1691559755244_2757/2021240514 from com.googlecode.aviator.Expression] [Loaded Script_1691559755339_2758/6228193 from com.googlecode.aviator.Expression] [Loaded Script_1691559755492_2759/419920034 from com.googlecode.aviator.Expression] [Loaded Script_1691559756493_2760/1460748148 from com.googlecode.aviator.Expression] [Loaded Script_1691559756500_2761/520805009 from com.googlecode.aviator.Expression] [Loaded Script_1691559756506_2762/398664510 from com.googlecode.aviator.Expression] [Loaded Script_1691559756573_2763/306461935 from com.googlecode.aviator.Expression] [Loaded Script_1691559756577_2764/1116508142 from com.googlecode.aviator.Expression] [Loaded Script_1691559756791_2765/870354750 from com.googlecode.aviator.Expression] [Loaded Script_1691559756799_2766/1661127610 from com.googlecode.aviator.Expression] [Loaded Script_1691559756812_2767/1883979577 from com.googlecode.aviator.Expression] [Loaded Script_1691559757019_2768/1281538781 from com.googlecode.aviator.Expression] [Loaded Script_1691559757332_2769/589742334 from com.googlecode.aviator.Expression] [Loaded Script_1691559757338_2770/1560860126 from com.googlecode.aviator.Expression] [Loaded Script_1691559757977_2771/213218340 from com.googlecode.aviator.Expression] [Loaded Script_1691559758313_2772/505164301 from com.googlecode.aviator.Expression] [Loaded Script_1691559758318_2773/601453331 from com.googlecode.aviator.Expression] [Loaded Script_1691559759007_2774/1011764766 from com.googlecode.aviator.Expression] [Loaded Script_1691559759014_2775/338373159 from com.googlecode.aviator.Expression] [Loaded Script_1691559759146_2776/1714310047 from com.googlecode.aviator.Expression] [Loaded Script_1691559759154_2777/1663245165 from com.googlecode.aviator.Expression] [Loaded Script_1691559759227_2778/797537408 from com.googlecode.aviator.Expression] [Loaded Script_1691559759234_2779/551097430 from com.googlecode.aviator.Expression] [Loaded Script_1691559759553_2780/594411270 from com.googlecode.aviator.Expression] [Loaded Script_1691559759559_2781/1720465741 from com.googlecode.aviator.Expression] [Loaded Script_1691559759586_2782/215181464 from com.googlecode.aviator.Expression] [Loaded Script_1691559759601_2783/2036721542 from com.googlecode.aviator.Expression] [Loaded Script_1691559759797_2784/1723282218 from com.googlecode.aviator.Expression] [Loaded Script_1691559759802_2785/953430028 from com.googlecode.aviator.Expression] [Loaded Script_1691559759942_2786/847216521 from com.googlecode.aviator.Expression] [Loaded Script_1691559759949_2787/1763495463 from com.googlecode.aviator.Expression] [Loaded Script_1691559760350_2788/47562916 from com.googlecode.aviator.Expression] 跟着com.googlecode.aviator.Expression这个类，发现可能造成异常的代码如下\nExpression expression = AviatorEvaluator.compile(ruleExpressProcessed); 这个还有一个重载方法,是否缓存\npublic static Expression compile(String expression, boolean cached) { return getInstance().compile(expression, cached); } 跟踪代码，最后会发现cached字段会影响classloader的获取，如果cached=true,则会使用已缓存的classloader，如果false每次都会new 一个新的classloader\ncom.googlecode.aviator.AviatorEvaluatorInstance#newCodeGenerator(java.lang.String, boolean) 问题修复 将cached设置为true,metaspace使用率就很平稳了，不会出现高频的类加载和卸载情况。\n问题复现 本打算在本地复现下这个问题的，但是本地能gc掉，生产环境由于每次2-3天才会发生oom，所以没有发现oom的时候，metaspace里有哪些元素，可以看下本地验证过程和现象，帮助理解\n测试代码 maven依赖\ncom.googlecode.aviator aviator 5.2.5 jvm参数\n堆设置的比较大,metaspace只设置了128m\n-Xmx4096M -Xms4096M -Xmn2048M -XX:MaxMetaspaceSize=128M -XX:MetaspaceSize=128M -XX:+UseConcMarkSweepGC -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses -XX:+CMSClassUnloadingEnabled -XX:+ParallelRefProcEnabled -XX:+CMSScavengeBeforeRemark -XX:+HeapDumpOnOutOfMemoryError -XX:ErrorFile=/data/logs/hs_err_pid%p.log -Xloggc:/dev/shm/gc.log -XX:HeapDumpPath=/data/logs/ -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintClassHistogramBeforeFullGC -XX:+PrintClassHistogramAfterFullGC -XX:+PrintCommandLineFlags -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGCApplicationStoppedTime -XX:+PrintTenuringDistribution -XX:+PrintHeapAtGC -Ddubbo.reference.check=false -XX:+UnlockDiagnosticVMOptions -XX:NativeMemoryTracking=detail //class loading unloading -XX:+TraceClassLoading -XX:+TraceClassUnloading 使用多线程去并发访问\npublic static void main(String[] args) { ThreadFactory threadFactory = new ThreadFactoryBuilder().setNameFormat(\"test-pool-%d\").build(); ThreadPoolExecutor executor = new ThreadPoolExecutor(50, 50, 1, TimeUnit.SECONDS, new LinkedBlockingQueue\u003c\u003e(50), threadFactory); for (int i = 0; i \u003c 32; i++) { executor.execute(() -\u003e { while (true) { try { String rule = \"field01+ field02\"; Map map = new HashMap\u003c\u003e(); int random1 = new Random().nextInt(); int random2 = new Random().nextInt(); map.put(\"field01\", random1); map.put(\"field02\", random2); Expression compiledExp = AviatorEvaluator.compile(rule); Object obj = compiledExp.execute(map); System.out.println(obj); } catch (Exception e) { e.printStackTrace(); } } }); } } 控制台也输出了同样的日志\n然后使用jconsole连到jvm上观察内存使用情况\n首先是metaspace的使用情况，最高是到50m，然后gc掉，持续这一过程，说明metaspace使用量在上升，但是能gc的掉，而且不会触发阈值。\n生产上发生oom，可能有流量因素，访问量比本地模拟的大。\n在看下类的加载卸载情况，程序运行了1个半小时，加载和卸载数量差不多持平，大概6529万次，可以发现类是一直在加载，但是本地模拟的情况下，卸载的也快，生产上的具体细节由于网络隔离问题，无法模拟出，仅能根据加载数量看出类加载数量异常了，这块代码是有问题的\n概览里可以看到已加载的类的数量，在一个区间范围内波动，一边加载一边卸载\n修复验证 代码修改如下，将cached设置为true\nExpression compiledExp = AviatorEvaluator.compile(rule,true); 概览数据如下，可以发现类只加载了2000多个就平稳了，不会加载新的class\nmetaspace使用量稳定在13m,不会波动\n类在加载了2274个之后保持稳定，没有新增\n根据修改之后的现象判断，造成问题的原因就是每次都会new classloader，导致类频繁加载卸载，叠加生产流量不可控，极端情况可能就会导致oom\n总结 由于未设置metaspace区监控，具体的原因暂未发现，比如Metaspace里的class数量占比，分类等。\n修复之后再上线，使用arthas观察metaspace使用量，发现metaspace区域内存使用量。\n关于metaspace的可用资料，相比于堆内存的oom来说，比较少，所以排查下来也没有那么顺利，不过经过这次问题排查，对metaspace有了一定的了解，下次再排查问题时，可以有更好的切入方向了\n参考资料 场景三：MetaSpace 区 OOM 深入理解堆外内存metaspace ","wordCount":"5147","inLanguage":"zh","datePublished":"2023-09-07T09:47:33+08:00","dateModified":"2023-09-07T09:47:33+08:00","author":{"@type":"Person","name":"since"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.thend03.com/posts/metaspace-oom/"},"publisher":{"@type":"Organization","name":"Fayy\u0026Fc's Blog","logo":{"@type":"ImageObject","url":"https://blog.thend03.com/img/logo.jpg"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.thend03.com/ accesskey=h title="fayy&amp;fc (Alt + H)"><img src=https://blog.thend03.com/img/logo.jpg alt=logo aria-label=logo height=35>fayy&amp;fc</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://blog.thend03.com/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li><a href=https://blog.thend03.com/ title="🏠 主页"><span>🏠 主页</span></a></li><li><a href=https://blog.thend03.com/archives/ title="⏱️ 归档"><span>⏱️ 归档</span></a></li><li><a href=https://blog.thend03.com/tags title="🧩 标签"><span>🧩 标签</span></a></li><li><a href=https://blog.thend03.com/about title="🙋🏻‍♂️ 关于"><span>🙋🏻‍♂️ 关于</span></a></li><li><a href=https://blog.thend03.com/links title="🤝 友链"><span>🤝 友链</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://blog.thend03.com/>🏠 主页</a>&nbsp;»&nbsp;<a href=https://blog.thend03.com/posts/>📚文章</a></div><h1 class=post-title>metaspace-oom</h1><div class=post-description>metaspace oom</div><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2023-09-07
&nbsp;&nbsp;
</span></span><span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>5147字
&nbsp;&nbsp;
</span></span><span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>11分钟
&nbsp;&nbsp;
</span></span><span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>since
&nbsp;&nbsp;
</span></span><span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta><a href=https://blog.thend03.com/tags/jvm/ style=color:var(--secondary)!important>Jvm</a>
&nbsp;<a href=https://blog.thend03.com/tags/oom/ style=color:var(--secondary)!important>Oom</a>
</span></span></span></span><span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;
</span></span><span id=post_meta_style_8><span class="fa fa-commenting-o"></span>
<span><script src=https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js></script><script>let url=document.documentURI,dnsUrl="https://blog.thend03.com/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=="/"&&(finalUrl="/"+finalUrl),twikoo.getCommentsCount({envId:"https://twikoo-e1f2-2yfafx14j-thend03s-projects.vercel.app/",region:null,urls:[finalUrl],includeReply:!1}).then(function(e){let t=e[0].count;const n=document.getElementById("comment_count");n.innerText=t}).catch(function(e){console.error(e)})</script><span id=comment_count></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e9%97%ae%e9%a2%98%e8%83%8c%e6%99%af aria-label=问题背景>问题背景</a></li><li><a href=#%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86 aria-label=前置知识>前置知识</a><ul><li><a href=#%e5%90%af%e5%8a%a8%e5%8f%82%e6%95%b0 aria-label=启动参数>启动参数</a></li><li><a href=#metaspace%e9%87%8c%e6%9c%89%e4%bb%80%e4%b9%88 aria-label=Metaspace里有什么>Metaspace里有什么</a></li><li><a href=#%e6%8e%92%e6%9f%a5%e6%89%8b%e6%ae%b5 aria-label=排查手段>排查手段</a></li><li><a href=#jvm%e6%8e%92%e6%9f%a5 aria-label=JVM排查>JVM排查</a><ul><li><a href=#jmap aria-label=jmap>jmap</a></li><li><a href=#jstat aria-label=jstat>jstat</a></li><li><a href=#gclog aria-label=gc.log>gc.log</a></li><li><a href=#jcmd aria-label=jcmd>jcmd</a></li></ul></li><li><a href=#dump%e5%88%86%e6%9e%90 aria-label=dump分析>dump分析</a></li><li><a href=#arthas aria-label=arthas>arthas</a></li></ul></li><li><a href=#%e5%ae%9e%e9%99%85%e6%8e%92%e6%9f%a5%e8%bf%87%e7%a8%8b aria-label=实际排查过程>实际排查过程</a><ul><li><a href=#%e9%97%ae%e9%a2%98%e4%bf%ae%e5%a4%8d aria-label=问题修复>问题修复</a></li></ul></li><li><a href=#%e9%97%ae%e9%a2%98%e5%a4%8d%e7%8e%b0 aria-label=问题复现>问题复现</a><ul><li><a href=#%e6%b5%8b%e8%af%95%e4%bb%a3%e7%a0%81 aria-label=测试代码>测试代码</a></li><li><a href=#%e4%bf%ae%e5%a4%8d%e9%aa%8c%e8%af%81 aria-label=修复验证>修复验证</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li><li><a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=参考资料>参考资料</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{elements&&(activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=问题背景>问题背景<a hidden class=anchor aria-hidden=true href=#问题背景>#</a></h2><p>生产环境有机器产生了oom，一开始怀疑是heap oom，因为之前配置了发生oom，自动进行dump，所以分析了dump文件之后，发现4g的heap，最终dump只有300多m，没有分析出有用的内容。</p><p>后来又一次oom之后，终于在容器控制台发现了错误根因，是Metaspace发生了oom。</p><p>所以着重分析下Metaspace为什么会oom。</p><h2 id=前置知识>前置知识<a hidden class=anchor aria-hidden=true href=#前置知识>#</a></h2><h3 id=启动参数>启动参数<a hidden class=anchor aria-hidden=true href=#启动参数>#</a></h3><p>先看下启动参数，看下JVM具体的参数配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>-</span>Xmx4096M <span style=color:#f92672>-</span>Xms4096M <span style=color:#f92672>-</span>Xmn2048M 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:MaxMetaspaceSize<span style=color:#f92672>=</span><span style=color:#ae81ff>512</span>M <span style=color:#f92672>-</span>XX:MetaspaceSize<span style=color:#f92672>=</span><span style=color:#ae81ff>512</span>M 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>UseConcMarkSweepGC <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>UseCMSInitiatingOccupancyOnly <span style=color:#f92672>-</span>XX:CMSInitiatingOccupancyFraction<span style=color:#f92672>=</span><span style=color:#ae81ff>70</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>ExplicitGCInvokesConcurrentAndUnloadsClasses <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>CMSClassUnloadingEnabled 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>ParallelRefProcEnabled <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>CMSScavengeBeforeRemark 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>HeapDumpOnOutOfMemoryError <span style=color:#f92672>-</span>XX:ErrorFile<span style=color:#f92672>=/</span>data<span style=color:#f92672>/</span>logs<span style=color:#f92672>/</span>hs_err_pid<span style=color:#f92672>%</span>p<span style=color:#f92672>.</span>log <span style=color:#f92672>-</span>Xloggc:<span style=color:#f92672>/</span>dev<span style=color:#f92672>/</span>shm<span style=color:#f92672>/</span>gc<span style=color:#f92672>.</span>log 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:HeapDumpPath<span style=color:#f92672>=/</span>data<span style=color:#f92672>/</span>logs<span style=color:#f92672>/</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCDetails <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCDateStamps 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintClassHistogramBeforeFullGC <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintClassHistogramAfterFullGC 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintCommandLineFlags <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCApplicationConcurrentTime 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCApplicationStoppedTime <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintTenuringDistribution 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintHeapAtGC <span style=color:#f92672>-</span>Ddubbo<span style=color:#f92672>.</span>reference<span style=color:#f92672>.</span>check<span style=color:#f92672>=</span>false 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>UnlockDiagnosticVMOptions
</span></span></code></pre></div><p>这个是公司默认的jvm参数，可以看到，堆最大是4g，metaspace最大是512m，metaspace给的空间已经很大了，但还是发生了oom。</p><p>关于metaspace的大小的配置项，我们后面再提一下具体含义。</p><h3 id=metaspace里有什么>Metaspace里有什么<a hidden class=anchor aria-hidden=true href=#metaspace里有什么>#</a></h3><p>分析Metaspace oom之前，先确认下metaspace里会有哪些东西。jdk1.8相比1.7，移除了perm gen，把class,method,constant pool等内容移到了metaspace，单独的一块区域，和机器内存直接相关，不受堆管控。</p><p>在底层，MetaSpace 主要由 Klass Metaspace 和 NoKlass Metaspace 两大部分组成。</p><p>Klass MetaSpace： 就是用来存 Klass 的，就是 Class 文件在 JVM 里的运行时数据结构，这部分默认放在 Compressed Class Pointer Space 中，是一块连续的内存区域，紧接着 Heap。</p><p>Compressed Class Pointer Space 不是必须有的，如果设置了 -XX:-UseCompressedClassPointers，或者 -Xmx 设置大于 32 G，就不会有这块内存，这种情况下 Klass 都会存在 NoKlass Metaspace 里。</p><p>NoKlass MetaSpace： 专门来存 Klass 相关的其他的内容，比如 Method，ConstantPool 等，可以由多块不连续的内存组成。虽然叫做 NoKlass Metaspace，但是也其实可以存 Klass 的内容，上面已经提到了对应场景。</p><p>MetaSpace 的对象为什么无法释放，我们看下面两点</p><ul><li><strong>MetaSpace 内存管理：</strong> 类和其元数据的生命周期与其对应的类加载器相同，只要类的类加载器是存活的，在 Metaspace 中的类元数据也是存活的，不能被回收。每个加载器有单独的存储空间，通过 ClassLoaderMetaspace 来进行管理 SpaceManager* 的指针，相互隔离的。</li><li><strong>MetaSpace 弹性伸缩：</strong> 由于 MetaSpace 空间和 Heap 并不在一起，所以这块的空间可以不用设置或者单独设置，一般情况下避免 MetaSpace 耗尽 VM 内存都会设置一个 MaxMetaSpaceSize，在运行过程中，如果实际大小小于这个值，JVM 就会通过 <code>-XX:MinMetaspaceFreeRatio</code> 和 <code>-XX:MaxMetaspaceFreeRatio</code> 两个参数动态控制整个 MetaSpace 的大小，这个方法会在 CMSCollector 和 G1CollectorHeap 等几个收集器执行 GC 时调用。这个里面会根据 <code>used_after_gc</code>，<code>MinMetaspaceFreeRatio</code> 和 <code>MaxMetaspaceFreeRatio</code> 这三个值计算出来一个新的 <code>_capacity_until_GC</code> 值（水位线）。然后根据实际的 <code>_capacity_until_GC</code> 值使用 <code>MetaspaceGC::inc_capacity_until_GC()</code> 和 <code>MetaspaceGC::dec_capacity_until_GC()</code> 进行 expand 或 shrink。</li></ul><p>为了避免弹性伸缩带来的额外 GC 消耗，一般要将 <code>-XX:MetaSpaceSize</code> 和 <code>-XX:MaxMetaSpaceSize</code> 两个值设置为固定的，但是这样也会导致在空间不够的时候无法扩容，然后频繁地触发 GC，最终 OOM。</p><p>所以关键原因就是 ClassLoader 不停地在内存中 load 了新的 Class ，一般这种问题都发生在动态类加载等情况上。</p><p>可能出现问题的点有如下几个</p><ul><li>groovy动态加载类</li><li>反射使用不当频繁创建类</li><li>Orika 的 classMap</li><li>JSON 的 ASMSerializer</li></ul><p>基本都集中在反射、Javasisit 字节码增强、CGLIB 动态代理、OSGi 自定义类加载器等的技术点上。</p><h3 id=排查手段>排查手段<a hidden class=anchor aria-hidden=true href=#排查手段>#</a></h3><p>有了上面的背景之后，我们排查方向分为2部分，一部分是看发版记录，最近有哪些改动，哪些地方可能会频繁创建类，二是从jvm层面排查。我们重点说一下jvm层面的排查方向。</p><p><em><strong>注意事项: 写这篇文章的时候，问题已经解决，所以部分数据不是出问题时采集的数据，是为了写文章使用对应的排查工具生成的数据，具体位置处会标明数据来源和时机</strong></em></p><h3 id=jvm排查>JVM排查<a hidden class=anchor aria-hidden=true href=#jvm排查>#</a></h3><p>jdk自带的排查工具，我们可以用的有jps,jstat,jmap等</p><p>其中jmap看的是堆的内存大小和分配</p><p>jstat可以看gc相关信息.</p><p>gc.log里的gc日志也可以辅助我们排查</p><h4 id=jmap>jmap<a hidden class=anchor aria-hidden=true href=#jmap>#</a></h4><p>jmap -heap pid的信息如下，这个可以辅助我们看下堆内分代的内存使用情况，当然这个对我们的排查帮助不大，下面看一下命令效果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Attaching to process ID 5311, please wait...
</span></span><span style=display:flex><span>Debugger attached successfully.
</span></span><span style=display:flex><span>Server compiler detected.
</span></span><span style=display:flex><span>JVM version is 25.73-b02
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>using parallel threads in the new generation.
</span></span><span style=display:flex><span>using thread-local object allocation.
</span></span><span style=display:flex><span>Concurrent Mark-Sweep GC
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Heap Configuration:
</span></span><span style=display:flex><span>   MinHeapFreeRatio         = 40
</span></span><span style=display:flex><span>   MaxHeapFreeRatio         = 70
</span></span><span style=display:flex><span>   MaxHeapSize              = 4294967296 (4096.0MB)
</span></span><span style=display:flex><span>   NewSize                  = 2147483648 (2048.0MB)
</span></span><span style=display:flex><span>   MaxNewSize               = 2147483648 (2048.0MB)
</span></span><span style=display:flex><span>   OldSize                  = 2147483648 (2048.0MB)
</span></span><span style=display:flex><span>   NewRatio                 = 2
</span></span><span style=display:flex><span>   SurvivorRatio            = 8
</span></span><span style=display:flex><span>   MetaspaceSize            = 536870912 (512.0MB)
</span></span><span style=display:flex><span>   CompressedClassSpaceSize = 1073741824 (1024.0MB)
</span></span><span style=display:flex><span>   MaxMetaspaceSize         = 536870912 (512.0MB)
</span></span><span style=display:flex><span>   G1HeapRegionSize         = 0 (0.0MB)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Heap Usage:
</span></span><span style=display:flex><span>New Generation (Eden + 1 Survivor Space):
</span></span><span style=display:flex><span>   capacity = 1932787712 (1843.25MB)
</span></span><span style=display:flex><span>   used     = 735313536 (701.2496337890625MB)
</span></span><span style=display:flex><span>   free     = 1197474176 (1142.0003662109375MB)
</span></span><span style=display:flex><span>   38.04419551276617% used
</span></span><span style=display:flex><span>Eden Space:
</span></span><span style=display:flex><span>   capacity = 1718091776 (1638.5MB)
</span></span><span style=display:flex><span>   used     = 733845856 (699.8499450683594MB)
</span></span><span style=display:flex><span>   free     = 984245920 (938.6500549316406MB)
</span></span><span style=display:flex><span>   42.71284376370823% used
</span></span><span style=display:flex><span>From Space:
</span></span><span style=display:flex><span>   capacity = 214695936 (204.75MB)
</span></span><span style=display:flex><span>   used     = 1467680 (1.399688720703125MB)
</span></span><span style=display:flex><span>   free     = 213228256 (203.35031127929688MB)
</span></span><span style=display:flex><span>   0.683608654800061% used
</span></span><span style=display:flex><span>To Space:
</span></span><span style=display:flex><span>   capacity = 214695936 (204.75MB)
</span></span><span style=display:flex><span>   used     = 0 (0.0MB)
</span></span><span style=display:flex><span>   free     = 214695936 (204.75MB)
</span></span><span style=display:flex><span>   0.0% used
</span></span><span style=display:flex><span>concurrent mark-sweep generation:
</span></span><span style=display:flex><span>   capacity = 2147483648 (2048.0MB)
</span></span><span style=display:flex><span>   used     = 613751744 (585.3192749023438MB)
</span></span><span style=display:flex><span>   free     = 1533731904 (1462.6807250976562MB)
</span></span><span style=display:flex><span>   28.580042719841003% used
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>66527 interned Strings occupying 7048176 bytes.
</span></span></code></pre></div><p>还有一个命令是jmap -histo pid，这个可以看堆内存活的对象类型和实例数量</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span> num     #instances         #bytes  class name
</span></span><span style=display:flex><span>----------------------------------------------
</span></span><span style=display:flex><span>   1:       5478775      506824136  [C
</span></span><span style=display:flex><span>   2:       1421313      315369496  [B
</span></span><span style=display:flex><span>   3:       3791992       91007808  java.lang.String
</span></span><span style=display:flex><span>   4:       2593077       82978464  java.util.HashMap$Node
</span></span><span style=display:flex><span>   5:        730043       78351624  [I
</span></span><span style=display:flex><span>   6:       1393624       67623928  [Ljava.lang.Object;
</span></span><span style=display:flex><span>   7:        712992       62743296  java.lang.reflect.Method
</span></span><span style=display:flex><span>   8:        317758       48979560  [Ljava.util.HashMap$Node;
</span></span><span style=display:flex><span>   9:        178237       32795608  com.fasterxml.jackson.core.json.UTF8StreamJsonParser
</span></span><span style=display:flex><span>  10:        513502       20540080  java.util.LinkedHashMap$Entry
</span></span><span style=display:flex><span>  11:        639968       20478976  com.mysql.cj.conf.BooleanProperty
</span></span><span style=display:flex><span>  12:        941240       18059848  [Ljava.lang.Class;
</span></span><span style=display:flex><span>  13:        353510       16968480  java.util.HashMap
</span></span><span style=display:flex><span>  14:        241178       13505968  sun.nio.cs.UTF_8$Encoder
</span></span><span style=display:flex><span>  15:        539462       12947088  java.lang.StringBuilder
</span></span><span style=display:flex><span>  16:        178448       12848256  com.fasterxml.jackson.databind.deser.DefaultDeserializationContext$Impl
</span></span><span style=display:flex><span>  17:        218814       12253584  com.fasterxml.jackson.core.io.IOContext
</span></span></code></pre></div><h4 id=jstat>jstat<a hidden class=anchor aria-hidden=true href=#jstat>#</a></h4><p>使用jstat观察gc和metaspace的使用情况，jstat主要输出各个区域的使用量比例(<em><strong>写这篇文章的时候问题已修复，所以metaspace使用占比比较平稳</strong></em>)</p><p><code>jstat -gcutil 5311</code> 这个命令以1000ms为间隔，输出pid 5311的进程的gc情况，从这里可以看出metaspace的使用比例的变化</p><p>比如s0是survivo 0当前空间的已使用比例，s1的survivo 1当前空间的已使用比例，E是eden区的已使用比例，O是old gen的已使用比例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   
</span></span><span style=display:flex><span>  0.00   1.04  57.32  27.40  92.59  86.14 125511 1969.952    28    5.062 1975.014
</span></span><span style=display:flex><span>  0.00   1.04  78.69  27.40  92.59  86.14 125511 1969.952    28    5.062 1975.014
</span></span><span style=display:flex><span>  0.00   1.04  97.81  27.40  92.59  86.14 125511 1969.952    28    5.062 1975.014
</span></span><span style=display:flex><span>  0.98   0.00  32.47  27.40  92.59  86.14 125512 1969.968    28    5.062 1975.031
</span></span><span style=display:flex><span>  0.98   0.00  66.19  27.40  92.59  86.14 125512 1969.968    28    5.062 1975.031
</span></span><span style=display:flex><span>  0.98   0.00  91.34  27.40  92.59  86.14 125512 1969.968    28    5.062 1975.031
</span></span><span style=display:flex><span>  0.00   0.81  17.07  27.41  92.59  86.14 125513 1969.980    28    5.062 1975.042
</span></span><span style=display:flex><span>  0.00   0.81  39.36  27.41  92.59  86.14 125513 1969.980    28    5.062 1975.042
</span></span><span style=display:flex><span>  0.00   0.81  60.87  27.41  92.59  86.14 125513 1969.980    28    5.062 1975.042
</span></span><span style=display:flex><span>  0.00   0.81  89.84  27.41  92.59  86.14 125513 1969.980    28    5.062 1975.042
</span></span><span style=display:flex><span>  0.89   0.00   9.76  27.42  92.59  86.14 125514 1969.995    28    5.062 1975.058
</span></span><span style=display:flex><span>  0.89   0.00  25.07  27.42  92.59  86.14 125514 1969.995    28    5.062 1975.058
</span></span><span style=display:flex><span>  0.89   0.00  44.26  27.42  92.59  86.14 125514 1969.995    28    5.062 1975.058
</span></span></code></pre></div><h4 id=gclog>gc.log<a hidden class=anchor aria-hidden=true href=#gclog>#</a></h4><p>另一个就是从gc.log里查看metaspace的日志,下面一段日志是gc前和gc后各个区域的内存变化</p><p>可以观察下heap before gc和heap after gc2处的metaspace空间使用变化(<em><strong>此处是问题解决后的gc.log,仅供参考</strong></em>)</p><p>metaspace数据如下，可以看到距离512m还有足够的空间，注意此处是问题解决后的数据，仅供排查参考</p><ul><li>used 176869K， 已使用大概是172m</li><li>capacity 189800K， 容量大概是185m</li><li>committed 190848K，已提交大概是186m</li><li>reserved 1216512K，保留大概是1188m</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>2023-09-12T09:03:08.449+0800: 1249459.698: Total time for which application threads were stopped: 0.0195137 seconds, Stopping threads took: 0.0001738 seconds
</span></span><span style=display:flex><span>2023-09-12T09:03:11.392+0800: 1249462.641: Application time: 2.9429699 seconds
</span></span><span style=display:flex><span>2023-09-12T09:03:11.396+0800: 1249462.646: Total time for which application threads were stopped: 0.0046629 seconds, Stopping threads took: 0.0002150 seconds
</span></span><span style=display:flex><span>2023-09-12T09:03:11.397+0800: 1249462.646: Application time: 0.0000922 seconds
</span></span><span style=display:flex><span>2023-09-12T09:03:11.400+0800: 1249462.649: Total time for which application threads were stopped: 0.0034414 seconds, Stopping threads took: 0.0001087 seconds
</span></span><span style=display:flex><span>2023-09-12T09:03:14.304+0800: 1249465.553: Application time: 2.9035482 seconds
</span></span><span style=display:flex><span>{Heap before GC invocations=130961 (full 14):
</span></span><span style=display:flex><span> par new generation   total 1887488K, used 1679309K [0x00000006c0000000, 0x0000000740000000, 0x0000000740000000)
</span></span><span style=display:flex><span>  eden space 1677824K, 100% used [0x00000006c0000000, 0x0000000726680000, 0x0000000726680000)
</span></span><span style=display:flex><span>  from space 209664K,   0% used [0x0000000733340000, 0x00000007334b34a0, 0x0000000740000000)
</span></span><span style=display:flex><span>  to   space 209664K,   0% used [0x0000000726680000, 0x0000000726680000, 0x0000000733340000)
</span></span><span style=display:flex><span> concurrent mark-sweep generation total 2097152K, used 1209833K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000)
</span></span><span style=display:flex><span> Metaspace       used 176869K, capacity 189800K, committed 190848K, reserved 1216512K
</span></span><span style=display:flex><span>  class space    used 19973K, capacity 22145K, committed 23168K, reserved 1048576K
</span></span><span style=display:flex><span>2023-09-12T09:03:14.307+0800: 1249465.557: [GC (Allocation Failure) 2023-09-12T09:03:14.307+0800: 1249465.557: [ParNew
</span></span><span style=display:flex><span>Desired survivor size 107347968 bytes, new threshold 6 (max 6)
</span></span><span style=display:flex><span>- age   1:     674280 bytes,     674280 total
</span></span><span style=display:flex><span>- age   2:     177208 bytes,     851488 total
</span></span><span style=display:flex><span>- age   3:     238904 bytes,    1090392 total
</span></span><span style=display:flex><span>- age   4:     191384 bytes,    1281776 total
</span></span><span style=display:flex><span>- age   5:      38080 bytes,    1319856 total
</span></span><span style=display:flex><span>- age   6:      40232 bytes,    1360088 total
</span></span><span style=display:flex><span>: 1679309K-&gt;1868K(1887488K), 0.0143320 secs] 2889142K-&gt;1211742K(3984640K), 0.0146560 secs] [Times: user=0.03 sys=0.01, real=0.01 secs] 
</span></span><span style=display:flex><span>Heap after GC invocations=130962 (full 14):
</span></span><span style=display:flex><span> par new generation   total 1887488K, used 1868K [0x00000006c0000000, 0x0000000740000000, 0x0000000740000000)
</span></span><span style=display:flex><span>  eden space 1677824K,   0% used [0x00000006c0000000, 0x00000006c0000000, 0x0000000726680000)
</span></span><span style=display:flex><span>  from space 209664K,   0% used [0x0000000726680000, 0x0000000726853010, 0x0000000733340000)
</span></span><span style=display:flex><span>  to   space 209664K,   0% used [0x0000000733340000, 0x0000000733340000, 0x0000000740000000)
</span></span><span style=display:flex><span> concurrent mark-sweep generation total 2097152K, used 1209874K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000)
</span></span><span style=display:flex><span> Metaspace       used 176869K, capacity 189800K, committed 190848K, reserved 1216512K
</span></span><span style=display:flex><span>  class space    used 19973K, capacity 22145K, committed 23168K, reserved 1048576K
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=jcmd>jcmd<a hidden class=anchor aria-hidden=true href=#jcmd>#</a></h4><p>最后一个可用的jvm工具就是cmd，使用jcmd打印下class数量，看下哪些包下的类增长比较快</p><p>使用命令如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>jcmd &lt;PID&gt; GC.class_stats|awk &#39;{print$13}&#39;|sed  &#39;s/\(.*\)\.\(.*\)/\1/g&#39;|sort |uniq -c|sort -nrk1
</span></span></code></pre></div><p>实际进程打印如下,可以看到最多的是sun.reflect包下的class最多</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>   2283 sun.reflect
</span></span><span style=display:flex><span>    416 com.xx.xx.xx.xx.impl
</span></span><span style=display:flex><span>    316 java.lang.invoke
</span></span><span style=display:flex><span>    306 com.sun.proxy
</span></span><span style=display:flex><span>    275 reactor.core.publisher
</span></span><span style=display:flex><span>    268 java.util
</span></span><span style=display:flex><span>    198 com.google.common.collect
</span></span><span style=display:flex><span>    189 com.google.protobuf
</span></span><span style=display:flex><span>    181 io.netty.channel
</span></span><span style=display:flex><span>    174 java.lang
</span></span></code></pre></div><h3 id=dump分析>dump分析<a hidden class=anchor aria-hidden=true href=#dump分析>#</a></h3><p>dump 快照之后通过 JProfiler 或 MAT 观察 Classes 的 Histogram (直方图) ，这个估计得深厚的功力才能看出来</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131533501.png alt=image-20230912134908936></p><h3 id=arthas>arthas<a hidden class=anchor aria-hidden=true href=#arthas>#</a></h3><p>arthas也有很多的命令可以帮助排查，比如dashboard，可以看metaspace区的内存占用，vmtool可以查看具体的class</p><p>如下是dashborad命令，可以看到metaspace的使用量</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131533082.png alt=image-20230912135302354></p><p>可以使用vmtool，匹配指定包名的class</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>vmtool <span style=color:#f92672>--</span>action getInstances <span style=color:#f92672>--</span>className sun<span style=color:#f92672>.</span>reflect<span style=color:#f92672>.*</span> <span style=color:#f92672>--</span>limit <span style=color:#ae81ff>100</span>
</span></span></code></pre></div><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131533919.png alt=image-20230912135822213></p><p>可以使用transform，有类加载的时候就会触发</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>watch java.lang.instrument.ClassFileTransformer transform &#39;{params,returnObj,throwExp}&#39;  -n 5  -x 3
</span></span></code></pre></div><p>也可以跟踪下class init</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>stack sun.reflect.DelegatingClassLoader &lt;init&gt;  -n 5
</span></span></code></pre></div><h2 id=实际排查过程>实际排查过程<a hidden class=anchor aria-hidden=true href=#实际排查过程>#</a></h2><p>前面介绍了一些关于metaspace的知识，也介绍了一些排查方向，接下来介绍下实际排查过程</p><p>接到告警之后，查看进程，发现了metaspace oom的错误，于是开始往metaspace oom的方向开始排查</p><p>经过一通google/baidu之后，发现了如上介绍的一些方向和手段</p><p>首先是看了美团的文章<a href=https://tech.meituan.com/2020/11/12/java-9-cms-gc.html>场景三：MetaSpace 区 OOM</a></p><p>发现可以使用jcmd命令进行排查，看下哪个包的class比较多，执行以下命令，得到如下的结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>jcmd 5311 GC.class_stats|awk &#39;{print$13}&#39;|sed  &#39;s/\(.*\)\.\(.*\)/\1/g&#39;|sort |uniq -c|sort -nrk1|head -n 10
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> 2294 sun.reflect
</span></span><span style=display:flex><span>    416 com.xx.impl
</span></span><span style=display:flex><span>    316 java.lang.invoke
</span></span><span style=display:flex><span>    316 com.sun.proxy
</span></span><span style=display:flex><span>    275 reactor.core.publisher
</span></span><span style=display:flex><span>    268 java.util
</span></span><span style=display:flex><span>    198 com.google.common.collect
</span></span><span style=display:flex><span>    189 com.google.protobuf
</span></span><span style=display:flex><span>    181 io.netty.channel
</span></span><span style=display:flex><span>    174 java.lang
</span></span></code></pre></div><p>多次执行jcmd之后，发现sun.reflect包下的class比较多，且有增长，于是把目光放在了sun.reflect上。</p><p>以为是反射用的不当导致的，然后使用arthas，分析了dashboard以及使用了vmtool查看sun.reflect包的instance。</p><p>当时使用dashboard分析，metaspace上涨的非常的快，然后使用vmtool命令查看sun.reflect</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>vmtool <span style=color:#f92672>--</span>action getInstances <span style=color:#f92672>--</span>className sun<span style=color:#f92672>.</span>reflect<span style=color:#f92672>.*</span> <span style=color:#f92672>--</span>limit <span style=color:#ae81ff>100</span>
</span></span></code></pre></div><p>执行结果类似下图</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131533382.png alt=image-20230912135822213></p><p>分析发现里面有mytabis，也有自己调用产生的反射，但是不足以导致metaspace oom</p><p>后来想到了加上如下2个参数,用于打印类加载、卸载日志</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>TraceClassLoading <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>TraceClassUnloading
</span></span></code></pre></div><p>由于发布系统默认没打nohup日志，所以在这里走了点弯路，类加载、卸载信息没打到日志里，后来上机器手动用nohup java -jar xx.jar &之后，发现了端倪</p><p>可以看到启动之后，打了比较多的类似下面的这些日志，可以初步判断是com.googlecode.aviator.Expression使用不当造成的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[Loaded Script_1691559755244_2757/2021240514 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559755339_2758/6228193 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559755492_2759/419920034 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756493_2760/1460748148 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756500_2761/520805009 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756506_2762/398664510 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756573_2763/306461935 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756577_2764/1116508142 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756791_2765/870354750 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756799_2766/1661127610 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756812_2767/1883979577 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559757019_2768/1281538781 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559757332_2769/589742334 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559757338_2770/1560860126 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559757977_2771/213218340 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559758313_2772/505164301 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559758318_2773/601453331 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759007_2774/1011764766 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759014_2775/338373159 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759146_2776/1714310047 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759154_2777/1663245165 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759227_2778/797537408 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759234_2779/551097430 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759553_2780/594411270 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759559_2781/1720465741 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759586_2782/215181464 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759601_2783/2036721542 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759797_2784/1723282218 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759802_2785/953430028 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759942_2786/847216521 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759949_2787/1763495463 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559760350_2788/47562916 from com.googlecode.aviator.Expression]
</span></span></code></pre></div><p>跟着com.googlecode.aviator.Expression这个类，发现可能造成异常的代码如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Expression expression = AviatorEvaluator.compile(ruleExpressProcessed);
</span></span></code></pre></div><p>这个还有一个重载方法,是否缓存</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>public static Expression compile(String expression, boolean cached) {
</span></span><span style=display:flex><span>        return getInstance().compile(expression, cached);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>跟踪代码，最后会发现cached字段会影响classloader的获取，如果cached=true,则会使用已缓存的classloader，如果false每次都会new 一个新的classloader</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>com.googlecode.aviator.AviatorEvaluatorInstance#newCodeGenerator(java.lang.String, boolean)
</span></span></code></pre></div><h3 id=问题修复>问题修复<a hidden class=anchor aria-hidden=true href=#问题修复>#</a></h3><p>将cached设置为true,metaspace使用率就很平稳了，不会出现高频的类加载和卸载情况。</p><h2 id=问题复现>问题复现<a hidden class=anchor aria-hidden=true href=#问题复现>#</a></h2><p>本打算在本地复现下这个问题的，但是本地能gc掉，生产环境由于每次2-3天才会发生oom，所以没有发现oom的时候，metaspace里有哪些元素，可以看下本地验证过程和现象，帮助理解</p><h3 id=测试代码>测试代码<a hidden class=anchor aria-hidden=true href=#测试代码>#</a></h3><p>maven依赖</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>        &lt;dependency&gt;
</span></span><span style=display:flex><span>            &lt;groupId&gt;com.googlecode.aviator&lt;/groupId&gt;
</span></span><span style=display:flex><span>            &lt;artifactId&gt;aviator&lt;/artifactId&gt;
</span></span><span style=display:flex><span>            &lt;version&gt;5.2.5&lt;/version&gt;
</span></span><span style=display:flex><span>        &lt;/dependency&gt;
</span></span></code></pre></div><p>jvm参数</p><p>堆设置的比较大,metaspace只设置了128m</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>-</span>Xmx4096M
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Xms4096M
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Xmn2048M
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:MaxMetaspaceSize<span style=color:#f92672>=</span><span style=color:#ae81ff>128</span>M
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:MetaspaceSize<span style=color:#f92672>=</span><span style=color:#ae81ff>128</span>M
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>UseConcMarkSweepGC
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>UseCMSInitiatingOccupancyOnly
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:CMSInitiatingOccupancyFraction<span style=color:#f92672>=</span><span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>ExplicitGCInvokesConcurrentAndUnloadsClasses
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>CMSClassUnloadingEnabled
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>ParallelRefProcEnabled
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>CMSScavengeBeforeRemark
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>HeapDumpOnOutOfMemoryError
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:ErrorFile<span style=color:#f92672>=/</span>data<span style=color:#f92672>/</span>logs<span style=color:#f92672>/</span>hs_err_pid<span style=color:#f92672>%</span>p<span style=color:#f92672>.</span>log
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Xloggc:<span style=color:#f92672>/</span>dev<span style=color:#f92672>/</span>shm<span style=color:#f92672>/</span>gc<span style=color:#f92672>.</span>log
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:HeapDumpPath<span style=color:#f92672>=/</span>data<span style=color:#f92672>/</span>logs<span style=color:#f92672>/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCDetails
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCDateStamps
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintClassHistogramBeforeFullGC
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintClassHistogramAfterFullGC
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintCommandLineFlags
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCApplicationConcurrentTime
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCApplicationStoppedTime
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintTenuringDistribution
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintHeapAtGC
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Ddubbo<span style=color:#f92672>.</span>reference<span style=color:#f92672>.</span>check<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>UnlockDiagnosticVMOptions
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:NativeMemoryTracking<span style=color:#f92672>=</span>detail
</span></span><span style=display:flex><span><span style=color:#f92672>//</span><span style=color:#66d9ef>class</span> loading unloading
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>TraceClassLoading
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>TraceClassUnloading
</span></span></code></pre></div><p>使用多线程去并发访问</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>public static void main(String[] args) {
</span></span><span style=display:flex><span>        ThreadFactory threadFactory = new ThreadFactoryBuilder().setNameFormat(&#34;test-pool-%d&#34;).build();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ThreadPoolExecutor executor = new ThreadPoolExecutor(50, 50, 1, TimeUnit.SECONDS, new LinkedBlockingQueue&lt;&gt;(50), threadFactory);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        for (int i = 0; i &lt; 32; i++) {
</span></span><span style=display:flex><span>            executor.execute(() -&gt; {
</span></span><span style=display:flex><span>                while (true) {
</span></span><span style=display:flex><span>                    try {
</span></span><span style=display:flex><span>                        String rule = &#34;field01+ field02&#34;;
</span></span><span style=display:flex><span>                        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
</span></span><span style=display:flex><span>                        int random1 = new Random().nextInt();
</span></span><span style=display:flex><span>                        int random2 = new Random().nextInt();
</span></span><span style=display:flex><span>                        map.put(&#34;field01&#34;, random1);
</span></span><span style=display:flex><span>                        map.put(&#34;field02&#34;, random2);
</span></span><span style=display:flex><span>                        Expression compiledExp = AviatorEvaluator.compile(rule);
</span></span><span style=display:flex><span>                        Object obj = compiledExp.execute(map);
</span></span><span style=display:flex><span>                        System.out.println(obj);
</span></span><span style=display:flex><span>                    } catch (Exception e) {
</span></span><span style=display:flex><span>                        e.printStackTrace();
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>控制台也输出了同样的日志</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131532929.png alt=image-20230912163302034></p><p>然后使用jconsole连到jvm上观察内存使用情况</p><p>首先是metaspace的使用情况，最高是到50m，然后gc掉，持续这一过程，说明metaspace使用量在上升，但是能gc的掉，而且不会触发阈值。</p><p>生产上发生oom，可能有流量因素，访问量比本地模拟的大。</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141028935.png alt=image-20230914102800888></p><p>在看下类的加载卸载情况，程序运行了1个半小时，加载和卸载数量差不多持平，大概6529万次，可以发现类是一直在加载，但是本地模拟的情况下，卸载的也快，生产上的具体细节由于网络隔离问题，无法模拟出，仅能根据加载数量看出类加载数量异常了，这块代码是有问题的</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141026106.png alt=image-20230914102639065></p><p>概览里可以看到已加载的类的数量，在一个区间范围内波动，一边加载一边卸载</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141308641.png alt=image-20230914130832590></p><h3 id=修复验证>修复验证<a hidden class=anchor aria-hidden=true href=#修复验证>#</a></h3><p>代码修改如下，将cached设置为true</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Expression compiledExp = AviatorEvaluator.compile(rule,true);
</span></span></code></pre></div><p>概览数据如下，可以发现类只加载了2000多个就平稳了，不会加载新的class</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141322257.png alt=image-20230914132245192></p><p>metaspace使用量稳定在13m,不会波动</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141323256.png alt=image-20230914132321198></p><p>类在加载了2274个之后保持稳定，没有新增</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141323853.png alt=image-20230914132359797></p><p>根据修改之后的现象判断，造成问题的原因就是每次都会new classloader，导致类频繁加载卸载，叠加生产流量不可控，极端情况可能就会导致oom</p><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>由于未设置metaspace区监控，具体的原因暂未发现，比如Metaspace里的class数量占比，分类等。</p><p>修复之后再上线，使用arthas观察metaspace使用量，发现metaspace区域内存使用量。</p><p>关于metaspace的可用资料，相比于堆内存的oom来说，比较少，所以排查下来也没有那么顺利，不过经过这次问题排查，对metaspace有了一定的了解，下次再排查问题时，可以有更好的切入方向了</p><h2 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h2><ul><li><a href=https://tech.meituan.com/2020/11/12/java-9-cms-gc.html>场景三：MetaSpace 区 OOM</a></li><li><a href=https://www.javadoop.com/post/metaspace>深入理解堆外内存metaspace</a></li></ul></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://blog.thend03.com/img/wechat-pay.png alt=wechat_pay></a><p>微信</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://blog.thend03.com/img/alipay.png alt=alipay></a><p>支付宝</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>🧧 鼓励</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://blog.thend03.com/posts/heap-oom/><span class=title>« 上一页</span><br><span>heap-oom</span>
</a><a class=next href=https://blog.thend03.com/posts/dubbo-spi/><span class=title>下一页 »</span><br><span>dubbo spi</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share metaspace-oom on twitter" href="https://twitter.com/intent/tweet/?text=metaspace-oom&amp;url=https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f&amp;hashtags=jvm%2coom"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share metaspace-oom on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f&amp;title=metaspace-oom&amp;summary=metaspace-oom&amp;source=https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share metaspace-oom on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f&title=metaspace-oom"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share metaspace-oom on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share metaspace-oom on whatsapp" href="https://api.whatsapp.com/send?text=metaspace-oom%20-%20https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share metaspace-oom on telegram" href="https://telegram.me/share/url?text=metaspace-oom&amp;url=https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></div><style>.comments_details summary::marker{font-size:20px;content:'👉展开评论';color:var(--content)}.comments_details[open] summary::marker{font-size:20px;content:'👇关闭评论';color:var(--content)}</style><div><details class=comments_details open><summary style="cursor:pointer;margin:50px 0 20px;width:130px"><span style=font-size:20px;color:var(--content)>...</span></summary><div id=tcomment></div></details><script src=https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js></script><script>twikoo.init({envId:"https://twikoo-e1f2-2yfafx14j-thend03s-projects.vercel.app/",el:"#tcomment",lang:"zh-CN",region:null,path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>Copyright
&copy;
2020-2024
<a href=https://blog.thend03.com/ style=color:#939393>Fayy&amp;Fc's Blog</a>
All Rights Reserved
</span><a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393></a>&nbsp;
<span><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null" style=display:inline-block;text-decoration:none;height:20px;color:#939393><img src style="float:left;margin:0 5px 0 0">
</a></span><span id=busuanzi_container><span class="fa fa-user"></span> <span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye"></span> <span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
<span id=read_progress></span>
</span></a><script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString(),s=window.getSelection().toString();t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="复制";function i(){t.innerText="已复制！",setTimeout(()=>{t.innerText="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>