<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>metaspace-oom | Fayy&amp;Fc's Blog</title><meta name=keywords content="jvm,oom"><meta name=description content="metaspace oom"><meta name=author content="since"><link rel=canonical href=https://blog.thend03.com/posts/metaspace-oom/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://blog.thend03.com/img/logo.jpg><link rel=icon type=image/png sizes=16x16 href=https://blog.thend03.com/img/logo.jpg><link rel=icon type=image/png sizes=32x32 href=https://blog.thend03.com/img/logo.jpg><link rel=apple-touch-icon href=https://blog.thend03.com/img/logo.jpg><link rel=mask-icon href=https://blog.thend03.com/img/logo.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.thend03.com/posts/metaspace-oom/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="metaspace-oom"><meta property="og:description" content="metaspace oom"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.thend03.com/posts/metaspace-oom/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-07T09:47:33+08:00"><meta property="article:modified_time" content="2023-09-07T09:47:33+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="metaspace-oom"><meta name=twitter:description content="metaspace oom"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“šæ–‡ç« ","item":"https://blog.thend03.com/posts/"},{"@type":"ListItem","position":2,"name":"metaspace-oom","item":"https://blog.thend03.com/posts/metaspace-oom/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"metaspace-oom","name":"metaspace-oom","description":"metaspace oom","keywords":["jvm","oom"],"articleBody":"é—®é¢˜èƒŒæ™¯ ç”Ÿäº§ç¯å¢ƒæœ‰æœºå™¨äº§ç”Ÿäº†oomï¼Œä¸€å¼€å§‹æ€€ç–‘æ˜¯heap oomï¼Œå› ä¸ºä¹‹å‰é…ç½®äº†å‘ç”Ÿoomï¼Œè‡ªåŠ¨è¿›è¡Œdumpï¼Œæ‰€ä»¥åˆ†æäº†dumpæ–‡ä»¶ä¹‹åï¼Œå‘ç°4gçš„heapï¼Œæœ€ç»ˆdumpåªæœ‰300å¤šmï¼Œæ²¡æœ‰åˆ†æå‡ºæœ‰ç”¨çš„å†…å®¹ã€‚\nåæ¥åˆä¸€æ¬¡oomä¹‹åï¼Œç»ˆäºåœ¨å®¹å™¨æ§åˆ¶å°å‘ç°äº†é”™è¯¯æ ¹å› ï¼Œæ˜¯Metaspaceå‘ç”Ÿäº†oomã€‚\næ‰€ä»¥ç€é‡åˆ†æä¸‹Metaspaceä¸ºä»€ä¹ˆä¼šoomã€‚\nå‰ç½®çŸ¥è¯† å¯åŠ¨å‚æ•° å…ˆçœ‹ä¸‹å¯åŠ¨å‚æ•°ï¼Œçœ‹ä¸‹JVMå…·ä½“çš„å‚æ•°é…ç½®\n-Xmx4096M -Xms4096M -Xmn2048M -XX:MaxMetaspaceSize=512M -XX:MetaspaceSize=512M -XX:+UseConcMarkSweepGC -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses -XX:+CMSClassUnloadingEnabled -XX:+ParallelRefProcEnabled -XX:+CMSScavengeBeforeRemark -XX:+HeapDumpOnOutOfMemoryError -XX:ErrorFile=/data/logs/hs_err_pid%p.log -Xloggc:/dev/shm/gc.log -XX:HeapDumpPath=/data/logs/ -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintClassHistogramBeforeFullGC -XX:+PrintClassHistogramAfterFullGC -XX:+PrintCommandLineFlags -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGCApplicationStoppedTime -XX:+PrintTenuringDistribution -XX:+PrintHeapAtGC -Ddubbo.reference.check=false -XX:+UnlockDiagnosticVMOptions è¿™ä¸ªæ˜¯å…¬å¸é»˜è®¤çš„jvmå‚æ•°ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå †æœ€å¤§æ˜¯4gï¼Œmetaspaceæœ€å¤§æ˜¯512mï¼Œmetaspaceç»™çš„ç©ºé—´å·²ç»å¾ˆå¤§äº†ï¼Œä½†è¿˜æ˜¯å‘ç”Ÿäº†oomã€‚\nå…³äºmetaspaceçš„å¤§å°çš„é…ç½®é¡¹ï¼Œæˆ‘ä»¬åé¢å†æä¸€ä¸‹å…·ä½“å«ä¹‰ã€‚\nMetaspaceé‡Œæœ‰ä»€ä¹ˆ åˆ†æMetaspace oomä¹‹å‰ï¼Œå…ˆç¡®è®¤ä¸‹metaspaceé‡Œä¼šæœ‰å“ªäº›ä¸œè¥¿ã€‚jdk1.8ç›¸æ¯”1.7ï¼Œç§»é™¤äº†perm genï¼ŒæŠŠclass,method,constant poolç­‰å†…å®¹ç§»åˆ°äº†metaspaceï¼Œå•ç‹¬çš„ä¸€å—åŒºåŸŸï¼Œå’Œæœºå™¨å†…å­˜ç›´æ¥ç›¸å…³ï¼Œä¸å—å †ç®¡æ§ã€‚\nåœ¨åº•å±‚ï¼ŒMetaSpace ä¸»è¦ç”± Klass Metaspace å’Œ NoKlass Metaspace ä¸¤å¤§éƒ¨åˆ†ç»„æˆã€‚\nKlass MetaSpaceï¼š å°±æ˜¯ç”¨æ¥å­˜ Klass çš„ï¼Œå°±æ˜¯ Class æ–‡ä»¶åœ¨ JVM é‡Œçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼Œè¿™éƒ¨åˆ†é»˜è®¤æ”¾åœ¨ Compressed Class Pointer Space ä¸­ï¼Œæ˜¯ä¸€å—è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œç´§æ¥ç€ Heapã€‚\nCompressed Class Pointer Space ä¸æ˜¯å¿…é¡»æœ‰çš„ï¼Œå¦‚æœè®¾ç½®äº† -XX:-UseCompressedClassPointersï¼Œæˆ–è€… -Xmx è®¾ç½®å¤§äº 32 Gï¼Œå°±ä¸ä¼šæœ‰è¿™å—å†…å­˜ï¼Œè¿™ç§æƒ…å†µä¸‹ Klass éƒ½ä¼šå­˜åœ¨ NoKlass Metaspace é‡Œã€‚\nNoKlass MetaSpaceï¼š ä¸“é—¨æ¥å­˜ Klass ç›¸å…³çš„å…¶ä»–çš„å†…å®¹ï¼Œæ¯”å¦‚ Methodï¼ŒConstantPool ç­‰ï¼Œå¯ä»¥ç”±å¤šå—ä¸è¿ç»­çš„å†…å­˜ç»„æˆã€‚è™½ç„¶å«åš NoKlass Metaspaceï¼Œä½†æ˜¯ä¹Ÿå…¶å®å¯ä»¥å­˜ Klass çš„å†…å®¹ï¼Œä¸Šé¢å·²ç»æåˆ°äº†å¯¹åº”åœºæ™¯ã€‚\nMetaSpace çš„å¯¹è±¡ä¸ºä»€ä¹ˆæ— æ³•é‡Šæ”¾ï¼Œæˆ‘ä»¬çœ‹ä¸‹é¢ä¸¤ç‚¹\nMetaSpace å†…å­˜ç®¡ç†ï¼š ç±»å’Œå…¶å…ƒæ•°æ®çš„ç”Ÿå‘½å‘¨æœŸä¸å…¶å¯¹åº”çš„ç±»åŠ è½½å™¨ç›¸åŒï¼Œåªè¦ç±»çš„ç±»åŠ è½½å™¨æ˜¯å­˜æ´»çš„ï¼Œåœ¨ Metaspace ä¸­çš„ç±»å…ƒæ•°æ®ä¹Ÿæ˜¯å­˜æ´»çš„ï¼Œä¸èƒ½è¢«å›æ”¶ã€‚æ¯ä¸ªåŠ è½½å™¨æœ‰å•ç‹¬çš„å­˜å‚¨ç©ºé—´ï¼Œé€šè¿‡ ClassLoaderMetaspace æ¥è¿›è¡Œç®¡ç† SpaceManager* çš„æŒ‡é’ˆï¼Œç›¸äº’éš”ç¦»çš„ã€‚ MetaSpace å¼¹æ€§ä¼¸ç¼©ï¼š ç”±äº MetaSpace ç©ºé—´å’Œ Heap å¹¶ä¸åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥è¿™å—çš„ç©ºé—´å¯ä»¥ä¸ç”¨è®¾ç½®æˆ–è€…å•ç‹¬è®¾ç½®ï¼Œä¸€èˆ¬æƒ…å†µä¸‹é¿å… MetaSpace è€—å°½ VM å†…å­˜éƒ½ä¼šè®¾ç½®ä¸€ä¸ª MaxMetaSpaceSizeï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®é™…å¤§å°å°äºè¿™ä¸ªå€¼ï¼ŒJVM å°±ä¼šé€šè¿‡ -XX:MinMetaspaceFreeRatio å’Œ -XX:MaxMetaspaceFreeRatio ä¸¤ä¸ªå‚æ•°åŠ¨æ€æ§åˆ¶æ•´ä¸ª MetaSpace çš„å¤§å°ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨ CMSCollector å’Œ G1CollectorHeap ç­‰å‡ ä¸ªæ”¶é›†å™¨æ‰§è¡Œ GC æ—¶è°ƒç”¨ã€‚è¿™ä¸ªé‡Œé¢ä¼šæ ¹æ® used_after_gcï¼ŒMinMetaspaceFreeRatio å’Œ MaxMetaspaceFreeRatio è¿™ä¸‰ä¸ªå€¼è®¡ç®—å‡ºæ¥ä¸€ä¸ªæ–°çš„ _capacity_until_GC å€¼ï¼ˆæ°´ä½çº¿ï¼‰ã€‚ç„¶åæ ¹æ®å®é™…çš„ _capacity_until_GC å€¼ä½¿ç”¨ MetaspaceGC::inc_capacity_until_GC() å’Œ MetaspaceGC::dec_capacity_until_GC() è¿›è¡Œ expand æˆ– shrinkã€‚ ä¸ºäº†é¿å…å¼¹æ€§ä¼¸ç¼©å¸¦æ¥çš„é¢å¤– GC æ¶ˆè€—ï¼Œä¸€èˆ¬è¦å°† -XX:MetaSpaceSize å’Œ -XX:MaxMetaSpaceSize ä¸¤ä¸ªå€¼è®¾ç½®ä¸ºå›ºå®šçš„ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¼šå¯¼è‡´åœ¨ç©ºé—´ä¸å¤Ÿçš„æ—¶å€™æ— æ³•æ‰©å®¹ï¼Œç„¶åé¢‘ç¹åœ°è§¦å‘ GCï¼Œæœ€ç»ˆ OOMã€‚\næ‰€ä»¥å…³é”®åŸå› å°±æ˜¯ ClassLoader ä¸åœåœ°åœ¨å†…å­˜ä¸­ load äº†æ–°çš„ Class ï¼Œä¸€èˆ¬è¿™ç§é—®é¢˜éƒ½å‘ç”Ÿåœ¨åŠ¨æ€ç±»åŠ è½½ç­‰æƒ…å†µä¸Šã€‚\nå¯èƒ½å‡ºç°é—®é¢˜çš„ç‚¹æœ‰å¦‚ä¸‹å‡ ä¸ª\ngroovyåŠ¨æ€åŠ è½½ç±» åå°„ä½¿ç”¨ä¸å½“é¢‘ç¹åˆ›å»ºç±» Orika çš„ classMap JSON çš„ ASMSerializer åŸºæœ¬éƒ½é›†ä¸­åœ¨åå°„ã€Javasisit å­—èŠ‚ç å¢å¼ºã€CGLIB åŠ¨æ€ä»£ç†ã€OSGi è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç­‰çš„æŠ€æœ¯ç‚¹ä¸Šã€‚\næ’æŸ¥æ‰‹æ®µ æœ‰äº†ä¸Šé¢çš„èƒŒæ™¯ä¹‹åï¼Œæˆ‘ä»¬æ’æŸ¥æ–¹å‘åˆ†ä¸º2éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯çœ‹å‘ç‰ˆè®°å½•ï¼Œæœ€è¿‘æœ‰å“ªäº›æ”¹åŠ¨ï¼Œå“ªäº›åœ°æ–¹å¯èƒ½ä¼šé¢‘ç¹åˆ›å»ºç±»ï¼ŒäºŒæ˜¯ä»jvmå±‚é¢æ’æŸ¥ã€‚æˆ‘ä»¬é‡ç‚¹è¯´ä¸€ä¸‹jvmå±‚é¢çš„æ’æŸ¥æ–¹å‘ã€‚\næ³¨æ„äº‹é¡¹: å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œé—®é¢˜å·²ç»è§£å†³ï¼Œæ‰€ä»¥éƒ¨åˆ†æ•°æ®ä¸æ˜¯å‡ºé—®é¢˜æ—¶é‡‡é›†çš„æ•°æ®ï¼Œæ˜¯ä¸ºäº†å†™æ–‡ç« ä½¿ç”¨å¯¹åº”çš„æ’æŸ¥å·¥å…·ç”Ÿæˆçš„æ•°æ®ï¼Œå…·ä½“ä½ç½®å¤„ä¼šæ ‡æ˜æ•°æ®æ¥æºå’Œæ—¶æœº\nJVMæ’æŸ¥ jdkè‡ªå¸¦çš„æ’æŸ¥å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨çš„æœ‰jps,jstat,jmapç­‰\nå…¶ä¸­jmapçœ‹çš„æ˜¯å †çš„å†…å­˜å¤§å°å’Œåˆ†é…\njstatå¯ä»¥çœ‹gcç›¸å…³ä¿¡æ¯.\ngc.logé‡Œçš„gcæ—¥å¿—ä¹Ÿå¯ä»¥è¾…åŠ©æˆ‘ä»¬æ’æŸ¥\njmap jmap -heap pidçš„ä¿¡æ¯å¦‚ä¸‹ï¼Œè¿™ä¸ªå¯ä»¥è¾…åŠ©æˆ‘ä»¬çœ‹ä¸‹å †å†…åˆ†ä»£çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œå½“ç„¶è¿™ä¸ªå¯¹æˆ‘ä»¬çš„æ’æŸ¥å¸®åŠ©ä¸å¤§ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹å‘½ä»¤æ•ˆæœ\nAttaching to process ID 5311, please wait... Debugger attached successfully. Server compiler detected. JVM version is 25.73-b02 using parallel threads in the new generation. using thread-local object allocation. Concurrent Mark-Sweep GC Heap Configuration: MinHeapFreeRatio = 40 MaxHeapFreeRatio = 70 MaxHeapSize = 4294967296 (4096.0MB) NewSize = 2147483648 (2048.0MB) MaxNewSize = 2147483648 (2048.0MB) OldSize = 2147483648 (2048.0MB) NewRatio = 2 SurvivorRatio = 8 MetaspaceSize = 536870912 (512.0MB) CompressedClassSpaceSize = 1073741824 (1024.0MB) MaxMetaspaceSize = 536870912 (512.0MB) G1HeapRegionSize = 0 (0.0MB) Heap Usage: New Generation (Eden + 1 Survivor Space): capacity = 1932787712 (1843.25MB) used = 735313536 (701.2496337890625MB) free = 1197474176 (1142.0003662109375MB) 38.04419551276617% used Eden Space: capacity = 1718091776 (1638.5MB) used = 733845856 (699.8499450683594MB) free = 984245920 (938.6500549316406MB) 42.71284376370823% used From Space: capacity = 214695936 (204.75MB) used = 1467680 (1.399688720703125MB) free = 213228256 (203.35031127929688MB) 0.683608654800061% used To Space: capacity = 214695936 (204.75MB) used = 0 (0.0MB) free = 214695936 (204.75MB) 0.0% used concurrent mark-sweep generation: capacity = 2147483648 (2048.0MB) used = 613751744 (585.3192749023438MB) free = 1533731904 (1462.6807250976562MB) 28.580042719841003% used 66527 interned Strings occupying 7048176 bytes. è¿˜æœ‰ä¸€ä¸ªå‘½ä»¤æ˜¯jmap -histo pidï¼Œè¿™ä¸ªå¯ä»¥çœ‹å †å†…å­˜æ´»çš„å¯¹è±¡ç±»å‹å’Œå®ä¾‹æ•°é‡\nnum #instances #bytes class name ---------------------------------------------- 1: 5478775 506824136 [C 2: 1421313 315369496 [B 3: 3791992 91007808 java.lang.String 4: 2593077 82978464 java.util.HashMap$Node 5: 730043 78351624 [I 6: 1393624 67623928 [Ljava.lang.Object; 7: 712992 62743296 java.lang.reflect.Method 8: 317758 48979560 [Ljava.util.HashMap$Node; 9: 178237 32795608 com.fasterxml.jackson.core.json.UTF8StreamJsonParser 10: 513502 20540080 java.util.LinkedHashMap$Entry 11: 639968 20478976 com.mysql.cj.conf.BooleanProperty 12: 941240 18059848 [Ljava.lang.Class; 13: 353510 16968480 java.util.HashMap 14: 241178 13505968 sun.nio.cs.UTF_8$Encoder 15: 539462 12947088 java.lang.StringBuilder 16: 178448 12848256 com.fasterxml.jackson.databind.deser.DefaultDeserializationContext$Impl 17: 218814 12253584 com.fasterxml.jackson.core.io.IOContext jstat ä½¿ç”¨jstatè§‚å¯Ÿgcå’Œmetaspaceçš„ä½¿ç”¨æƒ…å†µï¼Œjstatä¸»è¦è¾“å‡ºå„ä¸ªåŒºåŸŸçš„ä½¿ç”¨é‡æ¯”ä¾‹(å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™é—®é¢˜å·²ä¿®å¤ï¼Œæ‰€ä»¥metaspaceä½¿ç”¨å æ¯”æ¯”è¾ƒå¹³ç¨³)\njstat -gcutil 5311 è¿™ä¸ªå‘½ä»¤ä»¥1000msä¸ºé—´éš”ï¼Œè¾“å‡ºpid 5311çš„è¿›ç¨‹çš„gcæƒ…å†µï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡ºmetaspaceçš„ä½¿ç”¨æ¯”ä¾‹çš„å˜åŒ–\næ¯”å¦‚s0æ˜¯survivo 0å½“å‰ç©ºé—´çš„å·²ä½¿ç”¨æ¯”ä¾‹ï¼Œs1çš„survivo 1å½“å‰ç©ºé—´çš„å·²ä½¿ç”¨æ¯”ä¾‹ï¼ŒEæ˜¯edenåŒºçš„å·²ä½¿ç”¨æ¯”ä¾‹ï¼ŒOæ˜¯old gençš„å·²ä½¿ç”¨æ¯”ä¾‹\nS0 S1 E O M CCS YGC YGCT FGC FGCT GCT 0.00 1.04 57.32 27.40 92.59 86.14 125511 1969.952 28 5.062 1975.014 0.00 1.04 78.69 27.40 92.59 86.14 125511 1969.952 28 5.062 1975.014 0.00 1.04 97.81 27.40 92.59 86.14 125511 1969.952 28 5.062 1975.014 0.98 0.00 32.47 27.40 92.59 86.14 125512 1969.968 28 5.062 1975.031 0.98 0.00 66.19 27.40 92.59 86.14 125512 1969.968 28 5.062 1975.031 0.98 0.00 91.34 27.40 92.59 86.14 125512 1969.968 28 5.062 1975.031 0.00 0.81 17.07 27.41 92.59 86.14 125513 1969.980 28 5.062 1975.042 0.00 0.81 39.36 27.41 92.59 86.14 125513 1969.980 28 5.062 1975.042 0.00 0.81 60.87 27.41 92.59 86.14 125513 1969.980 28 5.062 1975.042 0.00 0.81 89.84 27.41 92.59 86.14 125513 1969.980 28 5.062 1975.042 0.89 0.00 9.76 27.42 92.59 86.14 125514 1969.995 28 5.062 1975.058 0.89 0.00 25.07 27.42 92.59 86.14 125514 1969.995 28 5.062 1975.058 0.89 0.00 44.26 27.42 92.59 86.14 125514 1969.995 28 5.062 1975.058 gc.log å¦ä¸€ä¸ªå°±æ˜¯ä»gc.logé‡ŒæŸ¥çœ‹metaspaceçš„æ—¥å¿—,ä¸‹é¢ä¸€æ®µæ—¥å¿—æ˜¯gcå‰å’Œgcåå„ä¸ªåŒºåŸŸçš„å†…å­˜å˜åŒ–\nå¯ä»¥è§‚å¯Ÿä¸‹heap before gcå’Œheap after gc2å¤„çš„metaspaceç©ºé—´ä½¿ç”¨å˜åŒ–(æ­¤å¤„æ˜¯é—®é¢˜è§£å†³åçš„gc.log,ä»…ä¾›å‚è€ƒ)\nmetaspaceæ•°æ®å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è·ç¦»512mè¿˜æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œæ³¨æ„æ­¤å¤„æ˜¯é—®é¢˜è§£å†³åçš„æ•°æ®ï¼Œä»…ä¾›æ’æŸ¥å‚è€ƒ\nused 176869Kï¼Œ å·²ä½¿ç”¨å¤§æ¦‚æ˜¯172m capacity 189800Kï¼Œ å®¹é‡å¤§æ¦‚æ˜¯185m committed 190848Kï¼Œå·²æäº¤å¤§æ¦‚æ˜¯186m reserved 1216512Kï¼Œä¿ç•™å¤§æ¦‚æ˜¯1188m 2023-09-12T09:03:08.449+0800: 1249459.698: Total time for which application threads were stopped: 0.0195137 seconds, Stopping threads took: 0.0001738 seconds 2023-09-12T09:03:11.392+0800: 1249462.641: Application time: 2.9429699 seconds 2023-09-12T09:03:11.396+0800: 1249462.646: Total time for which application threads were stopped: 0.0046629 seconds, Stopping threads took: 0.0002150 seconds 2023-09-12T09:03:11.397+0800: 1249462.646: Application time: 0.0000922 seconds 2023-09-12T09:03:11.400+0800: 1249462.649: Total time for which application threads were stopped: 0.0034414 seconds, Stopping threads took: 0.0001087 seconds 2023-09-12T09:03:14.304+0800: 1249465.553: Application time: 2.9035482 seconds {Heap before GC invocations=130961 (full 14): par new generation total 1887488K, used 1679309K [0x00000006c0000000, 0x0000000740000000, 0x0000000740000000) eden space 1677824K, 100% used [0x00000006c0000000, 0x0000000726680000, 0x0000000726680000) from space 209664K, 0% used [0x0000000733340000, 0x00000007334b34a0, 0x0000000740000000) to space 209664K, 0% used [0x0000000726680000, 0x0000000726680000, 0x0000000733340000) concurrent mark-sweep generation total 2097152K, used 1209833K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000) Metaspace used 176869K, capacity 189800K, committed 190848K, reserved 1216512K class space used 19973K, capacity 22145K, committed 23168K, reserved 1048576K 2023-09-12T09:03:14.307+0800: 1249465.557: [GC (Allocation Failure) 2023-09-12T09:03:14.307+0800: 1249465.557: [ParNew Desired survivor size 107347968 bytes, new threshold 6 (max 6) - age 1: 674280 bytes, 674280 total - age 2: 177208 bytes, 851488 total - age 3: 238904 bytes, 1090392 total - age 4: 191384 bytes, 1281776 total - age 5: 38080 bytes, 1319856 total - age 6: 40232 bytes, 1360088 total : 1679309K-\u003e1868K(1887488K), 0.0143320 secs] 2889142K-\u003e1211742K(3984640K), 0.0146560 secs] [Times: user=0.03 sys=0.01, real=0.01 secs] Heap after GC invocations=130962 (full 14): par new generation total 1887488K, used 1868K [0x00000006c0000000, 0x0000000740000000, 0x0000000740000000) eden space 1677824K, 0% used [0x00000006c0000000, 0x00000006c0000000, 0x0000000726680000) from space 209664K, 0% used [0x0000000726680000, 0x0000000726853010, 0x0000000733340000) to space 209664K, 0% used [0x0000000733340000, 0x0000000733340000, 0x0000000740000000) concurrent mark-sweep generation total 2097152K, used 1209874K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000) Metaspace used 176869K, capacity 189800K, committed 190848K, reserved 1216512K class space used 19973K, capacity 22145K, committed 23168K, reserved 1048576K } jcmd æœ€åä¸€ä¸ªå¯ç”¨çš„jvmå·¥å…·å°±æ˜¯cmdï¼Œä½¿ç”¨jcmdæ‰“å°ä¸‹classæ•°é‡ï¼Œçœ‹ä¸‹å“ªäº›åŒ…ä¸‹çš„ç±»å¢é•¿æ¯”è¾ƒå¿«\nä½¿ç”¨å‘½ä»¤å¦‚ä¸‹\njcmd GC.class_stats|awk '{print$13}'|sed 's/\\(.*\\)\\.\\(.*\\)/\\1/g'|sort |uniq -c|sort -nrk1 å®é™…è¿›ç¨‹æ‰“å°å¦‚ä¸‹,å¯ä»¥çœ‹åˆ°æœ€å¤šçš„æ˜¯sun.reflectåŒ…ä¸‹çš„classæœ€å¤š\n2283 sun.reflect 416 com.xx.xx.xx.xx.impl 316 java.lang.invoke 306 com.sun.proxy 275 reactor.core.publisher 268 java.util 198 com.google.common.collect 189 com.google.protobuf 181 io.netty.channel 174 java.lang dumpåˆ†æ dump å¿«ç…§ä¹‹åé€šè¿‡ JProfiler æˆ– MAT è§‚å¯Ÿ Classes çš„ Histogram (ç›´æ–¹å›¾) ï¼Œè¿™ä¸ªä¼°è®¡å¾—æ·±åšçš„åŠŸåŠ›æ‰èƒ½çœ‹å‡ºæ¥\narthas arthasä¹Ÿæœ‰å¾ˆå¤šçš„å‘½ä»¤å¯ä»¥å¸®åŠ©æ’æŸ¥ï¼Œæ¯”å¦‚dashboardï¼Œå¯ä»¥çœ‹metaspaceåŒºçš„å†…å­˜å ç”¨ï¼Œvmtoolå¯ä»¥æŸ¥çœ‹å…·ä½“çš„class\nå¦‚ä¸‹æ˜¯dashboradå‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°metaspaceçš„ä½¿ç”¨é‡\nå¯ä»¥ä½¿ç”¨vmtoolï¼ŒåŒ¹é…æŒ‡å®šåŒ…åçš„class\nvmtool --action getInstances --className sun.reflect.* --limit 100 å¯ä»¥ä½¿ç”¨transformï¼Œæœ‰ç±»åŠ è½½çš„æ—¶å€™å°±ä¼šè§¦å‘\nwatch java.lang.instrument.ClassFileTransformer transform '{params,returnObj,throwExp}' -n 5 -x 3 ä¹Ÿå¯ä»¥è·Ÿè¸ªä¸‹class init\nstack sun.reflect.DelegatingClassLoader -n 5 å®é™…æ’æŸ¥è¿‡ç¨‹ å‰é¢ä»‹ç»äº†ä¸€äº›å…³äºmetaspaceçš„çŸ¥è¯†ï¼Œä¹Ÿä»‹ç»äº†ä¸€äº›æ’æŸ¥æ–¹å‘ï¼Œæ¥ä¸‹æ¥ä»‹ç»ä¸‹å®é™…æ’æŸ¥è¿‡ç¨‹\næ¥åˆ°å‘Šè­¦ä¹‹åï¼ŒæŸ¥çœ‹è¿›ç¨‹ï¼Œå‘ç°äº†metaspace oomçš„é”™è¯¯ï¼Œäºæ˜¯å¼€å§‹å¾€metaspace oomçš„æ–¹å‘å¼€å§‹æ’æŸ¥\nç»è¿‡ä¸€é€šgoogle/baiduä¹‹åï¼Œå‘ç°äº†å¦‚ä¸Šä»‹ç»çš„ä¸€äº›æ–¹å‘å’Œæ‰‹æ®µ\né¦–å…ˆæ˜¯çœ‹äº†ç¾å›¢çš„æ–‡ç« åœºæ™¯ä¸‰ï¼šMetaSpace åŒº OOM\nå‘ç°å¯ä»¥ä½¿ç”¨jcmdå‘½ä»¤è¿›è¡Œæ’æŸ¥ï¼Œçœ‹ä¸‹å“ªä¸ªåŒ…çš„classæ¯”è¾ƒå¤šï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¾—åˆ°å¦‚ä¸‹çš„ç»“æœ\njcmd 5311 GC.class_stats|awk '{print$13}'|sed 's/\\(.*\\)\\.\\(.*\\)/\\1/g'|sort |uniq -c|sort -nrk1|head -n 10 2294 sun.reflect 416 com.xx.impl 316 java.lang.invoke 316 com.sun.proxy 275 reactor.core.publisher 268 java.util 198 com.google.common.collect 189 com.google.protobuf 181 io.netty.channel 174 java.lang å¤šæ¬¡æ‰§è¡Œjcmdä¹‹åï¼Œå‘ç°sun.reflectåŒ…ä¸‹çš„classæ¯”è¾ƒå¤šï¼Œä¸”æœ‰å¢é•¿ï¼Œäºæ˜¯æŠŠç›®å…‰æ”¾åœ¨äº†sun.reflectä¸Šã€‚\nä»¥ä¸ºæ˜¯åå°„ç”¨çš„ä¸å½“å¯¼è‡´çš„ï¼Œç„¶åä½¿ç”¨arthasï¼Œåˆ†æäº†dashboardä»¥åŠä½¿ç”¨äº†vmtoolæŸ¥çœ‹sun.reflectåŒ…çš„instanceã€‚\nå½“æ—¶ä½¿ç”¨dashboardåˆ†æï¼Œmetaspaceä¸Šæ¶¨çš„éå¸¸çš„å¿«ï¼Œç„¶åä½¿ç”¨vmtoolå‘½ä»¤æŸ¥çœ‹sun.reflect\nvmtool --action getInstances --className sun.reflect.* --limit 100 æ‰§è¡Œç»“æœç±»ä¼¼ä¸‹å›¾\nåˆ†æå‘ç°é‡Œé¢æœ‰mytabisï¼Œä¹Ÿæœ‰è‡ªå·±è°ƒç”¨äº§ç”Ÿçš„åå°„ï¼Œä½†æ˜¯ä¸è¶³ä»¥å¯¼è‡´metaspace oom\nåæ¥æƒ³åˆ°äº†åŠ ä¸Šå¦‚ä¸‹2ä¸ªå‚æ•°,ç”¨äºæ‰“å°ç±»åŠ è½½ã€å¸è½½æ—¥å¿—\n-XX:+TraceClassLoading -XX:+TraceClassUnloading ç”±äºå‘å¸ƒç³»ç»Ÿé»˜è®¤æ²¡æ‰“nohupæ—¥å¿—ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œèµ°äº†ç‚¹å¼¯è·¯ï¼Œç±»åŠ è½½ã€å¸è½½ä¿¡æ¯æ²¡æ‰“åˆ°æ—¥å¿—é‡Œï¼Œåæ¥ä¸Šæœºå™¨æ‰‹åŠ¨ç”¨nohup java -jar xx.jar \u0026ä¹‹åï¼Œå‘ç°äº†ç«¯å€ª\nå¯ä»¥çœ‹åˆ°å¯åŠ¨ä¹‹åï¼Œæ‰“äº†æ¯”è¾ƒå¤šçš„ç±»ä¼¼ä¸‹é¢çš„è¿™äº›æ—¥å¿—ï¼Œå¯ä»¥åˆæ­¥åˆ¤æ–­æ˜¯com.googlecode.aviator.Expressionä½¿ç”¨ä¸å½“é€ æˆçš„\n[Loaded Script_1691559755244_2757/2021240514 from com.googlecode.aviator.Expression] [Loaded Script_1691559755339_2758/6228193 from com.googlecode.aviator.Expression] [Loaded Script_1691559755492_2759/419920034 from com.googlecode.aviator.Expression] [Loaded Script_1691559756493_2760/1460748148 from com.googlecode.aviator.Expression] [Loaded Script_1691559756500_2761/520805009 from com.googlecode.aviator.Expression] [Loaded Script_1691559756506_2762/398664510 from com.googlecode.aviator.Expression] [Loaded Script_1691559756573_2763/306461935 from com.googlecode.aviator.Expression] [Loaded Script_1691559756577_2764/1116508142 from com.googlecode.aviator.Expression] [Loaded Script_1691559756791_2765/870354750 from com.googlecode.aviator.Expression] [Loaded Script_1691559756799_2766/1661127610 from com.googlecode.aviator.Expression] [Loaded Script_1691559756812_2767/1883979577 from com.googlecode.aviator.Expression] [Loaded Script_1691559757019_2768/1281538781 from com.googlecode.aviator.Expression] [Loaded Script_1691559757332_2769/589742334 from com.googlecode.aviator.Expression] [Loaded Script_1691559757338_2770/1560860126 from com.googlecode.aviator.Expression] [Loaded Script_1691559757977_2771/213218340 from com.googlecode.aviator.Expression] [Loaded Script_1691559758313_2772/505164301 from com.googlecode.aviator.Expression] [Loaded Script_1691559758318_2773/601453331 from com.googlecode.aviator.Expression] [Loaded Script_1691559759007_2774/1011764766 from com.googlecode.aviator.Expression] [Loaded Script_1691559759014_2775/338373159 from com.googlecode.aviator.Expression] [Loaded Script_1691559759146_2776/1714310047 from com.googlecode.aviator.Expression] [Loaded Script_1691559759154_2777/1663245165 from com.googlecode.aviator.Expression] [Loaded Script_1691559759227_2778/797537408 from com.googlecode.aviator.Expression] [Loaded Script_1691559759234_2779/551097430 from com.googlecode.aviator.Expression] [Loaded Script_1691559759553_2780/594411270 from com.googlecode.aviator.Expression] [Loaded Script_1691559759559_2781/1720465741 from com.googlecode.aviator.Expression] [Loaded Script_1691559759586_2782/215181464 from com.googlecode.aviator.Expression] [Loaded Script_1691559759601_2783/2036721542 from com.googlecode.aviator.Expression] [Loaded Script_1691559759797_2784/1723282218 from com.googlecode.aviator.Expression] [Loaded Script_1691559759802_2785/953430028 from com.googlecode.aviator.Expression] [Loaded Script_1691559759942_2786/847216521 from com.googlecode.aviator.Expression] [Loaded Script_1691559759949_2787/1763495463 from com.googlecode.aviator.Expression] [Loaded Script_1691559760350_2788/47562916 from com.googlecode.aviator.Expression] è·Ÿç€com.googlecode.aviator.Expressionè¿™ä¸ªç±»ï¼Œå‘ç°å¯èƒ½é€ æˆå¼‚å¸¸çš„ä»£ç å¦‚ä¸‹\nExpression expression = AviatorEvaluator.compile(ruleExpressProcessed); è¿™ä¸ªè¿˜æœ‰ä¸€ä¸ªé‡è½½æ–¹æ³•,æ˜¯å¦ç¼“å­˜\npublic static Expression compile(String expression, boolean cached) { return getInstance().compile(expression, cached); } è·Ÿè¸ªä»£ç ï¼Œæœ€åä¼šå‘ç°cachedå­—æ®µä¼šå½±å“classloaderçš„è·å–ï¼Œå¦‚æœcached=true,åˆ™ä¼šä½¿ç”¨å·²ç¼“å­˜çš„classloaderï¼Œå¦‚æœfalseæ¯æ¬¡éƒ½ä¼šnew ä¸€ä¸ªæ–°çš„classloader\ncom.googlecode.aviator.AviatorEvaluatorInstance#newCodeGenerator(java.lang.String, boolean) é—®é¢˜ä¿®å¤ å°†cachedè®¾ç½®ä¸ºtrue,metaspaceä½¿ç”¨ç‡å°±å¾ˆå¹³ç¨³äº†ï¼Œä¸ä¼šå‡ºç°é«˜é¢‘çš„ç±»åŠ è½½å’Œå¸è½½æƒ…å†µã€‚\né—®é¢˜å¤ç° æœ¬æ‰“ç®—åœ¨æœ¬åœ°å¤ç°ä¸‹è¿™ä¸ªé—®é¢˜çš„ï¼Œä½†æ˜¯æœ¬åœ°èƒ½gcæ‰ï¼Œç”Ÿäº§ç¯å¢ƒç”±äºæ¯æ¬¡2-3å¤©æ‰ä¼šå‘ç”Ÿoomï¼Œæ‰€ä»¥æ²¡æœ‰å‘ç°oomçš„æ—¶å€™ï¼Œmetaspaceé‡Œæœ‰å“ªäº›å…ƒç´ ï¼Œå¯ä»¥çœ‹ä¸‹æœ¬åœ°éªŒè¯è¿‡ç¨‹å’Œç°è±¡ï¼Œå¸®åŠ©ç†è§£\næµ‹è¯•ä»£ç  mavenä¾èµ–\ncom.googlecode.aviator aviator 5.2.5 jvmå‚æ•°\nå †è®¾ç½®çš„æ¯”è¾ƒå¤§,metaspaceåªè®¾ç½®äº†128m\n-Xmx4096M -Xms4096M -Xmn2048M -XX:MaxMetaspaceSize=128M -XX:MetaspaceSize=128M -XX:+UseConcMarkSweepGC -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses -XX:+CMSClassUnloadingEnabled -XX:+ParallelRefProcEnabled -XX:+CMSScavengeBeforeRemark -XX:+HeapDumpOnOutOfMemoryError -XX:ErrorFile=/data/logs/hs_err_pid%p.log -Xloggc:/dev/shm/gc.log -XX:HeapDumpPath=/data/logs/ -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintClassHistogramBeforeFullGC -XX:+PrintClassHistogramAfterFullGC -XX:+PrintCommandLineFlags -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGCApplicationStoppedTime -XX:+PrintTenuringDistribution -XX:+PrintHeapAtGC -Ddubbo.reference.check=false -XX:+UnlockDiagnosticVMOptions -XX:NativeMemoryTracking=detail //class loading unloading -XX:+TraceClassLoading -XX:+TraceClassUnloading ä½¿ç”¨å¤šçº¿ç¨‹å»å¹¶å‘è®¿é—®\npublic static void main(String[] args) { ThreadFactory threadFactory = new ThreadFactoryBuilder().setNameFormat(\"test-pool-%d\").build(); ThreadPoolExecutor executor = new ThreadPoolExecutor(50, 50, 1, TimeUnit.SECONDS, new LinkedBlockingQueue\u003c\u003e(50), threadFactory); for (int i = 0; i \u003c 32; i++) { executor.execute(() -\u003e { while (true) { try { String rule = \"field01+ field02\"; Map map = new HashMap\u003c\u003e(); int random1 = new Random().nextInt(); int random2 = new Random().nextInt(); map.put(\"field01\", random1); map.put(\"field02\", random2); Expression compiledExp = AviatorEvaluator.compile(rule); Object obj = compiledExp.execute(map); System.out.println(obj); } catch (Exception e) { e.printStackTrace(); } } }); } } æ§åˆ¶å°ä¹Ÿè¾“å‡ºäº†åŒæ ·çš„æ—¥å¿—\nç„¶åä½¿ç”¨jconsoleè¿åˆ°jvmä¸Šè§‚å¯Ÿå†…å­˜ä½¿ç”¨æƒ…å†µ\né¦–å…ˆæ˜¯metaspaceçš„ä½¿ç”¨æƒ…å†µï¼Œæœ€é«˜æ˜¯åˆ°50mï¼Œç„¶ågcæ‰ï¼ŒæŒç»­è¿™ä¸€è¿‡ç¨‹ï¼Œè¯´æ˜metaspaceä½¿ç”¨é‡åœ¨ä¸Šå‡ï¼Œä½†æ˜¯èƒ½gcçš„æ‰ï¼Œè€Œä¸”ä¸ä¼šè§¦å‘é˜ˆå€¼ã€‚\nç”Ÿäº§ä¸Šå‘ç”Ÿoomï¼Œå¯èƒ½æœ‰æµé‡å› ç´ ï¼Œè®¿é—®é‡æ¯”æœ¬åœ°æ¨¡æ‹Ÿçš„å¤§ã€‚\nåœ¨çœ‹ä¸‹ç±»çš„åŠ è½½å¸è½½æƒ…å†µï¼Œç¨‹åºè¿è¡Œäº†1ä¸ªåŠå°æ—¶ï¼ŒåŠ è½½å’Œå¸è½½æ•°é‡å·®ä¸å¤šæŒå¹³ï¼Œå¤§æ¦‚6529ä¸‡æ¬¡ï¼Œå¯ä»¥å‘ç°ç±»æ˜¯ä¸€ç›´åœ¨åŠ è½½ï¼Œä½†æ˜¯æœ¬åœ°æ¨¡æ‹Ÿçš„æƒ…å†µä¸‹ï¼Œå¸è½½çš„ä¹Ÿå¿«ï¼Œç”Ÿäº§ä¸Šçš„å…·ä½“ç»†èŠ‚ç”±äºç½‘ç»œéš”ç¦»é—®é¢˜ï¼Œæ— æ³•æ¨¡æ‹Ÿå‡ºï¼Œä»…èƒ½æ ¹æ®åŠ è½½æ•°é‡çœ‹å‡ºç±»åŠ è½½æ•°é‡å¼‚å¸¸äº†ï¼Œè¿™å—ä»£ç æ˜¯æœ‰é—®é¢˜çš„\næ¦‚è§ˆé‡Œå¯ä»¥çœ‹åˆ°å·²åŠ è½½çš„ç±»çš„æ•°é‡ï¼Œåœ¨ä¸€ä¸ªåŒºé—´èŒƒå›´å†…æ³¢åŠ¨ï¼Œä¸€è¾¹åŠ è½½ä¸€è¾¹å¸è½½\nä¿®å¤éªŒè¯ ä»£ç ä¿®æ”¹å¦‚ä¸‹ï¼Œå°†cachedè®¾ç½®ä¸ºtrue\nExpression compiledExp = AviatorEvaluator.compile(rule,true); æ¦‚è§ˆæ•°æ®å¦‚ä¸‹ï¼Œå¯ä»¥å‘ç°ç±»åªåŠ è½½äº†2000å¤šä¸ªå°±å¹³ç¨³äº†ï¼Œä¸ä¼šåŠ è½½æ–°çš„class\nmetaspaceä½¿ç”¨é‡ç¨³å®šåœ¨13m,ä¸ä¼šæ³¢åŠ¨\nç±»åœ¨åŠ è½½äº†2274ä¸ªä¹‹åä¿æŒç¨³å®šï¼Œæ²¡æœ‰æ–°å¢\næ ¹æ®ä¿®æ”¹ä¹‹åçš„ç°è±¡åˆ¤æ–­ï¼Œé€ æˆé—®é¢˜çš„åŸå› å°±æ˜¯æ¯æ¬¡éƒ½ä¼šnew classloaderï¼Œå¯¼è‡´ç±»é¢‘ç¹åŠ è½½å¸è½½ï¼Œå åŠ ç”Ÿäº§æµé‡ä¸å¯æ§ï¼Œæç«¯æƒ…å†µå¯èƒ½å°±ä¼šå¯¼è‡´oom\næ€»ç»“ ç”±äºæœªè®¾ç½®metaspaceåŒºç›‘æ§ï¼Œå…·ä½“çš„åŸå› æš‚æœªå‘ç°ï¼Œæ¯”å¦‚Metaspaceé‡Œçš„classæ•°é‡å æ¯”ï¼Œåˆ†ç±»ç­‰ã€‚\nä¿®å¤ä¹‹åå†ä¸Šçº¿ï¼Œä½¿ç”¨arthasè§‚å¯Ÿmetaspaceä½¿ç”¨é‡ï¼Œå‘ç°metaspaceåŒºåŸŸå†…å­˜ä½¿ç”¨é‡ã€‚\nå…³äºmetaspaceçš„å¯ç”¨èµ„æ–™ï¼Œç›¸æ¯”äºå †å†…å­˜çš„oomæ¥è¯´ï¼Œæ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥æ’æŸ¥ä¸‹æ¥ä¹Ÿæ²¡æœ‰é‚£ä¹ˆé¡ºåˆ©ï¼Œä¸è¿‡ç»è¿‡è¿™æ¬¡é—®é¢˜æ’æŸ¥ï¼Œå¯¹metaspaceæœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œä¸‹æ¬¡å†æ’æŸ¥é—®é¢˜æ—¶ï¼Œå¯ä»¥æœ‰æ›´å¥½çš„åˆ‡å…¥æ–¹å‘äº†\nå‚è€ƒèµ„æ–™ åœºæ™¯ä¸‰ï¼šMetaSpace åŒº OOM æ·±å…¥ç†è§£å †å¤–å†…å­˜metaspace ","wordCount":"5147","inLanguage":"zh","datePublished":"2023-09-07T09:47:33+08:00","dateModified":"2023-09-07T09:47:33+08:00","author":{"@type":"Person","name":"since"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.thend03.com/posts/metaspace-oom/"},"publisher":{"@type":"Organization","name":"Fayy\u0026Fc's Blog","logo":{"@type":"ImageObject","url":"https://blog.thend03.com/img/logo.jpg"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.thend03.com/ accesskey=h title="fayy&amp;fc (Alt + H)"><img src=https://blog.thend03.com/img/logo.jpg alt=logo aria-label=logo height=35>fayy&amp;fc</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://blog.thend03.com/search title="ğŸ” æœç´¢ (Alt + /)" accesskey=/><span>ğŸ” æœç´¢</span></a></li><li><a href=https://blog.thend03.com/ title="ğŸ  ä¸»é¡µ"><span>ğŸ  ä¸»é¡µ</span></a></li><li><a href=https://blog.thend03.com/archives/ title="â±ï¸ å½’æ¡£"><span>â±ï¸ å½’æ¡£</span></a></li><li><a href=https://blog.thend03.com/tags title="ğŸ§© æ ‡ç­¾"><span>ğŸ§© æ ‡ç­¾</span></a></li><li><a href=https://blog.thend03.com/about title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº"><span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span></a></li><li><a href=https://blog.thend03.com/links title="ğŸ¤ å‹é“¾"><span>ğŸ¤ å‹é“¾</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://blog.thend03.com/>ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://blog.thend03.com/posts/>ğŸ“šæ–‡ç« </a></div><h1 class=post-title>metaspace-oom</h1><div class=post-description>metaspace oom</div><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2023-09-07
&nbsp;&nbsp;
</span></span><span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>5147å­—
&nbsp;&nbsp;
</span></span><span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>11åˆ†é’Ÿ
&nbsp;&nbsp;
</span></span><span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>since
&nbsp;&nbsp;
</span></span><span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta><a href=https://blog.thend03.com/tags/jvm/ style=color:var(--secondary)!important>Jvm</a>
&nbsp;<a href=https://blog.thend03.com/tags/oom/ style=color:var(--secondary)!important>Oom</a>
</span></span></span></span><span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;
</span></span><span id=post_meta_style_8><span class="fa fa-commenting-o"></span>
<span><script src=https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js></script><script>let url=document.documentURI,dnsUrl="https://blog.thend03.com/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=="/"&&(finalUrl="/"+finalUrl),twikoo.getCommentsCount({envId:"https://twikoo-e1f2-2yfafx14j-thend03s-projects.vercel.app/",region:null,urls:[finalUrl],includeReply:!1}).then(function(e){let t=e[0].count;const n=document.getElementById("comment_count");n.innerText=t}).catch(function(e){console.error(e)})</script><span id=comment_count></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e9%97%ae%e9%a2%98%e8%83%8c%e6%99%af aria-label=é—®é¢˜èƒŒæ™¯>é—®é¢˜èƒŒæ™¯</a></li><li><a href=#%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86 aria-label=å‰ç½®çŸ¥è¯†>å‰ç½®çŸ¥è¯†</a><ul><li><a href=#%e5%90%af%e5%8a%a8%e5%8f%82%e6%95%b0 aria-label=å¯åŠ¨å‚æ•°>å¯åŠ¨å‚æ•°</a></li><li><a href=#metaspace%e9%87%8c%e6%9c%89%e4%bb%80%e4%b9%88 aria-label=Metaspaceé‡Œæœ‰ä»€ä¹ˆ>Metaspaceé‡Œæœ‰ä»€ä¹ˆ</a></li><li><a href=#%e6%8e%92%e6%9f%a5%e6%89%8b%e6%ae%b5 aria-label=æ’æŸ¥æ‰‹æ®µ>æ’æŸ¥æ‰‹æ®µ</a></li><li><a href=#jvm%e6%8e%92%e6%9f%a5 aria-label=JVMæ’æŸ¥>JVMæ’æŸ¥</a><ul><li><a href=#jmap aria-label=jmap>jmap</a></li><li><a href=#jstat aria-label=jstat>jstat</a></li><li><a href=#gclog aria-label=gc.log>gc.log</a></li><li><a href=#jcmd aria-label=jcmd>jcmd</a></li></ul></li><li><a href=#dump%e5%88%86%e6%9e%90 aria-label=dumpåˆ†æ>dumpåˆ†æ</a></li><li><a href=#arthas aria-label=arthas>arthas</a></li></ul></li><li><a href=#%e5%ae%9e%e9%99%85%e6%8e%92%e6%9f%a5%e8%bf%87%e7%a8%8b aria-label=å®é™…æ’æŸ¥è¿‡ç¨‹>å®é™…æ’æŸ¥è¿‡ç¨‹</a><ul><li><a href=#%e9%97%ae%e9%a2%98%e4%bf%ae%e5%a4%8d aria-label=é—®é¢˜ä¿®å¤>é—®é¢˜ä¿®å¤</a></li></ul></li><li><a href=#%e9%97%ae%e9%a2%98%e5%a4%8d%e7%8e%b0 aria-label=é—®é¢˜å¤ç°>é—®é¢˜å¤ç°</a><ul><li><a href=#%e6%b5%8b%e8%af%95%e4%bb%a3%e7%a0%81 aria-label=æµ‹è¯•ä»£ç >æµ‹è¯•ä»£ç </a></li><li><a href=#%e4%bf%ae%e5%a4%8d%e9%aa%8c%e8%af%81 aria-label=ä¿®å¤éªŒè¯>ä¿®å¤éªŒè¯</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=æ€»ç»“>æ€»ç»“</a></li><li><a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=å‚è€ƒèµ„æ–™>å‚è€ƒèµ„æ–™</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{elements&&(activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=é—®é¢˜èƒŒæ™¯>é—®é¢˜èƒŒæ™¯<a hidden class=anchor aria-hidden=true href=#é—®é¢˜èƒŒæ™¯>#</a></h2><p>ç”Ÿäº§ç¯å¢ƒæœ‰æœºå™¨äº§ç”Ÿäº†oomï¼Œä¸€å¼€å§‹æ€€ç–‘æ˜¯heap oomï¼Œå› ä¸ºä¹‹å‰é…ç½®äº†å‘ç”Ÿoomï¼Œè‡ªåŠ¨è¿›è¡Œdumpï¼Œæ‰€ä»¥åˆ†æäº†dumpæ–‡ä»¶ä¹‹åï¼Œå‘ç°4gçš„heapï¼Œæœ€ç»ˆdumpåªæœ‰300å¤šmï¼Œæ²¡æœ‰åˆ†æå‡ºæœ‰ç”¨çš„å†…å®¹ã€‚</p><p>åæ¥åˆä¸€æ¬¡oomä¹‹åï¼Œç»ˆäºåœ¨å®¹å™¨æ§åˆ¶å°å‘ç°äº†é”™è¯¯æ ¹å› ï¼Œæ˜¯Metaspaceå‘ç”Ÿäº†oomã€‚</p><p>æ‰€ä»¥ç€é‡åˆ†æä¸‹Metaspaceä¸ºä»€ä¹ˆä¼šoomã€‚</p><h2 id=å‰ç½®çŸ¥è¯†>å‰ç½®çŸ¥è¯†<a hidden class=anchor aria-hidden=true href=#å‰ç½®çŸ¥è¯†>#</a></h2><h3 id=å¯åŠ¨å‚æ•°>å¯åŠ¨å‚æ•°<a hidden class=anchor aria-hidden=true href=#å¯åŠ¨å‚æ•°>#</a></h3><p>å…ˆçœ‹ä¸‹å¯åŠ¨å‚æ•°ï¼Œçœ‹ä¸‹JVMå…·ä½“çš„å‚æ•°é…ç½®</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>-</span>Xmx4096M <span style=color:#f92672>-</span>Xms4096M <span style=color:#f92672>-</span>Xmn2048M 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:MaxMetaspaceSize<span style=color:#f92672>=</span><span style=color:#ae81ff>512</span>M <span style=color:#f92672>-</span>XX:MetaspaceSize<span style=color:#f92672>=</span><span style=color:#ae81ff>512</span>M 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>UseConcMarkSweepGC <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>UseCMSInitiatingOccupancyOnly <span style=color:#f92672>-</span>XX:CMSInitiatingOccupancyFraction<span style=color:#f92672>=</span><span style=color:#ae81ff>70</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>ExplicitGCInvokesConcurrentAndUnloadsClasses <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>CMSClassUnloadingEnabled 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>ParallelRefProcEnabled <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>CMSScavengeBeforeRemark 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>HeapDumpOnOutOfMemoryError <span style=color:#f92672>-</span>XX:ErrorFile<span style=color:#f92672>=/</span>data<span style=color:#f92672>/</span>logs<span style=color:#f92672>/</span>hs_err_pid<span style=color:#f92672>%</span>p<span style=color:#f92672>.</span>log <span style=color:#f92672>-</span>Xloggc:<span style=color:#f92672>/</span>dev<span style=color:#f92672>/</span>shm<span style=color:#f92672>/</span>gc<span style=color:#f92672>.</span>log 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:HeapDumpPath<span style=color:#f92672>=/</span>data<span style=color:#f92672>/</span>logs<span style=color:#f92672>/</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCDetails <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCDateStamps 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintClassHistogramBeforeFullGC <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintClassHistogramAfterFullGC 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintCommandLineFlags <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCApplicationConcurrentTime 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCApplicationStoppedTime <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintTenuringDistribution 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintHeapAtGC <span style=color:#f92672>-</span>Ddubbo<span style=color:#f92672>.</span>reference<span style=color:#f92672>.</span>check<span style=color:#f92672>=</span>false 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>UnlockDiagnosticVMOptions
</span></span></code></pre></div><p>è¿™ä¸ªæ˜¯å…¬å¸é»˜è®¤çš„jvmå‚æ•°ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå †æœ€å¤§æ˜¯4gï¼Œmetaspaceæœ€å¤§æ˜¯512mï¼Œmetaspaceç»™çš„ç©ºé—´å·²ç»å¾ˆå¤§äº†ï¼Œä½†è¿˜æ˜¯å‘ç”Ÿäº†oomã€‚</p><p>å…³äºmetaspaceçš„å¤§å°çš„é…ç½®é¡¹ï¼Œæˆ‘ä»¬åé¢å†æä¸€ä¸‹å…·ä½“å«ä¹‰ã€‚</p><h3 id=metaspaceé‡Œæœ‰ä»€ä¹ˆ>Metaspaceé‡Œæœ‰ä»€ä¹ˆ<a hidden class=anchor aria-hidden=true href=#metaspaceé‡Œæœ‰ä»€ä¹ˆ>#</a></h3><p>åˆ†æMetaspace oomä¹‹å‰ï¼Œå…ˆç¡®è®¤ä¸‹metaspaceé‡Œä¼šæœ‰å“ªäº›ä¸œè¥¿ã€‚jdk1.8ç›¸æ¯”1.7ï¼Œç§»é™¤äº†perm genï¼ŒæŠŠclass,method,constant poolç­‰å†…å®¹ç§»åˆ°äº†metaspaceï¼Œå•ç‹¬çš„ä¸€å—åŒºåŸŸï¼Œå’Œæœºå™¨å†…å­˜ç›´æ¥ç›¸å…³ï¼Œä¸å—å †ç®¡æ§ã€‚</p><p>åœ¨åº•å±‚ï¼ŒMetaSpace ä¸»è¦ç”± Klass Metaspace å’Œ NoKlass Metaspace ä¸¤å¤§éƒ¨åˆ†ç»„æˆã€‚</p><p>Klass MetaSpaceï¼š å°±æ˜¯ç”¨æ¥å­˜ Klass çš„ï¼Œå°±æ˜¯ Class æ–‡ä»¶åœ¨ JVM é‡Œçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼Œè¿™éƒ¨åˆ†é»˜è®¤æ”¾åœ¨ Compressed Class Pointer Space ä¸­ï¼Œæ˜¯ä¸€å—è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œç´§æ¥ç€ Heapã€‚</p><p>Compressed Class Pointer Space ä¸æ˜¯å¿…é¡»æœ‰çš„ï¼Œå¦‚æœè®¾ç½®äº† -XX:-UseCompressedClassPointersï¼Œæˆ–è€… -Xmx è®¾ç½®å¤§äº 32 Gï¼Œå°±ä¸ä¼šæœ‰è¿™å—å†…å­˜ï¼Œè¿™ç§æƒ…å†µä¸‹ Klass éƒ½ä¼šå­˜åœ¨ NoKlass Metaspace é‡Œã€‚</p><p>NoKlass MetaSpaceï¼š ä¸“é—¨æ¥å­˜ Klass ç›¸å…³çš„å…¶ä»–çš„å†…å®¹ï¼Œæ¯”å¦‚ Methodï¼ŒConstantPool ç­‰ï¼Œå¯ä»¥ç”±å¤šå—ä¸è¿ç»­çš„å†…å­˜ç»„æˆã€‚è™½ç„¶å«åš NoKlass Metaspaceï¼Œä½†æ˜¯ä¹Ÿå…¶å®å¯ä»¥å­˜ Klass çš„å†…å®¹ï¼Œä¸Šé¢å·²ç»æåˆ°äº†å¯¹åº”åœºæ™¯ã€‚</p><p>MetaSpace çš„å¯¹è±¡ä¸ºä»€ä¹ˆæ— æ³•é‡Šæ”¾ï¼Œæˆ‘ä»¬çœ‹ä¸‹é¢ä¸¤ç‚¹</p><ul><li><strong>MetaSpace å†…å­˜ç®¡ç†ï¼š</strong> ç±»å’Œå…¶å…ƒæ•°æ®çš„ç”Ÿå‘½å‘¨æœŸä¸å…¶å¯¹åº”çš„ç±»åŠ è½½å™¨ç›¸åŒï¼Œåªè¦ç±»çš„ç±»åŠ è½½å™¨æ˜¯å­˜æ´»çš„ï¼Œåœ¨ Metaspace ä¸­çš„ç±»å…ƒæ•°æ®ä¹Ÿæ˜¯å­˜æ´»çš„ï¼Œä¸èƒ½è¢«å›æ”¶ã€‚æ¯ä¸ªåŠ è½½å™¨æœ‰å•ç‹¬çš„å­˜å‚¨ç©ºé—´ï¼Œé€šè¿‡ ClassLoaderMetaspace æ¥è¿›è¡Œç®¡ç† SpaceManager* çš„æŒ‡é’ˆï¼Œç›¸äº’éš”ç¦»çš„ã€‚</li><li><strong>MetaSpace å¼¹æ€§ä¼¸ç¼©ï¼š</strong> ç”±äº MetaSpace ç©ºé—´å’Œ Heap å¹¶ä¸åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥è¿™å—çš„ç©ºé—´å¯ä»¥ä¸ç”¨è®¾ç½®æˆ–è€…å•ç‹¬è®¾ç½®ï¼Œä¸€èˆ¬æƒ…å†µä¸‹é¿å… MetaSpace è€—å°½ VM å†…å­˜éƒ½ä¼šè®¾ç½®ä¸€ä¸ª MaxMetaSpaceSizeï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®é™…å¤§å°å°äºè¿™ä¸ªå€¼ï¼ŒJVM å°±ä¼šé€šè¿‡ <code>-XX:MinMetaspaceFreeRatio</code> å’Œ <code>-XX:MaxMetaspaceFreeRatio</code> ä¸¤ä¸ªå‚æ•°åŠ¨æ€æ§åˆ¶æ•´ä¸ª MetaSpace çš„å¤§å°ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨ CMSCollector å’Œ G1CollectorHeap ç­‰å‡ ä¸ªæ”¶é›†å™¨æ‰§è¡Œ GC æ—¶è°ƒç”¨ã€‚è¿™ä¸ªé‡Œé¢ä¼šæ ¹æ® <code>used_after_gc</code>ï¼Œ<code>MinMetaspaceFreeRatio</code> å’Œ <code>MaxMetaspaceFreeRatio</code> è¿™ä¸‰ä¸ªå€¼è®¡ç®—å‡ºæ¥ä¸€ä¸ªæ–°çš„ <code>_capacity_until_GC</code> å€¼ï¼ˆæ°´ä½çº¿ï¼‰ã€‚ç„¶åæ ¹æ®å®é™…çš„ <code>_capacity_until_GC</code> å€¼ä½¿ç”¨ <code>MetaspaceGC::inc_capacity_until_GC()</code> å’Œ <code>MetaspaceGC::dec_capacity_until_GC()</code> è¿›è¡Œ expand æˆ– shrinkã€‚</li></ul><p>ä¸ºäº†é¿å…å¼¹æ€§ä¼¸ç¼©å¸¦æ¥çš„é¢å¤– GC æ¶ˆè€—ï¼Œä¸€èˆ¬è¦å°† <code>-XX:MetaSpaceSize</code> å’Œ <code>-XX:MaxMetaSpaceSize</code> ä¸¤ä¸ªå€¼è®¾ç½®ä¸ºå›ºå®šçš„ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¼šå¯¼è‡´åœ¨ç©ºé—´ä¸å¤Ÿçš„æ—¶å€™æ— æ³•æ‰©å®¹ï¼Œç„¶åé¢‘ç¹åœ°è§¦å‘ GCï¼Œæœ€ç»ˆ OOMã€‚</p><p>æ‰€ä»¥å…³é”®åŸå› å°±æ˜¯ ClassLoader ä¸åœåœ°åœ¨å†…å­˜ä¸­ load äº†æ–°çš„ Class ï¼Œä¸€èˆ¬è¿™ç§é—®é¢˜éƒ½å‘ç”Ÿåœ¨åŠ¨æ€ç±»åŠ è½½ç­‰æƒ…å†µä¸Šã€‚</p><p>å¯èƒ½å‡ºç°é—®é¢˜çš„ç‚¹æœ‰å¦‚ä¸‹å‡ ä¸ª</p><ul><li>groovyåŠ¨æ€åŠ è½½ç±»</li><li>åå°„ä½¿ç”¨ä¸å½“é¢‘ç¹åˆ›å»ºç±»</li><li>Orika çš„ classMap</li><li>JSON çš„ ASMSerializer</li></ul><p>åŸºæœ¬éƒ½é›†ä¸­åœ¨åå°„ã€Javasisit å­—èŠ‚ç å¢å¼ºã€CGLIB åŠ¨æ€ä»£ç†ã€OSGi è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç­‰çš„æŠ€æœ¯ç‚¹ä¸Šã€‚</p><h3 id=æ’æŸ¥æ‰‹æ®µ>æ’æŸ¥æ‰‹æ®µ<a hidden class=anchor aria-hidden=true href=#æ’æŸ¥æ‰‹æ®µ>#</a></h3><p>æœ‰äº†ä¸Šé¢çš„èƒŒæ™¯ä¹‹åï¼Œæˆ‘ä»¬æ’æŸ¥æ–¹å‘åˆ†ä¸º2éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯çœ‹å‘ç‰ˆè®°å½•ï¼Œæœ€è¿‘æœ‰å“ªäº›æ”¹åŠ¨ï¼Œå“ªäº›åœ°æ–¹å¯èƒ½ä¼šé¢‘ç¹åˆ›å»ºç±»ï¼ŒäºŒæ˜¯ä»jvmå±‚é¢æ’æŸ¥ã€‚æˆ‘ä»¬é‡ç‚¹è¯´ä¸€ä¸‹jvmå±‚é¢çš„æ’æŸ¥æ–¹å‘ã€‚</p><p><em><strong>æ³¨æ„äº‹é¡¹: å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œé—®é¢˜å·²ç»è§£å†³ï¼Œæ‰€ä»¥éƒ¨åˆ†æ•°æ®ä¸æ˜¯å‡ºé—®é¢˜æ—¶é‡‡é›†çš„æ•°æ®ï¼Œæ˜¯ä¸ºäº†å†™æ–‡ç« ä½¿ç”¨å¯¹åº”çš„æ’æŸ¥å·¥å…·ç”Ÿæˆçš„æ•°æ®ï¼Œå…·ä½“ä½ç½®å¤„ä¼šæ ‡æ˜æ•°æ®æ¥æºå’Œæ—¶æœº</strong></em></p><h3 id=jvmæ’æŸ¥>JVMæ’æŸ¥<a hidden class=anchor aria-hidden=true href=#jvmæ’æŸ¥>#</a></h3><p>jdkè‡ªå¸¦çš„æ’æŸ¥å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨çš„æœ‰jps,jstat,jmapç­‰</p><p>å…¶ä¸­jmapçœ‹çš„æ˜¯å †çš„å†…å­˜å¤§å°å’Œåˆ†é…</p><p>jstatå¯ä»¥çœ‹gcç›¸å…³ä¿¡æ¯.</p><p>gc.logé‡Œçš„gcæ—¥å¿—ä¹Ÿå¯ä»¥è¾…åŠ©æˆ‘ä»¬æ’æŸ¥</p><h4 id=jmap>jmap<a hidden class=anchor aria-hidden=true href=#jmap>#</a></h4><p>jmap -heap pidçš„ä¿¡æ¯å¦‚ä¸‹ï¼Œè¿™ä¸ªå¯ä»¥è¾…åŠ©æˆ‘ä»¬çœ‹ä¸‹å †å†…åˆ†ä»£çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œå½“ç„¶è¿™ä¸ªå¯¹æˆ‘ä»¬çš„æ’æŸ¥å¸®åŠ©ä¸å¤§ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹å‘½ä»¤æ•ˆæœ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Attaching to process ID 5311, please wait...
</span></span><span style=display:flex><span>Debugger attached successfully.
</span></span><span style=display:flex><span>Server compiler detected.
</span></span><span style=display:flex><span>JVM version is 25.73-b02
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>using parallel threads in the new generation.
</span></span><span style=display:flex><span>using thread-local object allocation.
</span></span><span style=display:flex><span>Concurrent Mark-Sweep GC
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Heap Configuration:
</span></span><span style=display:flex><span>   MinHeapFreeRatio         = 40
</span></span><span style=display:flex><span>   MaxHeapFreeRatio         = 70
</span></span><span style=display:flex><span>   MaxHeapSize              = 4294967296 (4096.0MB)
</span></span><span style=display:flex><span>   NewSize                  = 2147483648 (2048.0MB)
</span></span><span style=display:flex><span>   MaxNewSize               = 2147483648 (2048.0MB)
</span></span><span style=display:flex><span>   OldSize                  = 2147483648 (2048.0MB)
</span></span><span style=display:flex><span>   NewRatio                 = 2
</span></span><span style=display:flex><span>   SurvivorRatio            = 8
</span></span><span style=display:flex><span>   MetaspaceSize            = 536870912 (512.0MB)
</span></span><span style=display:flex><span>   CompressedClassSpaceSize = 1073741824 (1024.0MB)
</span></span><span style=display:flex><span>   MaxMetaspaceSize         = 536870912 (512.0MB)
</span></span><span style=display:flex><span>   G1HeapRegionSize         = 0 (0.0MB)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Heap Usage:
</span></span><span style=display:flex><span>New Generation (Eden + 1 Survivor Space):
</span></span><span style=display:flex><span>   capacity = 1932787712 (1843.25MB)
</span></span><span style=display:flex><span>   used     = 735313536 (701.2496337890625MB)
</span></span><span style=display:flex><span>   free     = 1197474176 (1142.0003662109375MB)
</span></span><span style=display:flex><span>   38.04419551276617% used
</span></span><span style=display:flex><span>Eden Space:
</span></span><span style=display:flex><span>   capacity = 1718091776 (1638.5MB)
</span></span><span style=display:flex><span>   used     = 733845856 (699.8499450683594MB)
</span></span><span style=display:flex><span>   free     = 984245920 (938.6500549316406MB)
</span></span><span style=display:flex><span>   42.71284376370823% used
</span></span><span style=display:flex><span>From Space:
</span></span><span style=display:flex><span>   capacity = 214695936 (204.75MB)
</span></span><span style=display:flex><span>   used     = 1467680 (1.399688720703125MB)
</span></span><span style=display:flex><span>   free     = 213228256 (203.35031127929688MB)
</span></span><span style=display:flex><span>   0.683608654800061% used
</span></span><span style=display:flex><span>To Space:
</span></span><span style=display:flex><span>   capacity = 214695936 (204.75MB)
</span></span><span style=display:flex><span>   used     = 0 (0.0MB)
</span></span><span style=display:flex><span>   free     = 214695936 (204.75MB)
</span></span><span style=display:flex><span>   0.0% used
</span></span><span style=display:flex><span>concurrent mark-sweep generation:
</span></span><span style=display:flex><span>   capacity = 2147483648 (2048.0MB)
</span></span><span style=display:flex><span>   used     = 613751744 (585.3192749023438MB)
</span></span><span style=display:flex><span>   free     = 1533731904 (1462.6807250976562MB)
</span></span><span style=display:flex><span>   28.580042719841003% used
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>66527 interned Strings occupying 7048176 bytes.
</span></span></code></pre></div><p>è¿˜æœ‰ä¸€ä¸ªå‘½ä»¤æ˜¯jmap -histo pidï¼Œè¿™ä¸ªå¯ä»¥çœ‹å †å†…å­˜æ´»çš„å¯¹è±¡ç±»å‹å’Œå®ä¾‹æ•°é‡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span> num     #instances         #bytes  class name
</span></span><span style=display:flex><span>----------------------------------------------
</span></span><span style=display:flex><span>   1:       5478775      506824136  [C
</span></span><span style=display:flex><span>   2:       1421313      315369496  [B
</span></span><span style=display:flex><span>   3:       3791992       91007808  java.lang.String
</span></span><span style=display:flex><span>   4:       2593077       82978464  java.util.HashMap$Node
</span></span><span style=display:flex><span>   5:        730043       78351624  [I
</span></span><span style=display:flex><span>   6:       1393624       67623928  [Ljava.lang.Object;
</span></span><span style=display:flex><span>   7:        712992       62743296  java.lang.reflect.Method
</span></span><span style=display:flex><span>   8:        317758       48979560  [Ljava.util.HashMap$Node;
</span></span><span style=display:flex><span>   9:        178237       32795608  com.fasterxml.jackson.core.json.UTF8StreamJsonParser
</span></span><span style=display:flex><span>  10:        513502       20540080  java.util.LinkedHashMap$Entry
</span></span><span style=display:flex><span>  11:        639968       20478976  com.mysql.cj.conf.BooleanProperty
</span></span><span style=display:flex><span>  12:        941240       18059848  [Ljava.lang.Class;
</span></span><span style=display:flex><span>  13:        353510       16968480  java.util.HashMap
</span></span><span style=display:flex><span>  14:        241178       13505968  sun.nio.cs.UTF_8$Encoder
</span></span><span style=display:flex><span>  15:        539462       12947088  java.lang.StringBuilder
</span></span><span style=display:flex><span>  16:        178448       12848256  com.fasterxml.jackson.databind.deser.DefaultDeserializationContext$Impl
</span></span><span style=display:flex><span>  17:        218814       12253584  com.fasterxml.jackson.core.io.IOContext
</span></span></code></pre></div><h4 id=jstat>jstat<a hidden class=anchor aria-hidden=true href=#jstat>#</a></h4><p>ä½¿ç”¨jstatè§‚å¯Ÿgcå’Œmetaspaceçš„ä½¿ç”¨æƒ…å†µï¼Œjstatä¸»è¦è¾“å‡ºå„ä¸ªåŒºåŸŸçš„ä½¿ç”¨é‡æ¯”ä¾‹(<em><strong>å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™é—®é¢˜å·²ä¿®å¤ï¼Œæ‰€ä»¥metaspaceä½¿ç”¨å æ¯”æ¯”è¾ƒå¹³ç¨³</strong></em>)</p><p><code>jstat -gcutil 5311</code> è¿™ä¸ªå‘½ä»¤ä»¥1000msä¸ºé—´éš”ï¼Œè¾“å‡ºpid 5311çš„è¿›ç¨‹çš„gcæƒ…å†µï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡ºmetaspaceçš„ä½¿ç”¨æ¯”ä¾‹çš„å˜åŒ–</p><p>æ¯”å¦‚s0æ˜¯survivo 0å½“å‰ç©ºé—´çš„å·²ä½¿ç”¨æ¯”ä¾‹ï¼Œs1çš„survivo 1å½“å‰ç©ºé—´çš„å·²ä½¿ç”¨æ¯”ä¾‹ï¼ŒEæ˜¯edenåŒºçš„å·²ä½¿ç”¨æ¯”ä¾‹ï¼ŒOæ˜¯old gençš„å·²ä½¿ç”¨æ¯”ä¾‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   
</span></span><span style=display:flex><span>  0.00   1.04  57.32  27.40  92.59  86.14 125511 1969.952    28    5.062 1975.014
</span></span><span style=display:flex><span>  0.00   1.04  78.69  27.40  92.59  86.14 125511 1969.952    28    5.062 1975.014
</span></span><span style=display:flex><span>  0.00   1.04  97.81  27.40  92.59  86.14 125511 1969.952    28    5.062 1975.014
</span></span><span style=display:flex><span>  0.98   0.00  32.47  27.40  92.59  86.14 125512 1969.968    28    5.062 1975.031
</span></span><span style=display:flex><span>  0.98   0.00  66.19  27.40  92.59  86.14 125512 1969.968    28    5.062 1975.031
</span></span><span style=display:flex><span>  0.98   0.00  91.34  27.40  92.59  86.14 125512 1969.968    28    5.062 1975.031
</span></span><span style=display:flex><span>  0.00   0.81  17.07  27.41  92.59  86.14 125513 1969.980    28    5.062 1975.042
</span></span><span style=display:flex><span>  0.00   0.81  39.36  27.41  92.59  86.14 125513 1969.980    28    5.062 1975.042
</span></span><span style=display:flex><span>  0.00   0.81  60.87  27.41  92.59  86.14 125513 1969.980    28    5.062 1975.042
</span></span><span style=display:flex><span>  0.00   0.81  89.84  27.41  92.59  86.14 125513 1969.980    28    5.062 1975.042
</span></span><span style=display:flex><span>  0.89   0.00   9.76  27.42  92.59  86.14 125514 1969.995    28    5.062 1975.058
</span></span><span style=display:flex><span>  0.89   0.00  25.07  27.42  92.59  86.14 125514 1969.995    28    5.062 1975.058
</span></span><span style=display:flex><span>  0.89   0.00  44.26  27.42  92.59  86.14 125514 1969.995    28    5.062 1975.058
</span></span></code></pre></div><h4 id=gclog>gc.log<a hidden class=anchor aria-hidden=true href=#gclog>#</a></h4><p>å¦ä¸€ä¸ªå°±æ˜¯ä»gc.logé‡ŒæŸ¥çœ‹metaspaceçš„æ—¥å¿—,ä¸‹é¢ä¸€æ®µæ—¥å¿—æ˜¯gcå‰å’Œgcåå„ä¸ªåŒºåŸŸçš„å†…å­˜å˜åŒ–</p><p>å¯ä»¥è§‚å¯Ÿä¸‹heap before gcå’Œheap after gc2å¤„çš„metaspaceç©ºé—´ä½¿ç”¨å˜åŒ–(<em><strong>æ­¤å¤„æ˜¯é—®é¢˜è§£å†³åçš„gc.log,ä»…ä¾›å‚è€ƒ</strong></em>)</p><p>metaspaceæ•°æ®å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è·ç¦»512mè¿˜æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œæ³¨æ„æ­¤å¤„æ˜¯é—®é¢˜è§£å†³åçš„æ•°æ®ï¼Œä»…ä¾›æ’æŸ¥å‚è€ƒ</p><ul><li>used 176869Kï¼Œ å·²ä½¿ç”¨å¤§æ¦‚æ˜¯172m</li><li>capacity 189800Kï¼Œ å®¹é‡å¤§æ¦‚æ˜¯185m</li><li>committed 190848Kï¼Œå·²æäº¤å¤§æ¦‚æ˜¯186m</li><li>reserved 1216512Kï¼Œä¿ç•™å¤§æ¦‚æ˜¯1188m</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>2023-09-12T09:03:08.449+0800: 1249459.698: Total time for which application threads were stopped: 0.0195137 seconds, Stopping threads took: 0.0001738 seconds
</span></span><span style=display:flex><span>2023-09-12T09:03:11.392+0800: 1249462.641: Application time: 2.9429699 seconds
</span></span><span style=display:flex><span>2023-09-12T09:03:11.396+0800: 1249462.646: Total time for which application threads were stopped: 0.0046629 seconds, Stopping threads took: 0.0002150 seconds
</span></span><span style=display:flex><span>2023-09-12T09:03:11.397+0800: 1249462.646: Application time: 0.0000922 seconds
</span></span><span style=display:flex><span>2023-09-12T09:03:11.400+0800: 1249462.649: Total time for which application threads were stopped: 0.0034414 seconds, Stopping threads took: 0.0001087 seconds
</span></span><span style=display:flex><span>2023-09-12T09:03:14.304+0800: 1249465.553: Application time: 2.9035482 seconds
</span></span><span style=display:flex><span>{Heap before GC invocations=130961 (full 14):
</span></span><span style=display:flex><span> par new generation   total 1887488K, used 1679309K [0x00000006c0000000, 0x0000000740000000, 0x0000000740000000)
</span></span><span style=display:flex><span>  eden space 1677824K, 100% used [0x00000006c0000000, 0x0000000726680000, 0x0000000726680000)
</span></span><span style=display:flex><span>  from space 209664K,   0% used [0x0000000733340000, 0x00000007334b34a0, 0x0000000740000000)
</span></span><span style=display:flex><span>  to   space 209664K,   0% used [0x0000000726680000, 0x0000000726680000, 0x0000000733340000)
</span></span><span style=display:flex><span> concurrent mark-sweep generation total 2097152K, used 1209833K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000)
</span></span><span style=display:flex><span> Metaspace       used 176869K, capacity 189800K, committed 190848K, reserved 1216512K
</span></span><span style=display:flex><span>  class space    used 19973K, capacity 22145K, committed 23168K, reserved 1048576K
</span></span><span style=display:flex><span>2023-09-12T09:03:14.307+0800: 1249465.557: [GC (Allocation Failure) 2023-09-12T09:03:14.307+0800: 1249465.557: [ParNew
</span></span><span style=display:flex><span>Desired survivor size 107347968 bytes, new threshold 6 (max 6)
</span></span><span style=display:flex><span>- age   1:     674280 bytes,     674280 total
</span></span><span style=display:flex><span>- age   2:     177208 bytes,     851488 total
</span></span><span style=display:flex><span>- age   3:     238904 bytes,    1090392 total
</span></span><span style=display:flex><span>- age   4:     191384 bytes,    1281776 total
</span></span><span style=display:flex><span>- age   5:      38080 bytes,    1319856 total
</span></span><span style=display:flex><span>- age   6:      40232 bytes,    1360088 total
</span></span><span style=display:flex><span>: 1679309K-&gt;1868K(1887488K), 0.0143320 secs] 2889142K-&gt;1211742K(3984640K), 0.0146560 secs] [Times: user=0.03 sys=0.01, real=0.01 secs] 
</span></span><span style=display:flex><span>Heap after GC invocations=130962 (full 14):
</span></span><span style=display:flex><span> par new generation   total 1887488K, used 1868K [0x00000006c0000000, 0x0000000740000000, 0x0000000740000000)
</span></span><span style=display:flex><span>  eden space 1677824K,   0% used [0x00000006c0000000, 0x00000006c0000000, 0x0000000726680000)
</span></span><span style=display:flex><span>  from space 209664K,   0% used [0x0000000726680000, 0x0000000726853010, 0x0000000733340000)
</span></span><span style=display:flex><span>  to   space 209664K,   0% used [0x0000000733340000, 0x0000000733340000, 0x0000000740000000)
</span></span><span style=display:flex><span> concurrent mark-sweep generation total 2097152K, used 1209874K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000)
</span></span><span style=display:flex><span> Metaspace       used 176869K, capacity 189800K, committed 190848K, reserved 1216512K
</span></span><span style=display:flex><span>  class space    used 19973K, capacity 22145K, committed 23168K, reserved 1048576K
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=jcmd>jcmd<a hidden class=anchor aria-hidden=true href=#jcmd>#</a></h4><p>æœ€åä¸€ä¸ªå¯ç”¨çš„jvmå·¥å…·å°±æ˜¯cmdï¼Œä½¿ç”¨jcmdæ‰“å°ä¸‹classæ•°é‡ï¼Œçœ‹ä¸‹å“ªäº›åŒ…ä¸‹çš„ç±»å¢é•¿æ¯”è¾ƒå¿«</p><p>ä½¿ç”¨å‘½ä»¤å¦‚ä¸‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>jcmd &lt;PID&gt; GC.class_stats|awk &#39;{print$13}&#39;|sed  &#39;s/\(.*\)\.\(.*\)/\1/g&#39;|sort |uniq -c|sort -nrk1
</span></span></code></pre></div><p>å®é™…è¿›ç¨‹æ‰“å°å¦‚ä¸‹,å¯ä»¥çœ‹åˆ°æœ€å¤šçš„æ˜¯sun.reflectåŒ…ä¸‹çš„classæœ€å¤š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>   2283 sun.reflect
</span></span><span style=display:flex><span>    416 com.xx.xx.xx.xx.impl
</span></span><span style=display:flex><span>    316 java.lang.invoke
</span></span><span style=display:flex><span>    306 com.sun.proxy
</span></span><span style=display:flex><span>    275 reactor.core.publisher
</span></span><span style=display:flex><span>    268 java.util
</span></span><span style=display:flex><span>    198 com.google.common.collect
</span></span><span style=display:flex><span>    189 com.google.protobuf
</span></span><span style=display:flex><span>    181 io.netty.channel
</span></span><span style=display:flex><span>    174 java.lang
</span></span></code></pre></div><h3 id=dumpåˆ†æ>dumpåˆ†æ<a hidden class=anchor aria-hidden=true href=#dumpåˆ†æ>#</a></h3><p>dump å¿«ç…§ä¹‹åé€šè¿‡ JProfiler æˆ– MAT è§‚å¯Ÿ Classes çš„ Histogram (ç›´æ–¹å›¾) ï¼Œè¿™ä¸ªä¼°è®¡å¾—æ·±åšçš„åŠŸåŠ›æ‰èƒ½çœ‹å‡ºæ¥</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131533501.png alt=image-20230912134908936></p><h3 id=arthas>arthas<a hidden class=anchor aria-hidden=true href=#arthas>#</a></h3><p>arthasä¹Ÿæœ‰å¾ˆå¤šçš„å‘½ä»¤å¯ä»¥å¸®åŠ©æ’æŸ¥ï¼Œæ¯”å¦‚dashboardï¼Œå¯ä»¥çœ‹metaspaceåŒºçš„å†…å­˜å ç”¨ï¼Œvmtoolå¯ä»¥æŸ¥çœ‹å…·ä½“çš„class</p><p>å¦‚ä¸‹æ˜¯dashboradå‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°metaspaceçš„ä½¿ç”¨é‡</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131533082.png alt=image-20230912135302354></p><p>å¯ä»¥ä½¿ç”¨vmtoolï¼ŒåŒ¹é…æŒ‡å®šåŒ…åçš„class</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>vmtool <span style=color:#f92672>--</span>action getInstances <span style=color:#f92672>--</span>className sun<span style=color:#f92672>.</span>reflect<span style=color:#f92672>.*</span> <span style=color:#f92672>--</span>limit <span style=color:#ae81ff>100</span>
</span></span></code></pre></div><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131533919.png alt=image-20230912135822213></p><p>å¯ä»¥ä½¿ç”¨transformï¼Œæœ‰ç±»åŠ è½½çš„æ—¶å€™å°±ä¼šè§¦å‘</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>watch java.lang.instrument.ClassFileTransformer transform &#39;{params,returnObj,throwExp}&#39;  -n 5  -x 3
</span></span></code></pre></div><p>ä¹Ÿå¯ä»¥è·Ÿè¸ªä¸‹class init</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>stack sun.reflect.DelegatingClassLoader &lt;init&gt;  -n 5
</span></span></code></pre></div><h2 id=å®é™…æ’æŸ¥è¿‡ç¨‹>å®é™…æ’æŸ¥è¿‡ç¨‹<a hidden class=anchor aria-hidden=true href=#å®é™…æ’æŸ¥è¿‡ç¨‹>#</a></h2><p>å‰é¢ä»‹ç»äº†ä¸€äº›å…³äºmetaspaceçš„çŸ¥è¯†ï¼Œä¹Ÿä»‹ç»äº†ä¸€äº›æ’æŸ¥æ–¹å‘ï¼Œæ¥ä¸‹æ¥ä»‹ç»ä¸‹å®é™…æ’æŸ¥è¿‡ç¨‹</p><p>æ¥åˆ°å‘Šè­¦ä¹‹åï¼ŒæŸ¥çœ‹è¿›ç¨‹ï¼Œå‘ç°äº†metaspace oomçš„é”™è¯¯ï¼Œäºæ˜¯å¼€å§‹å¾€metaspace oomçš„æ–¹å‘å¼€å§‹æ’æŸ¥</p><p>ç»è¿‡ä¸€é€šgoogle/baiduä¹‹åï¼Œå‘ç°äº†å¦‚ä¸Šä»‹ç»çš„ä¸€äº›æ–¹å‘å’Œæ‰‹æ®µ</p><p>é¦–å…ˆæ˜¯çœ‹äº†ç¾å›¢çš„æ–‡ç« <a href=https://tech.meituan.com/2020/11/12/java-9-cms-gc.html>åœºæ™¯ä¸‰ï¼šMetaSpace åŒº OOM</a></p><p>å‘ç°å¯ä»¥ä½¿ç”¨jcmdå‘½ä»¤è¿›è¡Œæ’æŸ¥ï¼Œçœ‹ä¸‹å“ªä¸ªåŒ…çš„classæ¯”è¾ƒå¤šï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¾—åˆ°å¦‚ä¸‹çš„ç»“æœ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>jcmd 5311 GC.class_stats|awk &#39;{print$13}&#39;|sed  &#39;s/\(.*\)\.\(.*\)/\1/g&#39;|sort |uniq -c|sort -nrk1|head -n 10
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> 2294 sun.reflect
</span></span><span style=display:flex><span>    416 com.xx.impl
</span></span><span style=display:flex><span>    316 java.lang.invoke
</span></span><span style=display:flex><span>    316 com.sun.proxy
</span></span><span style=display:flex><span>    275 reactor.core.publisher
</span></span><span style=display:flex><span>    268 java.util
</span></span><span style=display:flex><span>    198 com.google.common.collect
</span></span><span style=display:flex><span>    189 com.google.protobuf
</span></span><span style=display:flex><span>    181 io.netty.channel
</span></span><span style=display:flex><span>    174 java.lang
</span></span></code></pre></div><p>å¤šæ¬¡æ‰§è¡Œjcmdä¹‹åï¼Œå‘ç°sun.reflectåŒ…ä¸‹çš„classæ¯”è¾ƒå¤šï¼Œä¸”æœ‰å¢é•¿ï¼Œäºæ˜¯æŠŠç›®å…‰æ”¾åœ¨äº†sun.reflectä¸Šã€‚</p><p>ä»¥ä¸ºæ˜¯åå°„ç”¨çš„ä¸å½“å¯¼è‡´çš„ï¼Œç„¶åä½¿ç”¨arthasï¼Œåˆ†æäº†dashboardä»¥åŠä½¿ç”¨äº†vmtoolæŸ¥çœ‹sun.reflectåŒ…çš„instanceã€‚</p><p>å½“æ—¶ä½¿ç”¨dashboardåˆ†æï¼Œmetaspaceä¸Šæ¶¨çš„éå¸¸çš„å¿«ï¼Œç„¶åä½¿ç”¨vmtoolå‘½ä»¤æŸ¥çœ‹sun.reflect</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>vmtool <span style=color:#f92672>--</span>action getInstances <span style=color:#f92672>--</span>className sun<span style=color:#f92672>.</span>reflect<span style=color:#f92672>.*</span> <span style=color:#f92672>--</span>limit <span style=color:#ae81ff>100</span>
</span></span></code></pre></div><p>æ‰§è¡Œç»“æœç±»ä¼¼ä¸‹å›¾</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131533382.png alt=image-20230912135822213></p><p>åˆ†æå‘ç°é‡Œé¢æœ‰mytabisï¼Œä¹Ÿæœ‰è‡ªå·±è°ƒç”¨äº§ç”Ÿçš„åå°„ï¼Œä½†æ˜¯ä¸è¶³ä»¥å¯¼è‡´metaspace oom</p><p>åæ¥æƒ³åˆ°äº†åŠ ä¸Šå¦‚ä¸‹2ä¸ªå‚æ•°,ç”¨äºæ‰“å°ç±»åŠ è½½ã€å¸è½½æ—¥å¿—</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>TraceClassLoading <span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>TraceClassUnloading
</span></span></code></pre></div><p>ç”±äºå‘å¸ƒç³»ç»Ÿé»˜è®¤æ²¡æ‰“nohupæ—¥å¿—ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œèµ°äº†ç‚¹å¼¯è·¯ï¼Œç±»åŠ è½½ã€å¸è½½ä¿¡æ¯æ²¡æ‰“åˆ°æ—¥å¿—é‡Œï¼Œåæ¥ä¸Šæœºå™¨æ‰‹åŠ¨ç”¨nohup java -jar xx.jar &ä¹‹åï¼Œå‘ç°äº†ç«¯å€ª</p><p>å¯ä»¥çœ‹åˆ°å¯åŠ¨ä¹‹åï¼Œæ‰“äº†æ¯”è¾ƒå¤šçš„ç±»ä¼¼ä¸‹é¢çš„è¿™äº›æ—¥å¿—ï¼Œå¯ä»¥åˆæ­¥åˆ¤æ–­æ˜¯com.googlecode.aviator.Expressionä½¿ç”¨ä¸å½“é€ æˆçš„</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[Loaded Script_1691559755244_2757/2021240514 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559755339_2758/6228193 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559755492_2759/419920034 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756493_2760/1460748148 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756500_2761/520805009 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756506_2762/398664510 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756573_2763/306461935 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756577_2764/1116508142 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756791_2765/870354750 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756799_2766/1661127610 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559756812_2767/1883979577 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559757019_2768/1281538781 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559757332_2769/589742334 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559757338_2770/1560860126 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559757977_2771/213218340 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559758313_2772/505164301 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559758318_2773/601453331 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759007_2774/1011764766 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759014_2775/338373159 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759146_2776/1714310047 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759154_2777/1663245165 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759227_2778/797537408 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759234_2779/551097430 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759553_2780/594411270 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759559_2781/1720465741 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759586_2782/215181464 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759601_2783/2036721542 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759797_2784/1723282218 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759802_2785/953430028 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759942_2786/847216521 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559759949_2787/1763495463 from com.googlecode.aviator.Expression]
</span></span><span style=display:flex><span>[Loaded Script_1691559760350_2788/47562916 from com.googlecode.aviator.Expression]
</span></span></code></pre></div><p>è·Ÿç€com.googlecode.aviator.Expressionè¿™ä¸ªç±»ï¼Œå‘ç°å¯èƒ½é€ æˆå¼‚å¸¸çš„ä»£ç å¦‚ä¸‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Expression expression = AviatorEvaluator.compile(ruleExpressProcessed);
</span></span></code></pre></div><p>è¿™ä¸ªè¿˜æœ‰ä¸€ä¸ªé‡è½½æ–¹æ³•,æ˜¯å¦ç¼“å­˜</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>public static Expression compile(String expression, boolean cached) {
</span></span><span style=display:flex><span>        return getInstance().compile(expression, cached);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>è·Ÿè¸ªä»£ç ï¼Œæœ€åä¼šå‘ç°cachedå­—æ®µä¼šå½±å“classloaderçš„è·å–ï¼Œå¦‚æœcached=true,åˆ™ä¼šä½¿ç”¨å·²ç¼“å­˜çš„classloaderï¼Œå¦‚æœfalseæ¯æ¬¡éƒ½ä¼šnew ä¸€ä¸ªæ–°çš„classloader</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>com.googlecode.aviator.AviatorEvaluatorInstance#newCodeGenerator(java.lang.String, boolean)
</span></span></code></pre></div><h3 id=é—®é¢˜ä¿®å¤>é—®é¢˜ä¿®å¤<a hidden class=anchor aria-hidden=true href=#é—®é¢˜ä¿®å¤>#</a></h3><p>å°†cachedè®¾ç½®ä¸ºtrue,metaspaceä½¿ç”¨ç‡å°±å¾ˆå¹³ç¨³äº†ï¼Œä¸ä¼šå‡ºç°é«˜é¢‘çš„ç±»åŠ è½½å’Œå¸è½½æƒ…å†µã€‚</p><h2 id=é—®é¢˜å¤ç°>é—®é¢˜å¤ç°<a hidden class=anchor aria-hidden=true href=#é—®é¢˜å¤ç°>#</a></h2><p>æœ¬æ‰“ç®—åœ¨æœ¬åœ°å¤ç°ä¸‹è¿™ä¸ªé—®é¢˜çš„ï¼Œä½†æ˜¯æœ¬åœ°èƒ½gcæ‰ï¼Œç”Ÿäº§ç¯å¢ƒç”±äºæ¯æ¬¡2-3å¤©æ‰ä¼šå‘ç”Ÿoomï¼Œæ‰€ä»¥æ²¡æœ‰å‘ç°oomçš„æ—¶å€™ï¼Œmetaspaceé‡Œæœ‰å“ªäº›å…ƒç´ ï¼Œå¯ä»¥çœ‹ä¸‹æœ¬åœ°éªŒè¯è¿‡ç¨‹å’Œç°è±¡ï¼Œå¸®åŠ©ç†è§£</p><h3 id=æµ‹è¯•ä»£ç >æµ‹è¯•ä»£ç <a hidden class=anchor aria-hidden=true href=#æµ‹è¯•ä»£ç >#</a></h3><p>mavenä¾èµ–</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>        &lt;dependency&gt;
</span></span><span style=display:flex><span>            &lt;groupId&gt;com.googlecode.aviator&lt;/groupId&gt;
</span></span><span style=display:flex><span>            &lt;artifactId&gt;aviator&lt;/artifactId&gt;
</span></span><span style=display:flex><span>            &lt;version&gt;5.2.5&lt;/version&gt;
</span></span><span style=display:flex><span>        &lt;/dependency&gt;
</span></span></code></pre></div><p>jvmå‚æ•°</p><p>å †è®¾ç½®çš„æ¯”è¾ƒå¤§,metaspaceåªè®¾ç½®äº†128m</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>-</span>Xmx4096M
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Xms4096M
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Xmn2048M
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:MaxMetaspaceSize<span style=color:#f92672>=</span><span style=color:#ae81ff>128</span>M
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:MetaspaceSize<span style=color:#f92672>=</span><span style=color:#ae81ff>128</span>M
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>UseConcMarkSweepGC
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>UseCMSInitiatingOccupancyOnly
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:CMSInitiatingOccupancyFraction<span style=color:#f92672>=</span><span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>ExplicitGCInvokesConcurrentAndUnloadsClasses
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>CMSClassUnloadingEnabled
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>ParallelRefProcEnabled
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>CMSScavengeBeforeRemark
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>HeapDumpOnOutOfMemoryError
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:ErrorFile<span style=color:#f92672>=/</span>data<span style=color:#f92672>/</span>logs<span style=color:#f92672>/</span>hs_err_pid<span style=color:#f92672>%</span>p<span style=color:#f92672>.</span>log
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Xloggc:<span style=color:#f92672>/</span>dev<span style=color:#f92672>/</span>shm<span style=color:#f92672>/</span>gc<span style=color:#f92672>.</span>log
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:HeapDumpPath<span style=color:#f92672>=/</span>data<span style=color:#f92672>/</span>logs<span style=color:#f92672>/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCDetails
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCDateStamps
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintClassHistogramBeforeFullGC
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintClassHistogramAfterFullGC
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintCommandLineFlags
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCApplicationConcurrentTime
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintGCApplicationStoppedTime
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintTenuringDistribution
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>PrintHeapAtGC
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Ddubbo<span style=color:#f92672>.</span>reference<span style=color:#f92672>.</span>check<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>UnlockDiagnosticVMOptions
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:NativeMemoryTracking<span style=color:#f92672>=</span>detail
</span></span><span style=display:flex><span><span style=color:#f92672>//</span><span style=color:#66d9ef>class</span> loading unloading
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>TraceClassLoading
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>XX:<span style=color:#f92672>+</span>TraceClassUnloading
</span></span></code></pre></div><p>ä½¿ç”¨å¤šçº¿ç¨‹å»å¹¶å‘è®¿é—®</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>public static void main(String[] args) {
</span></span><span style=display:flex><span>        ThreadFactory threadFactory = new ThreadFactoryBuilder().setNameFormat(&#34;test-pool-%d&#34;).build();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ThreadPoolExecutor executor = new ThreadPoolExecutor(50, 50, 1, TimeUnit.SECONDS, new LinkedBlockingQueue&lt;&gt;(50), threadFactory);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        for (int i = 0; i &lt; 32; i++) {
</span></span><span style=display:flex><span>            executor.execute(() -&gt; {
</span></span><span style=display:flex><span>                while (true) {
</span></span><span style=display:flex><span>                    try {
</span></span><span style=display:flex><span>                        String rule = &#34;field01+ field02&#34;;
</span></span><span style=display:flex><span>                        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
</span></span><span style=display:flex><span>                        int random1 = new Random().nextInt();
</span></span><span style=display:flex><span>                        int random2 = new Random().nextInt();
</span></span><span style=display:flex><span>                        map.put(&#34;field01&#34;, random1);
</span></span><span style=display:flex><span>                        map.put(&#34;field02&#34;, random2);
</span></span><span style=display:flex><span>                        Expression compiledExp = AviatorEvaluator.compile(rule);
</span></span><span style=display:flex><span>                        Object obj = compiledExp.execute(map);
</span></span><span style=display:flex><span>                        System.out.println(obj);
</span></span><span style=display:flex><span>                    } catch (Exception e) {
</span></span><span style=display:flex><span>                        e.printStackTrace();
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>æ§åˆ¶å°ä¹Ÿè¾“å‡ºäº†åŒæ ·çš„æ—¥å¿—</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131532929.png alt=image-20230912163302034></p><p>ç„¶åä½¿ç”¨jconsoleè¿åˆ°jvmä¸Šè§‚å¯Ÿå†…å­˜ä½¿ç”¨æƒ…å†µ</p><p>é¦–å…ˆæ˜¯metaspaceçš„ä½¿ç”¨æƒ…å†µï¼Œæœ€é«˜æ˜¯åˆ°50mï¼Œç„¶ågcæ‰ï¼ŒæŒç»­è¿™ä¸€è¿‡ç¨‹ï¼Œè¯´æ˜metaspaceä½¿ç”¨é‡åœ¨ä¸Šå‡ï¼Œä½†æ˜¯èƒ½gcçš„æ‰ï¼Œè€Œä¸”ä¸ä¼šè§¦å‘é˜ˆå€¼ã€‚</p><p>ç”Ÿäº§ä¸Šå‘ç”Ÿoomï¼Œå¯èƒ½æœ‰æµé‡å› ç´ ï¼Œè®¿é—®é‡æ¯”æœ¬åœ°æ¨¡æ‹Ÿçš„å¤§ã€‚</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141028935.png alt=image-20230914102800888></p><p>åœ¨çœ‹ä¸‹ç±»çš„åŠ è½½å¸è½½æƒ…å†µï¼Œç¨‹åºè¿è¡Œäº†1ä¸ªåŠå°æ—¶ï¼ŒåŠ è½½å’Œå¸è½½æ•°é‡å·®ä¸å¤šæŒå¹³ï¼Œå¤§æ¦‚6529ä¸‡æ¬¡ï¼Œå¯ä»¥å‘ç°ç±»æ˜¯ä¸€ç›´åœ¨åŠ è½½ï¼Œä½†æ˜¯æœ¬åœ°æ¨¡æ‹Ÿçš„æƒ…å†µä¸‹ï¼Œå¸è½½çš„ä¹Ÿå¿«ï¼Œç”Ÿäº§ä¸Šçš„å…·ä½“ç»†èŠ‚ç”±äºç½‘ç»œéš”ç¦»é—®é¢˜ï¼Œæ— æ³•æ¨¡æ‹Ÿå‡ºï¼Œä»…èƒ½æ ¹æ®åŠ è½½æ•°é‡çœ‹å‡ºç±»åŠ è½½æ•°é‡å¼‚å¸¸äº†ï¼Œè¿™å—ä»£ç æ˜¯æœ‰é—®é¢˜çš„</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141026106.png alt=image-20230914102639065></p><p>æ¦‚è§ˆé‡Œå¯ä»¥çœ‹åˆ°å·²åŠ è½½çš„ç±»çš„æ•°é‡ï¼Œåœ¨ä¸€ä¸ªåŒºé—´èŒƒå›´å†…æ³¢åŠ¨ï¼Œä¸€è¾¹åŠ è½½ä¸€è¾¹å¸è½½</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141308641.png alt=image-20230914130832590></p><h3 id=ä¿®å¤éªŒè¯>ä¿®å¤éªŒè¯<a hidden class=anchor aria-hidden=true href=#ä¿®å¤éªŒè¯>#</a></h3><p>ä»£ç ä¿®æ”¹å¦‚ä¸‹ï¼Œå°†cachedè®¾ç½®ä¸ºtrue</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Expression compiledExp = AviatorEvaluator.compile(rule,true);
</span></span></code></pre></div><p>æ¦‚è§ˆæ•°æ®å¦‚ä¸‹ï¼Œå¯ä»¥å‘ç°ç±»åªåŠ è½½äº†2000å¤šä¸ªå°±å¹³ç¨³äº†ï¼Œä¸ä¼šåŠ è½½æ–°çš„class</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141322257.png alt=image-20230914132245192></p><p>metaspaceä½¿ç”¨é‡ç¨³å®šåœ¨13m,ä¸ä¼šæ³¢åŠ¨</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141323256.png alt=image-20230914132321198></p><p>ç±»åœ¨åŠ è½½äº†2274ä¸ªä¹‹åä¿æŒç¨³å®šï¼Œæ²¡æœ‰æ–°å¢</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141323853.png alt=image-20230914132359797></p><p>æ ¹æ®ä¿®æ”¹ä¹‹åçš„ç°è±¡åˆ¤æ–­ï¼Œé€ æˆé—®é¢˜çš„åŸå› å°±æ˜¯æ¯æ¬¡éƒ½ä¼šnew classloaderï¼Œå¯¼è‡´ç±»é¢‘ç¹åŠ è½½å¸è½½ï¼Œå åŠ ç”Ÿäº§æµé‡ä¸å¯æ§ï¼Œæç«¯æƒ…å†µå¯èƒ½å°±ä¼šå¯¼è‡´oom</p><h2 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h2><p>ç”±äºæœªè®¾ç½®metaspaceåŒºç›‘æ§ï¼Œå…·ä½“çš„åŸå› æš‚æœªå‘ç°ï¼Œæ¯”å¦‚Metaspaceé‡Œçš„classæ•°é‡å æ¯”ï¼Œåˆ†ç±»ç­‰ã€‚</p><p>ä¿®å¤ä¹‹åå†ä¸Šçº¿ï¼Œä½¿ç”¨arthasè§‚å¯Ÿmetaspaceä½¿ç”¨é‡ï¼Œå‘ç°metaspaceåŒºåŸŸå†…å­˜ä½¿ç”¨é‡ã€‚</p><p>å…³äºmetaspaceçš„å¯ç”¨èµ„æ–™ï¼Œç›¸æ¯”äºå †å†…å­˜çš„oomæ¥è¯´ï¼Œæ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥æ’æŸ¥ä¸‹æ¥ä¹Ÿæ²¡æœ‰é‚£ä¹ˆé¡ºåˆ©ï¼Œä¸è¿‡ç»è¿‡è¿™æ¬¡é—®é¢˜æ’æŸ¥ï¼Œå¯¹metaspaceæœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œä¸‹æ¬¡å†æ’æŸ¥é—®é¢˜æ—¶ï¼Œå¯ä»¥æœ‰æ›´å¥½çš„åˆ‡å…¥æ–¹å‘äº†</p><h2 id=å‚è€ƒèµ„æ–™>å‚è€ƒèµ„æ–™<a hidden class=anchor aria-hidden=true href=#å‚è€ƒèµ„æ–™>#</a></h2><ul><li><a href=https://tech.meituan.com/2020/11/12/java-9-cms-gc.html>åœºæ™¯ä¸‰ï¼šMetaSpace åŒº OOM</a></li><li><a href=https://www.javadoop.com/post/metaspace>æ·±å…¥ç†è§£å †å¤–å†…å­˜metaspace</a></li></ul></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://blog.thend03.com/img/wechat-pay.png alt=wechat_pay></a><p>å¾®ä¿¡</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://blog.thend03.com/img/alipay.png alt=alipay></a><p>æ”¯ä»˜å®</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>ğŸ§§ é¼“åŠ±</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://blog.thend03.com/posts/heap-oom/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>heap-oom</span>
</a><a class=next href=https://blog.thend03.com/posts/dubbo-spi/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>dubbo spi</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share metaspace-oom on twitter" href="https://twitter.com/intent/tweet/?text=metaspace-oom&amp;url=https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f&amp;hashtags=jvm%2coom"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share metaspace-oom on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f&amp;title=metaspace-oom&amp;summary=metaspace-oom&amp;source=https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share metaspace-oom on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f&title=metaspace-oom"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share metaspace-oom on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share metaspace-oom on whatsapp" href="https://api.whatsapp.com/send?text=metaspace-oom%20-%20https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share metaspace-oom on telegram" href="https://telegram.me/share/url?text=metaspace-oom&amp;url=https%3a%2f%2fblog.thend03.com%2fposts%2fmetaspace-oom%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></div><style>.comments_details summary::marker{font-size:20px;content:'ğŸ‘‰å±•å¼€è¯„è®º';color:var(--content)}.comments_details[open] summary::marker{font-size:20px;content:'ğŸ‘‡å…³é—­è¯„è®º';color:var(--content)}</style><div><details class=comments_details open><summary style="cursor:pointer;margin:50px 0 20px;width:130px"><span style=font-size:20px;color:var(--content)>...</span></summary><div id=tcomment></div></details><script src=https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js></script><script>twikoo.init({envId:"https://twikoo-e1f2-2yfafx14j-thend03s-projects.vercel.app/",el:"#tcomment",lang:"zh-CN",region:null,path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>Copyright
&copy;
2020-2024
<a href=https://blog.thend03.com/ style=color:#939393>Fayy&amp;Fc's Blog</a>
All Rights Reserved
</span><a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393></a>&nbsp;
<span><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null" style=display:inline-block;text-decoration:none;height:20px;color:#939393><img src style="float:left;margin:0 5px 0 0">
</a></span><span id=busuanzi_container><span class="fa fa-user"></span> <span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye"></span> <span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
<span id=read_progress></span>
</span></a><script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString(),s=window.getSelection().toString();t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="å¤åˆ¶";function i(){t.innerText="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerText="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>